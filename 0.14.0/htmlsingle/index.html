<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>RabbitMQ Stream Java Client</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>RabbitMQ Stream Java Client</h1>
<div class="details">
<span id="revnumber">version 0.14.0</span>
<br><span id="revremark">(6565eb4)</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#what-is-a-rabbitmq-stream">What is a RabbitMQ Stream?</a></li>
<li><a href="#when-to-use-rabbitmq-stream">When to Use RabbitMQ Stream?</a></li>
<li><a href="#other-way-to-use-streams-in-rabbitmq">Other Way to Use Streams in RabbitMQ</a></li>
<li><a href="#guarantees">Guarantees</a></li>
<li><a href="#stream-client-overview">Stream Client Overview</a></li>
<li><a href="#versioning">Versioning</a></li>
<li><a href="#stability-of-programming-interfaces">Stability of Programming Interfaces</a></li>
<li><a href="#pre-requisites">Pre-requisites</a></li>
<li><a href="#setting-up-rabbitmq">Setting up RabbitMQ</a>
<ul class="sectlevel2">
<li><a href="#with-docker">With Docker</a>
<ul class="sectlevel3">
<li><a href="#with-docker-bridge-network-driver">With Docker Bridge Network Driver</a></li>
<li><a href="#with-docker-host-network-driver">With Docker Host Network Driver</a></li>
</ul>
</li>
<li><a href="#with-a-rabbitmq-package-running-on-the-host">With a RabbitMQ Package Running on the Host</a></li>
</ul>
</li>
<li><a href="#dependencies">Dependencies</a>
<ul class="sectlevel2">
<li><a href="#maven">Maven</a></li>
<li><a href="#gradle">Gradle</a></li>
<li><a href="#snapshots">Snapshots</a></li>
</ul>
</li>
<li><a href="#sample-application">Sample Application</a></li>
<li><a href="#rabbitmq-stream-java-api">RabbitMQ Stream Java API</a>
<ul class="sectlevel2">
<li><a href="#overview">Overview</a></li>
<li><a href="#environment">Environment</a>
<ul class="sectlevel3">
<li><a href="#creating-the-environment">Creating the Environment</a></li>
<li><a href="#understanding-connection-logic">Understanding Connection Logic</a></li>
<li><a href="#enabling-tls">Enabling TLS</a></li>
<li><a href="#configuring-the-environment">Configuring the Environment</a></li>
<li><a href="#when-a-load-balancer-is-in-use">When a Load Balancer is in Use</a></li>
<li><a href="#managing-streams">Managing Streams</a></li>
</ul>
</li>
<li><a href="#producer">Producer</a>
<ul class="sectlevel3">
<li><a href="#creating-a-producer">Creating a Producer</a></li>
<li><a href="#sending-messages">Sending Messages</a></li>
<li><a href="#working-with-complex-messages">Working with Complex Messages</a></li>
<li><a href="#outbound-message-deduplication">Message Deduplication</a>
<ul class="sectlevel4">
<li><a href="#setting-the-name-of-a-producer">Setting the Name of a Producer</a></li>
<li><a href="#understanding-publishing-id">Understanding Publishing ID</a></li>
<li><a href="#restarting-a-producer-where-it-left-off">Restarting a Producer Where It Left Off</a></li>
</ul>
</li>
<li><a href="#sub-entry-batching-and-compression">Sub-Entry Batching and Compression</a></li>
</ul>
</li>
<li><a href="#consumer">Consumer</a>
<ul class="sectlevel3">
<li><a href="#creating-a-consumer">Creating a Consumer</a></li>
<li><a href="#specifying-an-offset">Specifying an Offset</a></li>
<li><a href="#consumer-offset-tracking">Tracking the Offset for a Consumer</a>
<ul class="sectlevel4">
<li><a href="#consumer-automatic-offset-tracking">Automatic Offset Tracking</a></li>
<li><a href="#consumer-manual-offset-tracking">Manual Offset Tracking</a></li>
<li><a href="#considerations-on-offset-tracking">Considerations On Offset Tracking</a></li>
<li><a href="#consumer-subscription-listener">Subscription Listener</a></li>
</ul>
</li>
<li><a href="#flow-control">Flow Control</a></li>
<li><a href="#single-active-consumer">Single Active Consumer</a>
<ul class="sectlevel4">
<li><a href="#enabling-single-active-consumer">Enabling Single Active Consumer</a></li>
<li><a href="#offset-tracking">Offset Tracking</a></li>
<li><a href="#consumer-update-listener">Reacting to Consumer State Change</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#super-streams">Super Streams (Partitioned Streams)</a>
<ul class="sectlevel3">
<li><a href="#topology">Topology</a></li>
<li><a href="#super-stream-creation">Super Stream Creation</a></li>
<li><a href="#super-stream-producer">Publishing to a Super Stream</a>
<ul class="sectlevel4">
<li><a href="#resolving-routes-with-bindings">Resolving Routes with Bindings</a></li>
<li><a href="#using-a-custom-routing-strategy">Using a Custom Routing Strategy</a></li>
<li><a href="#deduplication">Deduplication</a></li>
</ul>
</li>
<li><a href="#consuming-from-a-super-stream">Consuming From a Super Stream</a>
<ul class="sectlevel4">
<li><a href="#super-stream-consumer-in-practice">Super Stream Consumer in Practice</a></li>
<li><a href="#declaring-a-super-stream-consumer">Declaring a Super Stream Consumer</a></li>
<li><a href="#offset-tracking-2">Offset Tracking</a></li>
<li><a href="#super-stream-sac">Single Active Consumer Support</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#advanced-topics">Advanced Topics</a>
<ul class="sectlevel2">
<li><a href="#filtering">Filtering</a>
<ul class="sectlevel3">
<li><a href="#filtering-on-the-publishing-side">Filtering on the Publishing Side</a></li>
<li><a href="#filtering-on-the-consuming-side">Filtering on the Consuming Side</a></li>
<li><a href="#considerations-on-filtering">Considerations on Filtering</a></li>
</ul>
</li>
<li><a href="#using-native-epoll">Using Native <code>epoll</code></a></li>
</ul>
</li>
<li><a href="#building-the-client">Building the Client</a></li>
<li><a href="#micrometer-observation">Appendix A: Micrometer Observation</a>
<ul class="sectlevel2">
<li><a href="#observability-conventions">Observability - Conventions</a></li>
<li><a href="#observability-spans">Observability - Spans</a>
<ul class="sectlevel3">
<li><a href="#observability-spans-process-observation">Process Observation Span</a></li>
<li><a href="#observability-spans-publish-observation">Publish Observation Span</a></li>
</ul>
</li>
<li><a href="#observability-metrics">Observability - Metrics</a>
<ul class="sectlevel3">
<li><a href="#observability-metrics-process-observation">Process Observation</a></li>
<li><a href="#observability-metrics-publish-observation">Publish Observation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The RabbitMQ Stream Java Client is a Java library to communicate with
the <a href="https://rabbitmq.com/stream.html">RabbitMQ Stream Plugin</a>.
It allows creating and deleting streams, as well as publishing to and consuming from
these streams. Learn more in the <a href="#stream-client-overview">client overview</a>.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/rabbitmq/rabbitmq-stream-perf-test">Stream PerfTest</a> is a performance testing tool based on this client library.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-a-rabbitmq-stream"><a class="anchor" href="#what-is-a-rabbitmq-stream"></a>What is a RabbitMQ Stream?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A RabbitMQ stream is a persistent and replicated data structure that models
an <a href="https://en.wikipedia.org/wiki/Append-only">append-only log</a>. It differs from the classical
RabbitMQ queue in the way message consumption works. In a classical RabbitMQ queue,
consuming removes messages from the queue. In a RabbitMQ stream, consuming leaves
the stream intact. So the content of a stream can be read and re-read without
impact or destructive effect.</p>
</div>
<div class="paragraph">
<p>None of the stream or classical queue data structure is better than the other,
they are usually suited for different use cases.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="when-to-use-rabbitmq-stream"><a class="anchor" href="#when-to-use-rabbitmq-stream"></a>When to Use RabbitMQ Stream?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RabbitMQ Stream was developed to cover the following messaging use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Large fan-outs:</em> when several consumer applications need to read the same messages.</p>
</li>
<li>
<p><em>Replay / Time-traveling:</em> when consumer applications need to read the whole
history of data or from a given point in a stream.</p>
</li>
<li>
<p><em>Throughput performance:</em> when higher throughput than with other protocols
(AMQP, STOMP, MQTT) is required.</p>
</li>
<li>
<p><em>Large logs:</em> when large amount of data need to be stored, with minimal
in-memory overhead.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="other-way-to-use-streams-in-rabbitmq"><a class="anchor" href="#other-way-to-use-streams-in-rabbitmq"></a>Other Way to Use Streams in RabbitMQ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is also possible to use the stream abstraction in RabbitMQ
with the AMQP 0-9-1 protocol. Instead of consuming from a stream
with the stream protocol, one consumes from a "stream-powered" queue with
the AMQP 0-9-1 protocol. A "stream-powered" queue is a special type of queue that
is backed up with a stream infrastructure layer and adapted to
provide the stream semantics (mainly non-destructive reading).</p>
</div>
<div class="paragraph">
<p>Using such a queue has the advantage to provide the features
inherent to the stream abstraction (append-only structure, non-destructive
reading) with any AMQP 0-9-1 client library. This is clearly
interesting when considering the maturity of AMQP 0-9-1 client libraries
and the ecosystem around AMQP 0-9-1.</p>
</div>
<div class="paragraph">
<p>But by using it, one does not benefit from the performance
of the stream protocol, which has been designed for performance in mind,
whereas AMQP 0-9-1 is a more general-purpose protocol.</p>
</div>
<div class="paragraph">
<p>It is not possible to use "stream-powered" queues with the stream Java client,
you need to use an AMQP 0-9-1 client library.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="guarantees"><a class="anchor" href="#guarantees"></a>Guarantees</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RabbitMQ stream provides at-least-once guarantees thanks to the
publisher confirm mechanism, which is supported by the stream Java client.</p>
</div>
<div class="paragraph">
<p>Message <a href="#outbound-message-deduplication">deduplication</a>
is also supported on the publisher side.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stream-client-overview"><a class="anchor" href="#stream-client-overview"></a>Stream Client Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The RabbitMQ Stream Java Client implements the
<a href="https://github.com/rabbitmq/rabbitmq-server/blob/v3.12.x/deps/rabbitmq_stream/docs/PROTOCOL.adoc">RabbitMQ Stream protocol</a>
and avoids dealing with low-level concerns by providing high-level functionalities
to build fast, efficient, and robust client applications.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>administrate streams (creation/deletion) directly from applications.</em> This
can also be useful for development and testing.</p>
</li>
<li>
<p><em>adapt publishing throughput</em> thanks to the configurable batch size and flow control.</p>
</li>
<li>
<p><em>avoid publishing duplicate messages</em> thanks to message deduplication.</p>
</li>
<li>
<p><em>consume asynchronously from streams and resume where left off</em> thanks to
automatic or manual offset tracking.</p>
</li>
<li>
<p><em>enforce <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/">best practices</a> to create client connections</em> â€“ to stream leaders for publishers to minimize inter-node traffic and to stream replicas for consumers to offload leaders.</p>
</li>
<li>
<p><em>optimize resources</em> thanks to automatic growing and shrinking of
connections depending on the number of publishers and consumers.</p>
</li>
<li>
<p><em>let the client handle network failure</em> thanks to automatic connection
recovery and automatic re-subscription for consumers.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="versioning"><a class="anchor" href="#versioning"></a>Versioning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The RabbitMQ Stream Java Client is in development and stabilization phase.
When the stabilization phase ends, a 1.0.0 version will be cut, and
<a href="https://semver.org/">semantic versioning</a> is likely to be enforced.</p>
</div>
<div class="paragraph">
<p>Before reaching the stable phase, the client will use a versioning scheme of <code>[0.MINOR.PATCH]</code> where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0</code> indicates the project is still in a stabilization phase.</p>
</li>
<li>
<p><code>MINOR</code> is a 0-based number incrementing with each new release cycle. It generally reflects significant changes like new features and potentially some programming interfaces changes.</p>
</li>
<li>
<p><code>PATCH</code> is a 0-based number incrementing with each service release, that is bux fixes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Breaking changes between releases can happen but will be kept to a minimum.
The next section provides more details about the evolution of programming interfaces.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stability-of-programming-interfaces"><a class="anchor" href="#stability-of-programming-interfaces"></a>Stability of Programming Interfaces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The RabbitMQ Stream Java Client is in active development but its programming interfaces will remain as stable as possible. There is no guarantee though that they will remain completely stable, at least until it reaches version 1.0.0.</p>
</div>
<div class="paragraph">
<p>The client contains 2 sets of programming interfaces whose stability are of interest for application developers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Application Programming Interfaces (API): those are the ones used to write application logic. They include the interfaces and classes in the <code>com.rabbitmq.stream</code> package (e.g. <code>Producer</code>, <code>Consumer</code>, <code>Message</code>). These API constitute the main programming model of the client and will be kept as stable as possible.</p>
</li>
<li>
<p>Service Provider Interfaces (SPI): those are interfaces to implement mainly technical behavior in the client. They are not meant to be used to implement application logic. Application developers may have to refer to them in the configuration phase and if they want to custom some internal behavior in the client. SPI include interfaces and classes in the <code>com.rabbitmq.stream.codec</code>, <code>com.rabbitmq.stream.compression</code>, <code>com.rabbitmq.stream.metrics</code> packages, among others. <em>These SPI are susceptible to change, but this should not impact the majority of applications</em>, as the changes would typically stay intern to the client.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pre-requisites"><a class="anchor" href="#pre-requisites"></a>Pre-requisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The library requires Java 8 or later. Java 11 is recommended (CRC calculation uses methods available as of Java 9.)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-rabbitmq"><a class="anchor" href="#setting-up-rabbitmq"></a>Setting up RabbitMQ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A RabbitMQ 3.9+ node with the stream plugin enabled is required. The easiest way
to get up and running is to use Docker.</p>
</div>
<div class="sect2">
<h3 id="with-docker"><a class="anchor" href="#with-docker"></a>With Docker</h3>
<div class="paragraph">
<p>There are different ways to make the broker visible to the client application when running
in Docker. The next sections show a couple of options suitable for local development.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Docker on macOS</div>
<div class="paragraph">
<p>Docker runs on a virtual machine when using macOS, so do not expect high performance
when using RabbitMQ Stream inside Docker on a Mac.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="with-docker-bridge-network-driver"><a class="anchor" href="#with-docker-bridge-network-driver"></a>With Docker Bridge Network Driver</h4>
<div class="paragraph">
<p>This section shows how to start a broker instance for local development
(the broker Docker container and the client application are assumed to run on the
same host).</p>
</div>
<div class="paragraph">
<p>The following command creates a one-time Docker container to run RabbitMQ:</p>
</div>
<div class="listingblock">
<div class="title">Running the stream plugin with Docker</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker run -it --rm --name rabbitmq -p 5552:5552 \
    -e RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS='-rabbitmq_stream advertised_host localhost' \
    rabbitmq:3.12</code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous command exposes only the stream port (5552), you can expose
ports for other protocols:</p>
</div>
<div class="listingblock">
<div class="title">Exposing the AMQP 0.9.1 and management ports:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker run -it --rm --name rabbitmq -p 5552:5552 -p 5672:5672 -p 15672:15672 \
    -e RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS='-rabbitmq_stream advertised_host localhost' \
    rabbitmq:3.12-management</code></pre>
</div>
</div>
<div class="paragraph">
<p>Refer to the official <a href="https://hub.docker.com/_/rabbitmq">RabbitMQ Docker image web page</a>
to find out more about its usage.</p>
</div>
<div class="paragraph">
<p>Once the container is started, <strong>the stream plugin must be enabled</strong>:</p>
</div>
<div class="listingblock">
<div class="title">Enabling the stream plugin:</div>
<div class="content">
<pre>docker exec rabbitmq rabbitmq-plugins enable rabbitmq_stream</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="with-docker-host-network-driver"><a class="anchor" href="#with-docker-host-network-driver"></a>With Docker Host Network Driver</h4>
<div class="paragraph">
<p>This is the simplest way to run the broker locally.
The container uses the <a href="https://docs.docker.com/network/host/">host network</a>,
this is perfect for experimenting locally.</p>
</div>
<div class="listingblock">
<div class="title">Running RabbitMQ Stream with the host network driver</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker run -it --rm --name rabbitmq --network host rabbitmq:3.12</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the container is started, <strong>the stream plugin must be enabled</strong>:</p>
</div>
<div class="listingblock">
<div class="title">Enabling the stream plugin:</div>
<div class="content">
<pre>docker exec rabbitmq rabbitmq-plugins enable rabbitmq_stream</pre>
</div>
</div>
<div class="paragraph">
<p>The container will use the following ports: 5552 (for stream) and 5672 (for AMQP.)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Docker Host Network Driver Support</div>
<div class="paragraph">
<p>The host networking driver <strong>only works on Linux hosts</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="with-a-rabbitmq-package-running-on-the-host"><a class="anchor" href="#with-a-rabbitmq-package-running-on-the-host"></a>With a RabbitMQ Package Running on the Host</h3>
<div class="paragraph">
<p>Using a package implies installing Erlang.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure to use <a href="https://github.com/rabbitmq/rabbitmq-server/releases">RabbitMQ 3.11 or later</a>.</p>
</li>
<li>
<p>Follow the steps to
<a href="https://rabbitmq.com/download.html">install Erlang and the appropriate package</a></p>
</li>
<li>
<p>Enable the plugin <code>rabbitmq-plugins enable rabbitmq_stream</code>.</p>
</li>
<li>
<p>The stream plugin listens on port 5552.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to the <a href="https://rabbitmq.com/stream.html">stream plugin documentation</a> for more information on configuration.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dependencies"><a class="anchor" href="#dependencies"></a>Dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use your favorite build management tool to add the client dependencies to your project.</p>
</div>
<div class="sect2">
<h3 id="maven"><a class="anchor" href="#maven"></a>Maven</h3>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>

  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.rabbitmq<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>stream-client<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>0.14.0<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>

<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Snapshots require to declare the <a href="#snapshots">appropriate repository</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="gradle"><a class="anchor" href="#gradle"></a>Gradle</h3>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
  compile <span class="string"><span class="delimiter">&quot;</span><span class="content">com.rabbitmq:stream-client:0.14.0</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Snapshots require to declare the <a href="#snapshots">appropriate repository</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="snapshots"><a class="anchor" href="#snapshots"></a>Snapshots</h3>
<div class="paragraph">
<p>Releases are available from Maven Central, which does not require specific declaration.
Snapshots are available from a repositoriy which must be declared in the dependency management configuration.</p>
</div>
<div class="paragraph">
<p>With Maven:</p>
</div>
<div class="listingblock">
<div class="title">Snapshot repository declaration for Maven</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;repositories&gt;</span>

  <span class="tag">&lt;repository&gt;</span>
    <span class="tag">&lt;id&gt;</span>ossrh<span class="tag">&lt;/id&gt;</span>
    <span class="tag">&lt;url&gt;</span>https://oss.sonatype.org/content/repositories/snapshots<span class="tag">&lt;/url&gt;</span>
    <span class="tag">&lt;snapshots&gt;</span><span class="tag">&lt;enabled&gt;</span>true<span class="tag">&lt;/enabled&gt;</span><span class="tag">&lt;/snapshots&gt;</span>
    <span class="tag">&lt;releases&gt;</span><span class="tag">&lt;enabled&gt;</span>false<span class="tag">&lt;/enabled&gt;</span><span class="tag">&lt;/releases&gt;</span>
  <span class="tag">&lt;/repository&gt;</span>

<span class="tag">&lt;/repositories&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With Gradle:</p>
</div>
<div class="listingblock">
<div class="title">Snapshot repository declaration for Gradle:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">repositories {
  maven { url <span class="string"><span class="delimiter">'</span><span class="content">https://oss.sonatype.org/content/repositories/snapshots</span><span class="delimiter">'</span></span> }
  mavenCentral()
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sample-application"><a class="anchor" href="#sample-application"></a>Sample Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section covers the basics of the RabbitMQ Stream Java API by building
a small publish/consume application. This is a good way to get
an overview of the API. If you want a more comprehensive introduction,
you can go to the <a href="#rabbitmq-stream-java-api">reference documentation section</a>.</p>
</div>
<div class="paragraph">
<p>The sample application publishes some messages and then registers
a consumer to make some computations out of them. The
<a href="https://github.com/rabbitmq/rabbitmq-stream-java-client/blob/main/src/test/java/com/rabbitmq/stream/docs/SampleApplication.java">source code is available on GitHub</a>.</p>
</div>
<div class="paragraph">
<p>The sample class starts with a few imports:</p>
</div>
<div class="listingblock">
<div class="title">Imports for the sample application</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.rabbitmq.stream</span>.*;
<span class="keyword">import</span> <span class="include">java.util.UUID</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.CountDownLatch</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.TimeUnit</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.atomic.AtomicLong</span>;
<span class="keyword">import</span> <span class="include">java.util.stream.IntStream</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to create the <code>Environment</code>. It is a management object
used to manage streams and create producers as well as consumers. The
next snippet shows how to create an <code>Environment</code> instance and
create the stream used in the application:</p>
</div>
<div class="listingblock">
<div class="title">Creating the environment</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Connecting...</span><span class="delimiter">&quot;</span></span>);
Environment environment = Environment.builder().build();  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">String</span> stream = <span class="predefined-type">UUID</span>.randomUUID().toString();
environment.streamCreator().stream(stream).create();  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>Environment#builder</code> to create the environment</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create the stream</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then comes the publishing part. The next snippet shows how to create
a <code>Producer</code>, send messages, and handle publishing confirmations, to
make sure the broker has taken outbound messages into account.
The application uses a count down latch to move on once the messages
have been confirmed.</p>
</div>
<div class="listingblock">
<div class="title">Publishing messages</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Starting publishing...</span><span class="delimiter">&quot;</span></span>);
<span class="type">int</span> messageCount = <span class="integer">10000</span>;
<span class="predefined-type">CountDownLatch</span> publishConfirmLatch = <span class="keyword">new</span> <span class="predefined-type">CountDownLatch</span>(messageCount);
Producer producer = environment.producerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(stream)
        .build();
IntStream.range(<span class="integer">0</span>, messageCount)
        .forEach(i -&gt; producer.send(  <i class="conum" data-value="2"></i><b>(2)</b>
                producer.messageBuilder()                    <i class="conum" data-value="3"></i><b>(3)</b>
                    .addData(<span class="predefined-type">String</span>.valueOf(i).getBytes())   <i class="conum" data-value="3"></i><b>(3)</b>
                    .build(),                                <i class="conum" data-value="3"></i><b>(3)</b>
                confirmationStatus -&gt; publishConfirmLatch.countDown()  <i class="conum" data-value="4"></i><b>(4)</b>
        ));
publishConfirmLatch.await(<span class="integer">10</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);  <i class="conum" data-value="5"></i><b>(5)</b>
producer.close();  <i class="conum" data-value="6"></i><b>(6)</b>
<span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Published %,d messages%n</span><span class="delimiter">&quot;</span></span>, messageCount);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>Producer</code> with <code>Environment#producerBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Send messages with <code>Producer#send(Message, ConfirmationHandler)</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a message with <code>Producer#messageBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Count down on message publishing confirmation</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Wait for all publishing confirmations to have arrived</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Close the producer</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is now time to consume the messages. The <code>Environment</code> lets us create a <code>Consumer</code>
and provide some logic on each incoming message by implementing a <code>MessageHandler</code>.
The next snippet does this to calculate a sum and output it once all the messages
have been received:</p>
</div>
<div class="listingblock">
<div class="title">Consuming messages</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Starting consuming...</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">AtomicLong</span> sum = <span class="keyword">new</span> <span class="predefined-type">AtomicLong</span>(<span class="integer">0</span>);
<span class="predefined-type">CountDownLatch</span> consumeLatch = <span class="keyword">new</span> <span class="predefined-type">CountDownLatch</span>(messageCount);
Consumer consumer = environment.consumerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(stream)
        .offset(OffsetSpecification.first()) <i class="conum" data-value="2"></i><b>(2)</b>
        .messageHandler((offset, message) -&gt; {  <i class="conum" data-value="3"></i><b>(3)</b>
            sum.addAndGet(<span class="predefined-type">Long</span>.parseLong(<span class="keyword">new</span> <span class="predefined-type">String</span>(message.getBodyAsBinary())));  <i class="conum" data-value="4"></i><b>(4)</b>
            consumeLatch.countDown();  <i class="conum" data-value="5"></i><b>(5)</b>
        })
        .build();

consumeLatch.await(<span class="integer">10</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);  <i class="conum" data-value="6"></i><b>(6)</b>

<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Sum: </span><span class="delimiter">&quot;</span></span> + sum.get());  <i class="conum" data-value="7"></i><b>(7)</b>

consumer.close();  <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>Consumer</code> with <code>Environment#consumerBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start consuming from the beginning of the stream</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set up the logic to handle messages</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Add the value in the message body to the sum</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Count down on each message</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Wait for all messages to have arrived</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Output the sum</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Close the consumer</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The application has some cleaning to do before terminating, that is
deleting the stream and closing the environment:</p>
</div>
<div class="listingblock">
<div class="title">Cleaning before terminating</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.deleteStream(stream);  <i class="conum" data-value="1"></i><b>(1)</b>
environment.close();  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Delete the stream</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Close the environment</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can run the sample application from the root of the project (you need
a running local RabbitMQ node with the stream plugin enabled):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./mvnw -q test-compile exec:java -Dexec.classpathScope="test" \
    -Dexec.mainClass="com.rabbitmq.stream.docs.SampleApplication"
Starting publishing...
Published 10000 messages
Starting consuming...
Sum: 49995000</pre>
</div>
</div>
<div class="paragraph">
<p>You can remove the <code>-q</code> flag if you want more insight on the execution of the build.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rabbitmq-stream-java-api"><a class="anchor" href="#rabbitmq-stream-java-api"></a>RabbitMQ Stream Java API</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="overview"><a class="anchor" href="#overview"></a>Overview</h3>
<div class="paragraph">
<p>This section describes the API to connect to the RabbitMQ Stream Plugin, publish messages, and
consume messages. There are 3 main interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.rabbitmq.stream.Environment</code> for connecting to a node and optionally
managing streams.</p>
</li>
<li>
<p><code>com.rabbitmq.stream.Producer</code> to publish messages.</p>
</li>
<li>
<p><code>com.rabbitmq.stream.Consumer</code> to consume messages.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="environment"><a class="anchor" href="#environment"></a>Environment</h3>
<div class="sect3">
<h4 id="creating-the-environment"><a class="anchor" href="#creating-the-environment"></a>Creating the Environment</h4>
<div class="paragraph">
<p>The environment is the main entry point to a node or a cluster of nodes. <code>Producer</code> and
<code>Consumer</code> instances are created from an <code>Environment</code> instance. Here is the simplest
way to create an <code>Environment</code> instance:</p>
</div>
<div class="listingblock">
<div class="title">Creating an environment with all the defaults</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder().build();  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="comment">// ...</span>
environment.close(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create an environment that will connect to localhost:5552</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Close the environment after usage</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the environment must be closed to release resources when it is no
longer needed.</p>
</div>
<div class="paragraph">
<p>Consider the environment like a long-lived object. An application will usually
create one <code>Environment</code> instance when it starts up and close it when it exits.</p>
</div>
<div class="paragraph">
<p>It is possible to use a URI to specify all the necessary information to
connect to a node:</p>
</div>
<div class="listingblock">
<div class="title">Creating an environment with a URI</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder()
        .uri(<span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://guest:guest@localhost:5552/%2f</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>uri</code> method to specify the URI to connect to</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous snippet uses a URI that specifies the following information: host, port,
username, password, and virtual host (<code>/</code>, which is encoded as <code>%2f</code>).
The URI follows the same rules as the
<a href="https://www.rabbitmq.com/uri-spec.html">AMQP 0.9.1 URI</a>,
except the protocol must be <code>rabbitmq-stream</code>. <a href="#enabling-tls">TLS is enabled</a> by using
the <code>rabbitmq-stream+tls</code> scheme in the URI.</p>
</div>
<div class="paragraph">
<p>When using one URI, the corresponding node will be the main entry point to connect to. The
<code>Environment</code> will then use the stream protocol to find out more about streams topology
(leaders and replicas) when asked to create <code>Producer</code> and <code>Consumer</code> instances. The <code>Environment</code>
may become blind if this node goes down though, so it may be more appropriate to specify
several other URIs to try in case of failure of a node:</p>
</div>
<div class="listingblock">
<div class="title">Creating an environment with several URIs</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder()
        .uris(<span class="predefined-type">Arrays</span>.asList(                     <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://host1:5552</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://host2:5552</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://host3:5552</span><span class="delimiter">&quot;</span></span>)
        )
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>uris</code> method to specify several URIs</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By specifying several URIs, the environment will try to connect to the first one, and
will pick a new URI randomly in case of disconnection.</p>
</div>
</div>
<div class="sect3">
<h4 id="understanding-connection-logic"><a class="anchor" href="#understanding-connection-logic"></a>Understanding Connection Logic</h4>
<div class="paragraph">
<p>Creating the environment to connect to a cluster node works usually seamlessly.
Creating publishers and consumers can cause problems as the client uses hints from the cluster to find the nodes where stream leaders and replicas are located to connect to the appropriate nodes.</p>
</div>
<div class="paragraph">
<p>These connection hints can be accurate or less appropriate depending on the infrastructure.
If you hit some connection problems at some point â€“ like hostnames impossible to resolve for client applications - this <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/">blog post</a> should help you understand what is going on and fix the issues.</p>
</div>
<div class="paragraph">
<p>To make the local development experience simple, the client library can choose to always use <code>localhost</code> for producers and consumers.
This happens if the following conditions are met: the initial host to connect to is <code>localhost</code>, the user is <code>guest</code>, and no custom address resolver has been provided.
Provide a pass-through <code>AddressResolver</code> to <code>EnvironmentBuilder#addressResolver(AddressResolver)</code> to avoid this behavior.
It is unlikely this behavior applies for any real-world deployment, where <code>localhost</code> and/or the default <code>guest</code> user should not be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="enabling-tls"><a class="anchor" href="#enabling-tls"></a>Enabling TLS</h4>
<div class="paragraph">
<p>TLS can be enabled by using the <code>rabbitmq-stream+tls</code> scheme in the URI.
The default TLS port is 5551.</p>
</div>
<div class="paragraph">
<p>Use the <code>EnvironmentBuilder#tls</code> method to configure TLS.
The most important setting is a <code>io.netty.handler.ssl.SslContext</code> instance,
which is created and configured with the
<code>io.netty.handler.ssl.SslContext#forClient</code> method. Note hostname verification
is enabled by default.</p>
</div>
<div class="paragraph">
<p>The following snippet shows a common configuration, whereby
the client is instructed to trust servers with certificates
signed by the configured certificate authority (CA).</p>
</div>
<div class="listingblock">
<div class="title">Creating an environment that uses TLS</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">X509Certificate</span> certificate;
<span class="keyword">try</span> (<span class="predefined-type">FileInputStream</span> inputStream =
            <span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/ca_certificate.pem</span><span class="delimiter">&quot;</span></span>)) {
    <span class="predefined-type">CertificateFactory</span> fact = <span class="predefined-type">CertificateFactory</span>.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">X.509</span><span class="delimiter">&quot;</span></span>);
    certificate = (<span class="predefined-type">X509Certificate</span>) fact.generateCertificate(inputStream); <i class="conum" data-value="1"></i><b>(1)</b>
}
SslContext sslContext = SslContextBuilder
    .forClient()
    .trustManager(certificate)  <i class="conum" data-value="2"></i><b>(2)</b>
    .build();

Environment environment = Environment.builder()
    .uri(<span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream+tls://guest:guest@localhost:5551/%2f</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="3"></i><b>(3)</b>
    .tls().sslContext(sslContext)  <i class="conum" data-value="4"></i><b>(4)</b>
    .environmentBuilder()
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Load certificate authority (CA) certificate from PEM file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure Netty <code>SslContext</code> to trust CA certificate</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use TLS scheme in environment URI</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set <code>SslContext</code> in environment configuration</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is sometimes handy to trust any server certificates
in development environments. <code>EnvironmentBuilder#tls</code> provides the
<code>trustEverything</code> method to do so. <strong>This should
not be used in a production environment</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Creating a TLS environment that trusts all server certificates for development</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder()
    .uri(<span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream+tls://guest:guest@localhost:5551/%2f</span><span class="delimiter">&quot;</span></span>)
    .tls().trustEverything()  <i class="conum" data-value="1"></i><b>(1)</b>
    .environmentBuilder()
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Trust all server certificates</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="configuring-the-environment"><a class="anchor" href="#configuring-the-environment"></a>Configuring the Environment</h4>
<div class="paragraph">
<p>The following table sums up the main settings to create an <code>Environment</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uri</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URI of the node to connect to (single node).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rabbitmq-stream://guest:guest@localhost:5552/%2f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uris</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URI of the nodes to try to connect to (cluster).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rabbitmq-stream://guest:guest@localhost:5552/%2f</code> singleton list</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>host</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Host to connect to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>localhost</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port to use.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5552</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>username</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use to connect.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>guest</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use to connect.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>guest</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtualHost</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtual host to connect to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rpcTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout for RPC calls.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Duration.ofSeconds(10)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>recoveryBackOffDelayPolicy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delay policy to use for backoff on connection recovery.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed delay of 5 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topologyUpdateBackOffDelayPolicy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delay policy to use for backoff on topology update, e.g.
when a stream replica moves and a consumer needs to connect to another
node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initial delay of 5 seconds then delay of 1 second.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scheduledExecutorService</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executor used to schedule infrastructure tasks like background publishing, producers
and consumers migration after disconnection or topology update. If a custom executor is provided,
it is the developer&#8217;s responsibility to close it once it is no longer necessary.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Executors</span>
  .newScheduledThreadPool(
    <span class="predefined-type">Runtime</span>
      .getRuntime()
      .availableProcessors()
);</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxProducersByConnection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of <code>Producer</code> instances a single connection can maintain before
a new connection is open. The value must be between 1 and 255.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">255</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxTrackingConsumersByConnection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of <code>Consumer</code> instances that store their offset a single connection
can maintain before a new connection is open. The value must be between 1 and 255.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxConsumersByConnection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of <code>Consumer</code> instances a single connection can maintain before
a new connection is open. The value must be between 1 and 255.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">255</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lazyInitialization</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To delay the connection opening until necessary.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>requestedHeartbeat</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heartbeat requested by the client.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>forceReplicaForConsumers</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retry connecting until a replica is available for consumers.
The client retries 5 times before falling back to the stream leader node.
Set to <code>true</code> only for clustered environments, not for 1-node environments, where only the stream leader is available.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Informational ID for the environment instance.
Used as a prefix for connection names.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rabbitmq-stream</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>addressResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract to change resolved node address to connect to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass-through (no-op)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tls</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration helper for TLS.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TLS is enabled if a <code>rabbitmq-stream+tls</code> URI is provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tls#hostnameVerification</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable or disable hostname verification.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enabled by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tls#sslContext</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the <code>io.netty.handler.ssl.SslContext</code> used for the TLS connection.
Use <code>io.netty.handler.ssl.SslContextBuilder#forClient</code> to configure it.
The server certificate chain and the client private key are the typical
elements that need to be configured.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The JDK trust manager and no client private key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tls#trustEverything</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Helper to configure a <code>SslContext</code> that trusts all server certificates
and does not use a client private key. <strong>Only for development</strong>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disabled by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>netty</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration helper for Netty.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>netty#eventLoopGroup</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Netty&#8217;s event dispatcher.
It is the developer&#8217;s responsibility to close the <code>EventLoopGroup</code> they provide.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NioEventLoopGroup</code> instance closed automatically with the <code>Environment</code> instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>netty#ByteBufAllocator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ByteBuf</code> allocator.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ByteBufAllocator.DEFAULT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>netty#channelCustomizer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extension point to customize Netty&#8217;s <code>Channel</code> instances used for connections.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>netty#bootstrapCustomizer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extension point to customize Netty&#8217;s <code>Bootstrap</code> instances used to configure connections.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="when-a-load-balancer-is-in-use"><a class="anchor" href="#when-a-load-balancer-is-in-use"></a>When a Load Balancer is in Use</h4>
<div class="paragraph">
<p>A load balancer can misguide the client when it tries to connect to nodes that host stream leaders and replicas.
The <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/">"Connecting to Streams"</a> blog post covers why client applications must connect to the appropriate nodes in a cluster and how a <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/#with-a-load-balancer">load balancer can make things complicated</a> for them.</p>
</div>
<div class="paragraph">
<p>The <code>EnvironmentBuilder#addressResolver(AddressResolver)</code> method allows intercepting the node resolution after metadata hints and before connection.
Applications can use this hook to ignore metadata hints and always use the load balancer, as illustrated in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Using a custom address resolver to always use a load balancer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Address entryPoint = <span class="keyword">new</span> Address(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-load-balancer</span><span class="delimiter">&quot;</span></span>, <span class="integer">5552</span>);  <i class="conum" data-value="1"></i><b>(1)</b>
Environment environment = Environment.builder()
    .host(entryPoint.host())  <i class="conum" data-value="2"></i><b>(2)</b>
    .port(entryPoint.port())  <i class="conum" data-value="2"></i><b>(2)</b>
    .addressResolver(address -&gt; entryPoint)  <i class="conum" data-value="3"></i><b>(3)</b>
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the load balancer address</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use load balancer address for initial connection</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ignore metadata hints, always use load balancer</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The blog post covers the <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/#client-workaround-with-a-load-balancer">underlying details of this workaround</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="managing-streams"><a class="anchor" href="#managing-streams"></a>Managing Streams</h4>
<div class="paragraph">
<p>Streams are usually long-lived, centrally-managed entities, that is, applications
are not supposed to create and delete them. It is nevertheless possible to create and
delete stream with the <code>Environment</code>. This comes in handy for development and testing
purposes.</p>
</div>
<div class="paragraph">
<p>Streams are created with the <code>Environment#streamCreator()</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Creating a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.streamCreator().stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>).create();  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>my-stream</code> stream</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>StreamCreator#create</code> is idempotent: trying to re-create a stream with the same name
and same properties (e.g. maximum size, see below) will not throw an exception. In other words,
you can be sure the stream has been created once <code>StreamCreator#create</code> returns. Note it is
not possible to create a stream with the same name as an existing stream but with different
properties. Such a request will result in an exception.</p>
</div>
<div class="paragraph">
<p>Streams can be deleted with the <code>Environment#delete(String)</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Deleting a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.deleteStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>);  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Delete the <code>my-stream</code> stream</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note you should avoid stream churn (creating and deleting streams repetitively)
as their creation and deletion imply some significant housekeeping on
the server side (interactions with the file system, communication between nodes of the cluster).</p>
</div>
<div class="paragraph">
<p><a id="limiting-the-size-of-a-stream"></a>It is also possible to limit the size of a stream
when creating it. A stream
is an append-only data structure and reading from it does not remove data.
This means a stream can grow indefinitely. RabbitMQ Stream supports a
size-based and time-based retention policies: once the stream reaches a given size
or a given age, it is truncated (starting from the beginning).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Limit the size of streams if appropriate!</div>
<div class="paragraph">
<p>Make sure to set up a retention policy on potentially large streams
if you don&#8217;t want to saturate the storage devices of your servers. Keep
in mind that this means some data will be erased!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to set up the retention policy when creating the stream:</p>
</div>
<div class="listingblock">
<div class="title">Setting the retention policy when creating a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.streamCreator()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .maxLengthBytes(ByteCapacity.GB(<span class="integer">10</span>))  <i class="conum" data-value="1"></i><b>(1)</b>
        .maxSegmentSizeBytes(ByteCapacity.MB(<span class="integer">500</span>))  <i class="conum" data-value="2"></i><b>(2)</b>
        .create();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the maximum size to 10 GB</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the segment size to 500 MB</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous snippet mentions a segment size. RabbitMQ Stream does not store a stream
in a big, single file, it uses segment files for technical reasons.
A stream is truncated by deleting whole segment files (and not part of them)so
the maximum size of a stream is usually significantly higher than the size of
segment files. 500 MB is a reasonable segment file size to begin with.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">When does the broker enforce the retention policy?</div>
<div class="paragraph">
<p>The broker enforces the retention policy when the segments of a stream
roll over, that is when the current segment has reached its maximum
size and is closed in favor of a new one. This means the maximum segment
size is a critical setting in the retention mechanism.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>RabbitMQ Stream also supports a time-based retention policy: segments get truncated
when they reach a certain age. The following snippet
illustrates how to set the time-based retention policy:</p>
</div>
<div class="listingblock">
<div class="title">Setting a time-based retention policy when creating a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.streamCreator()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .maxAge(<span class="predefined-type">Duration</span>.ofHours(<span class="integer">6</span>))  <i class="conum" data-value="1"></i><b>(1)</b>
        .maxSegmentSizeBytes(ByteCapacity.MB(<span class="integer">500</span>))  <i class="conum" data-value="2"></i><b>(2)</b>
        .create();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the maximum age to 6 hours</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the segment size to 500 MB</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="producer"><a class="anchor" href="#producer"></a>Producer</h3>
<div class="sect3">
<h4 id="creating-a-producer"><a class="anchor" href="#creating-a-producer"></a>Creating a Producer</h4>
<div class="paragraph">
<p>A <code>Producer</code> instance is created from the <code>Environment</code>. The only mandatory
setting to specify is the stream to publish to:</p>
</div>
<div class="listingblock">
<div class="title">Creating a producer from the environment</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
        .build();  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="comment">// ...</span>
producer.close();  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>Environment#producerBuilder()</code> to define the producer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specify the stream to publish to</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the producer instance with <code>build()</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Close the producer after usage</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider a <code>Producer</code> instance like a long-lived object, do not create one
to send just one message.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Producer thread safety</div>
<div class="paragraph">
<p>Producer instances are thread-safe.
<a href="#outbound-message-deduplication">Deduplication</a> imposes <a href="#deduplication-multithreading">restrictions on the usage of threads</a> though.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Internally, the <code>Environment</code> will query the broker to find out about
the topology of the stream and will create or re-use a connection to
publish to the leader node of the stream.</p>
</div>
<div class="paragraph">
<p>The following table sums up the main settings to create a <code>Producer</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The stream to publish to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default, mandatory setting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The logical name of the producer. Specify a name to enable
<a href="#outbound-message-deduplication">message deduplication</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code> (no deduplication)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>batchSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of messages to accumulate before sending them to the broker.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>subEntrySize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="producer-sub-entry-size-configuration-entry"></a>The number of messages to put in a sub-entry.
A sub-entry is one "slot" in a publishing
frame, meaning outbound messages are not only batched in publishing frames, but in sub-entries
as well.
Use this feature to increase throughput at the cost of increased latency and
potential duplicated messages even when deduplication is enabled.
See the <a href="#sub-entry-batching-and-compression">dedicated section</a> for more information.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 (meaning no use of sub-entry batching)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>compression</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compression algorithm to use when sub-entry batching is in use.
See the <a href="#sub-entry-batching-and-compression">dedicated section</a> for more information.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compression.NONE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxUnconfirmedMessages</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of unconfirmed outbound messages. <code>Producer#send</code> will start
blocking when the limit is reached.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10,000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>batchPublishingDelay</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Period to send a batch of messages.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 ms</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>confirmTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="producer-confirm-timeout-configuration-entry"></a>Time before the client calls the confirm callback to signal
outstanding unconfirmed messages timed out.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enqueueTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time before enqueueing of a message fail when the maximum number of unconfirmed
is reached. The callback of the message will be called with a negative status.
Set the value to <code>Duration.ZERO</code> if there should be no timeout.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 seconds.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="sending-messages"><a class="anchor" href="#sending-messages"></a>Sending Messages</h4>
<div class="paragraph">
<p>Once a <code>Producer</code> has been created, it is possible to send a message with
the <code>Producer#send(Message, ConfirmationHandler)</code> method. The following
snippet shows how to publish a message with a byte array payload:</p>
</div>
<div class="listingblock">
<div class="title">Sending a message</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">byte</span><span class="type">[]</span> messagePayload = <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>.getBytes(StandardCharsets.UTF_8);  <i class="conum" data-value="1"></i><b>(1)</b>
producer.send(
        producer.messageBuilder().addData(messagePayload).build(),  <i class="conum" data-value="2"></i><b>(2)</b>
        confirmationStatus -&gt; {  <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="keyword">if</span> (confirmationStatus.isConfirmed()) {
                <span class="comment">// the message made it to the broker</span>
            } <span class="keyword">else</span> {
                <span class="comment">// the message did not make it to the broker</span>
            }
        });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The payload of a message is an array of bytes</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create the message with <code>Producer#messageBuilder()</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the behavior on publish confirmation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Messages are not only made of a <code>byte[]</code> payload, we will see in
<a href="#working-with-complex-messages">the next section</a>
they can also carry pre-defined and application properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Use a <code>MessageBuilder</code> instance only once</div>
<div class="paragraph">
<p>A <code>MessageBuilder</code> instance is meant to create only one message. You
need to create a new instance of <code>MessageBuilder</code> for every message
you want to create.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>ConfirmationHandler</code> defines an asynchronous callback invoked
when the client received from the broker the confirmation the message
has been taken into account. The <code>ConfirmationHandler</code> is the place
for any logic on publishing confirmation, including
re-publishing the message if it is negatively acknowledged.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Keep the confirmation callback as short as possible</div>
<div class="paragraph">
<p>The confirmation callback should be kept as short as possible
to avoid blocking the connection thread. Not doing so can
make the <code>Environment</code>, <code>Producer</code>, <code>Consumer</code> instances sluggish
or even block them. Any long processing should be done in
a separate thread (e.g. with an asynchronous <code>ExecutorService</code>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="working-with-complex-messages"><a class="anchor" href="#working-with-complex-messages"></a>Working with Complex Messages</h4>
<div class="paragraph">
<p>The publishing example above showed that messages are made of
a byte array payload, but it did not go much further. Messages in RabbitMQ Stream
can actually be more sophisticated, as they comply to the
<a href="https://www.amqp.org/resources/specifications">AMQP 1.0 message format</a>.</p>
</div>
<div class="paragraph">
<p>In a nutshell, a message in RabbitMQ Stream has the following structure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>properties: <em>a defined set of standard properties of the message</em> (e.g.
message ID, correlation ID, content type, etc).</p>
</li>
<li>
<p>application properties: a set of arbitrary key/value pairs.</p>
</li>
<li>
<p>body: typically an array of bytes.</p>
</li>
<li>
<p>message annotations: a set of key/value pairs (aimed at the infrastructure).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The RabbitMQ Stream Java client uses the <code>Message</code> interface to abstract
a message and the recommended way to create <code>Message</code> instances is to
use the <code>Producer#messageBuilder()</code> method. To publish a <code>Message</code>, use
the <code>Producer#send(Message,ConfirmationHandler)</code>:</p>
</div>
<div class="listingblock">
<div class="title">Creating a message with properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Message message = producer.messageBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .properties()  <i class="conum" data-value="2"></i><b>(2)</b>
            .messageId(<span class="predefined-type">UUID</span>.randomUUID())
            .correlationId(<span class="predefined-type">UUID</span>.randomUUID())
            .contentType(<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>)
        .messageBuilder()  <i class="conum" data-value="3"></i><b>(3)</b>
            .addData(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>.getBytes(StandardCharsets.UTF_8))  <i class="conum" data-value="4"></i><b>(4)</b>
        .build();  <i class="conum" data-value="5"></i><b>(5)</b>
producer.send(message, confirmationStatus -&gt; { }); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the message builder from the producer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the properties builder and set some properties</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Go back to message builder</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set byte array payload</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Build the message instance</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Publish the message</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Is RabbitMQ Stream based on AMQP 1.0?</div>
<div class="paragraph">
<p>AMQP 1.0 is a standard that defines <em>an efficient binary peer-to-peer
protocol for transporting messages between two processes over a network</em>.
It also defines <em>an abstract message format, with concrete standard encoding</em>.
This is only the latter part that RabbitMQ Stream uses. The AMQP 1.0 protocol is not used,
only AMQP 1.0 encoded messages are wrapped into the RabbitMQ Stream binary protocol.</p>
</div>
<div class="paragraph">
<p>The actual AMQP 1.0 message encoding and decoding happen on the client side, the
RabbitMQ Stream plugin stores only bytes, it has no idea that AMQP 1.0 message format
is used.</p>
</div>
<div class="paragraph">
<p>AMQP 1.0 message format was chosen because of its flexibility and its advanced
type system. It provides good interoperability, which allows streams
to be accessed as AMQP 0-9-1 queues, without data loss.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="outbound-message-deduplication"><a class="anchor" href="#outbound-message-deduplication"></a>Message Deduplication</h4>
<div class="paragraph">
<p>RabbitMQ Stream provides publisher confirms to avoid losing messages: once
the broker has persisted a message it sends a confirmation for this message.
But this can lead to duplicate messages: imagine the connection closes
because of a network glitch after the message has been persisted but <em>before</em>
the confirmation reaches the producer. Once reconnected, the producer will
retry to send the same message, as it never received the confirmation. So the
message will be persisted twice.</p>
</div>
<div class="paragraph">
<p>Luckily RabbitMQ Stream can detect and filter out duplicated messages, based
on 2 client-side elements: the <em>producer name</em> and the <em>message publishing ID</em>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Deduplication is not guaranteed when using sub-entries batching</div>
<div class="paragraph">
<p>It is not possible to guarantee deduplication when
<a href="#sub-entry-batching-and-compression">sub-entry batching</a> is in use.
Sub-entry batching is disabled by default and it does not prevent from
batching messages in a single publish frame, which can already provide
very high throughput.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="deduplication-multithreading" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Deduplication is not guaranteed when publishing on several threads</div>
<div class="paragraph">
<p>We&#8217;ll see below that deduplication works using a strictly increasing sequence for messages.
This means messages must be published in order and the preferred way to do this is usually <em>within a single thread</em>.
Even if messages are <em>created</em> in order, with the proper sequence ID, if they are published in several threads, they can get out of order, e.g. message 5 can be <em>published</em> before message 2.
The deduplication mechanism will then filter out message 2 in this case.</p>
</div>
<div class="paragraph">
<p>So you have to be very careful about the way your applications publish messages when deduplication is in use.
If you worry about performance, note it is possible to publish hundreds of thousands of messages in a single thread with RabbitMQ Stream.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="setting-the-name-of-a-producer"><a class="anchor" href="#setting-the-name-of-a-producer"></a>Setting the Name of a Producer</h5>
<div class="paragraph">
<p>The producer name is set when creating the producer instance, which automatically
enables deduplication:</p>
</div>
<div class="listingblock">
<div class="title">Naming a producer to enable message deduplication</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-app-producer</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .confirmTimeout(<span class="predefined-type">Duration</span>.ZERO)  <i class="conum" data-value="2"></i><b>(2)</b>
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set a name for the producer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Disable confirm timeout check</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Thanks to the name, the broker will be able to track the messages it has persisted
on a given stream for this producer. If the producer connection unexpectedly closes, it
will automatically recover and retry outstanding messages. The broker will then
filter out messages it has already received and persisted. No more duplicates!</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Why setting <code>confirmTimeout</code> to 0 when using deduplication?</div>
<div class="paragraph">
<p>The point of deduplication is to avoid duplicates when retrying unconfirmed messages.
But why retrying in the first place? To avoid <em>losing</em> messages, that is enforcing
<em>at-least-once</em> semantics. If the client does not stubbornly retry messages and gives
up at some point, messages can be lost, which maps to <em>at-most-once</em> semantics. This
is why the deduplication examples set the
<a href="#producer-confirm-timeout-configuration-entry"><code>confirmTimeout</code> setting</a> to <code>Duration.ZERO</code>:
to disable the background task that calls the confirmation callback for outstanding
messages that time out. This way the client will do its best to retry messages
until they are confirmed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A producer name must be stable and clear to a human reader. It must not be a random sequence that
changes when the producer application is restarted. Names like <code>online-shop-order</code> or
<code>online-shop-invoice</code> are better names than <code>3d235e79-047a-46a6-8c80-9d159d3e1b05</code>.
There should be only one living instance of a producer with a given name on a given
stream at the same time.</p>
</div>
</div>
<div class="sect4">
<h5 id="understanding-publishing-id"><a class="anchor" href="#understanding-publishing-id"></a>Understanding Publishing ID</h5>
<div class="paragraph">
<p>The producer name is only one part of the deduplication mechanism, the other part
is the <em>message publishing ID</em>. If the producer has a name, the client automatically
assigns a publishing ID to each outbound message for the producer. The publishing ID
is a strictly increasing sequence, starting at 0 and incremented for each message. The default
publishing sequence is good enough for deduplication, but it is possible to
assign a publishing ID to each message:</p>
</div>
<div class="listingblock">
<div class="title">Using an explicit publishing ID</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Message message = producer.messageBuilder()
    .publishingId(<span class="integer">1</span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .addData(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>.getBytes(StandardCharsets.UTF_8))
    .build();
producer.send(message, confirmationStatus -&gt; { });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set a publishing ID on a message</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are a few rules to follow when using a custom publishing ID sequence:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the sequence must be strictly increasing</p>
</li>
<li>
<p>there can be gaps in the sequence (e.g. 0, 1, 2, 3, 6, 7, 9, 10, etc)</p>
</li>
<li>
<p>the sequence does not have to start at 0, as long as it is increasing</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A custom publishing ID sequence has usually a meaning: it can be the line number of a file
or the primary key in a database.</p>
</div>
<div class="paragraph">
<p>Note the publishing ID is not part of the message: it is not stored with the message
and so is not available when consuming the message. It is still possible to store
the value in the AMQP 1.0 message application properties or in an appropriate
properties (e.g. <code>messageId</code>).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Do not mix client-assigned and custom publishing ID</div>
<div class="paragraph">
<p>As soon as a producer name is set, message deduplication is enabled.
It is then possible to let the producer assign a publishing ID to each
message or assign custom publishing IDs. <strong>Do one or the other, not both!</strong></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="restarting-a-producer-where-it-left-off"><a class="anchor" href="#restarting-a-producer-where-it-left-off"></a>Restarting a Producer Where It Left Off</h5>
<div class="paragraph">
<p>Using a custom publishing sequence is even more useful to restart a producer where it left
off. Imagine a scenario whereby the producer is sending a message for each line in a file and
the application uses the line number as the publishing ID. If the application restarts
because of some necessary maintenance or even a crash, the producer can restart
from the beginning of the file: there would no duplicate messages because the producer
has a name and the application sets publishing IDs appropriately. Nevertheless,
this is far from ideal, it would be much better to restart just after the last line
the broker successfully confirmed. Fortunately this is possible thanks to
the <code>Producer#getLastPublishing()</code> method, which returns the last publishing ID for a given
producer. As the publishing ID in this case is the line number, the application can
easily scroll to the next line and restart publishing from there.</p>
</div>
<div class="paragraph">
<p>The next snippet illustrates the use of <code>Producer#getLastPublishing()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Setting a producer where it left off</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-app-producer</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .confirmTimeout(<span class="predefined-type">Duration</span>.ZERO)  <i class="conum" data-value="2"></i><b>(2)</b>
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .build();
<span class="type">long</span> nextPublishingId = producer.getLastPublishingId() + <span class="integer">1</span>;  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="keyword">while</span> (moreContent(nextPublishingId)) {
    <span class="type">byte</span><span class="type">[]</span> content = getContent(nextPublishingId); <i class="conum" data-value="4"></i><b>(4)</b>
    Message message = producer.messageBuilder()
        .publishingId(nextPublishingId) <i class="conum" data-value="5"></i><b>(5)</b>
        .addData(content)
        .build();
    producer.send(message, confirmationStatus -&gt; {});
    nextPublishingId++;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set a name for the producer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Disable confirm timeout check</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Query last publishing ID for this producer and increment it</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Scroll to the content for the next publishing ID</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the message publishing</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sub-entry-batching-and-compression"><a class="anchor" href="#sub-entry-batching-and-compression"></a>Sub-Entry Batching and Compression</h4>
<div class="paragraph">
<p>RabbitMQ Stream provides a special mode to publish, store, and dispatch messages: sub-entry batching.
This mode increases throughput at the cost of increased latency and potential duplicated messages even when deduplication is enabled.
It also allows using compression to reduce bandwidth and storage if messages are reasonably similar, at the cost of increasing CPU usage on the client side.</p>
</div>
<div class="paragraph">
<p>Sub-entry batching consists in squeezing several messages â€“ a batch â€“ in the slot that is usually used for one message.
This means outbound messages are not only batched in publishing frames, but in sub-entries as well.</p>
</div>
<div class="paragraph">
<p>You can enable sub-entry batching by setting the <code>ProducerBuilder#subEntrySize</code> parameter to a value greater than 1, like in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Enabling sub-entry batching</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .batchSize(<span class="integer">100</span>) <i class="conum" data-value="1"></i><b>(1)</b>
    .subEntrySize(<span class="integer">10</span>) <i class="conum" data-value="2"></i><b>(2)</b>
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set batch size to 100 (the default)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set sub-entry size to 10</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Reasonable values for the sub-entry size usually go from 10 to a few dozens.</p>
</div>
<div class="paragraph">
<p>A sub-entry batch will go directly to disc after it reached the broker, so the publishing client has complete control over it.
This is the occasion to take advantage of the similarity of messages and compress them.
There is no compression by default but you can choose among several algorithms with the <code>ProducerBuilder#compression(Compression)</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Enabling compression of sub-entry messages</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .batchSize(<span class="integer">100</span>) <i class="conum" data-value="1"></i><b>(1)</b>
    .subEntrySize(<span class="integer">10</span>) <i class="conum" data-value="2"></i><b>(2)</b>
    .compression(<span class="predefined-type">Compression</span>.ZSTD) <i class="conum" data-value="3"></i><b>(3)</b>
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set batch size to 100 (the default)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set sub-entry size to 10</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the Zstandard compression algorithm</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the messages in a sub-entry are compressed altogether to benefit from their potential similarity, not one by one.</p>
</div>
<div class="paragraph">
<p>The following table lists the supported algorithms, general information about them, and the respective implementations used by default.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Algorithm</th>
<th class="tableblock halign-left valign-top">Overview</th>
<th class="tableblock halign-left valign-top">Implementation used</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.wikipedia.org/wiki/Gzip">gzip</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Has a high compression ratio but is slow compared to other algorithms.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDK implementation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.wikipedia.org/wiki/Snappy_(compression)">Snappy</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aims for reasonable compression ratio and very high speeds.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/xerial/snappy-java">Xerial Snappy</a> (framed)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.wikipedia.org/wiki/LZ4_(compression_algorithm)">LZ4</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aims for good trade-off between speed and compression ratio.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/lz4/lz4-java">LZ4 Java</a> (framed)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.wikipedia.org/wiki/Zstd">zstd</a> (Zstandard)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aims for high compression ratio and high speed, especially for decompression.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/luben/zstd-jni">zstd-jni</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You are encouraged to test and evaluate the compression algorithms depending on your needs.</p>
</div>
<div class="paragraph">
<p>The compression libraries are pluggable thanks to the <code>EnvironmentBuilder#compressionCodecFactory(CompressionCodecFactory)</code> method.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Consumers, sub-entry batching, and compression</div>
<div class="paragraph">
<p>There is no configuration required for consumers with regard to sub-entry batching and compression.
The broker dispatches messages to client libraries: they are supposed to figure out the format of messages, extract them from their sub-entry, and decompress them if necessary.
So when you set up sub-entry batching and compression in your publishers, the consuming applications must use client libraries that support this mode, which is the case for the stream Java client.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="consumer"><a class="anchor" href="#consumer"></a>Consumer</h3>
<div class="paragraph">
<p><code>Consumer</code> is the API to consume messages from a stream.</p>
</div>
<div class="sect3">
<h4 id="creating-a-consumer"><a class="anchor" href="#creating-a-consumer"></a>Creating a Consumer</h4>
<div class="paragraph">
<p>A <code>Consumer</code> instance is created with <code>Environment#consumerBuilder()</code>. The main
settings are the stream to consume from, the place in the stream to start
consuming from (the <em>offset</em>), and a callback when a message is received
(the <code>MessageHandler</code>). The next snippet shows how to create a <code>Consumer</code>:</p>
</div>
<div class="listingblock">
<div class="title">Creating a consumer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
        .offset(OffsetSpecification.first())  <i class="conum" data-value="3"></i><b>(3)</b>
        .messageHandler((offset, message) -&gt; {
            message.getBodyAsBinary(); <i class="conum" data-value="4"></i><b>(4)</b>
        })
        .build();  <i class="conum" data-value="5"></i><b>(5)</b>
<span class="comment">// ...</span>
consumer.close();  <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>Environment#consumerBuilder()</code> to define the consumer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specify the stream to consume from</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify where to start consuming from</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define behavior on message consumption</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Build the consumer</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Close consumer after usage</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The broker start sending messages as soon as the <code>Consumer</code> instance is created.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">The message processing callback can take its time, but not too much</div>
<div class="paragraph">
<p>The message processing callback should not take too long or it could impact other consumers sharing the same connection.
The <a href="#configuring-the-environment"><code>EnvironmentBuilder#maxConsumersByConnection(int)</a></code> method allows isolating consumers from each other, at the cost of creating and maintaining more connections.
Consider using a separate thread for long processing (e.g. with an asynchronous <code>ExecutorService</code>).
Note message processing callbacks run in a dedicated thread, they do not impact other network frames, which run in their own thread.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following table sums up the main settings to create a <code>Consumer</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The stream to consume from.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default, mandatory setting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>offset</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The offset to start consuming from.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OffsetSpecification#next()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messageHandler</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The callback for inbound messages.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default, mandatory setting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The consumer name (for <a href="#consumer-offset-tracking">offset tracking</a>.)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code> (no offset tracking)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AutoTrackingStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable and configure the <a href="#consumer-automatic-offset-tracking">auto-tracking strategy</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the default tracking strategy if a consumer <code>name</code> is provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AutoTrackingStrategy#messageCountBeforeStorage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of messages before storing.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10,000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AutoTrackingStrategy#flushInterval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval to check and store the last received offset in case of inactivity.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Duration.ofSeconds(5)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ManualTrackingStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable and configure the <a href="#consumer-manual-offset-tracking">manual tracking strategy</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disabled by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ManualTrackingStrategy#checkInterval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval to check if the last requested stored offset has been actually stored.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Duration.ofSeconds(5)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">noTrackingStrategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disable server-side offset tracking even if a name is provided.
Useful when <a href="#single-active-consumer">single active consumer</a> is enabled and an external store is used for offset tracking.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">subscriptionListener</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <a href="#consumer-subscription-listener">callback</a> before the subscription is created.
Useful when using an external store for offset tracking.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>flow</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration helper for flow control.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>flow#initialCredits</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of credits when the subscription is created.
Increase for higher throughput at the expense of memory usage.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>flow#strategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>ConsumerFlowStrategy</code> to use.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ConsumerFlowStrategy#creditOnChunkArrival(1)</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Why is my consumer not consuming?</div>
<div class="paragraph">
<p>A consumer starts consuming at the very end of a stream by default (<code>next</code> offset).
This means the consumer will receive messages as soon as a producer publishes to the stream.
<em>This also means that if no producers are currently publishing to the stream, the
consumer will stay idle, waiting for new messages to come in</em>. Use the
<code>ConsumerBuilder#offset(OffsetSpecification)</code> to change the default behavior and
see the <a href="#specifying-an-offset">offset section</a> to find out more about the different
types of offset specification.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="specifying-an-offset"><a class="anchor" href="#specifying-an-offset"></a>Specifying an Offset</h4>
<div class="paragraph">
<p>The offset is the place in the stream where the consumer starts consuming from.
The possible values for the offset parameter are the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>OffsetSpecification.first()</code>: starting from the first available offset. If
the stream has not been <a href="#limiting-the-size-of-a-stream">truncated</a>, this
means the beginning of the stream (offset 0).</p>
</li>
<li>
<p><code>OffsetSpecification.last()</code>: starting from the end of the stream and returning
the last <a href="#chunk-definition">chunk</a> of messages immediately (if the stream is not empty).</p>
</li>
<li>
<p><code>OffsetSpecification.next()</code>: starting from the next offset to be written. Contrary
to <code>OffsetSpecification.last()</code>, consuming with <code>OffsetSpecification.next()</code>
will not return anything if no-one is publishing to the stream. The broker will start
sending messages to the consumer when messages are published to the stream.</p>
</li>
<li>
<p><code>OffsetSpecification.offset(offset)</code>: starting from the specified offset. 0 means consuming
from the beginning of the stream (first messages). The client
can also specify any number, for example the offset where it left off
in a previous incarnation of the application.</p>
</li>
<li>
<p><code>OffsetSpecification.timestamp(timestamp)</code>: starting from the messages stored
after the specified timestamp.
Note consumers can receive messages published a bit before the specified timestamp.
Application code can filter out those messages if necessary.</p>
</li>
</ul>
</div>
<div id="chunk-definition" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">What is a chunk of messages?</div>
<div class="paragraph">
<p>A chunk is simply a batch of messages. This is the storage and transportation
unit used in RabbitMQ Stream, that is messages are stored contiguously in a chunk
and they are delivered as part of a chunk. A chunk can be made of one to several
thousands of messages, depending on the ingress.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following figure shows the different offset specifications in a stream
made of 2 chunks:</p>
</div>
<div class="listingblock">
<div class="title">Offset specifications in a stream made of 2 chunks</div>
<div class="content">
<pre>Failed to generate image: cannot link Java class org.asciidoctor.diagram.CommandProcessor org/asciidoctor/diagram/CommandProcessor has been compiled by a more recent version of the Java Runtime (class file version 55.0), this version of the Java Runtime only recognizes class file versions up to 52.0
   +------------------------------------------+ +-------------------------+
   |  +-----+ +-----+ +-----+ +-----+ +-----+ | | +-----+ +-----+ +-----+ |
   |  |  0  | |  1  | |  2  | |  3  | |  4  | | | |  5  | |  6  | |  7  | |
   |  +-----+ +-----+ +-----+ +-----+ +-----+ | | +-----+ +-----+ +-----+ |
   +------------------------------------------+ +-------------------------+
         ^            Chunk 1    ^                   ^    Chunk 2            ^
         |                       |                   |                       |
       FIRST                  OFFSET 3              LAST                    NEXT</pre>
</div>
</div>
<div class="paragraph">
<p>Each chunk contains a timestamp of its creation time.
This is this timestamp the broker uses to find the appropriate chunk to start from when using a timestamp specification.
The broker chooses the closest chunk <em>before</em> the specified timestamp, that is why consumers may see messages published a bit before what they specified.</p>
</div>
</div>
<div class="sect3">
<h4 id="consumer-offset-tracking"><a class="anchor" href="#consumer-offset-tracking"></a>Tracking the Offset for a Consumer</h4>
<div class="paragraph">
<p>RabbitMQ Stream provides server-side offset tracking.
This means a consumer can track the offset it has reached in a stream.
It allows a new incarnation of the consumer to restart consuming where it left off.
All of this without an extra datastore, as the broker stores the offset tracking information.</p>
</div>
<div class="paragraph">
<p>Offset tracking works in 2 steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the consumer must have a <strong>name</strong>. The name is set with <code>ConsumerBuilder#name(String)</code>. The name
can be any value (under 256 characters) and is expected to be unique (from the application
point of view). Note neither the client library, nor the broker
enforces uniqueness of the name: if 2 <code>Consumer</code> Java instances share the same name, their
offset tracking will likely be interleaved, which applications usually do not expect.</p>
</li>
<li>
<p>the consumer must periodically <strong>store the offset</strong> it has reached so far. The way
offsets are stored depends on the tracking strategy: automatic or manual.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Whatever tracking strategy you use, <strong>a consumer must have a name to be able to store offsets</strong>.</p>
</div>
<div class="sect4">
<h5 id="consumer-automatic-offset-tracking"><a class="anchor" href="#consumer-automatic-offset-tracking"></a>Automatic Offset Tracking</h5>
<div class="paragraph">
<p>The following snippet shows how to enable automatic tracking with the defaults:</p>
</div>
<div class="listingblock">
<div class="title">Using automatic tracking strategy with the defaults</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .autoTrackingStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use automatic tracking strategy with defaults</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The automatic tracking strategy has the following available settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>message count before storage</strong>: the client will store the offset
after the specified number of messages, right after the execution
of the message handler. <em>The default is every 10,000 messages</em>.</p>
</li>
<li>
<p><strong>flush interval</strong>: the client will make sure to store the last received offset
at the specified interval. This avoids having pending, not stored offsets in
case of inactivity. <em>The default is 5 seconds</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those settings are configurable, as shown in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Configuring the automatic tracking strategy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .autoTrackingStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
            .messageCountBeforeStorage(<span class="integer">50</span>_000)   <i class="conum" data-value="3"></i><b>(3)</b>
            .flushInterval(<span class="predefined-type">Duration</span>.ofSeconds(<span class="integer">10</span>))   <i class="conum" data-value="4"></i><b>(4)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use automatic tracking strategy</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Store every 50,000 messages</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Make sure to store offset at least every 10 seconds</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the automatic tracking is the default tracking strategy, so if you are fine
with its defaults, it is enabled as soon as you specify a name
for the consumer:</p>
</div>
<div class="listingblock">
<div class="title">Setting only the consumer name to enable automatic tracking</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set only the consumer name to enable automatic tracking with defaults</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Automatic tracking is simple and provides good guarantees. It is nevertheless
possible to have more fine-grained control over offset tracking by using
manual tracking.</p>
</div>
</div>
<div class="sect4">
<h5 id="consumer-manual-offset-tracking"><a class="anchor" href="#consumer-manual-offset-tracking"></a>Manual Offset Tracking</h5>
<div class="paragraph">
<p>The manual tracking strategy lets the developer in charge of storing offsets
whenever they want, not only after a given number of messages has been received
and supposedly processed, like automatic tracking does.</p>
</div>
<div class="paragraph">
<p>The following snippet shows how to enable manual tracking and how to store
the offset at some point:</p>
</div>
<div class="listingblock">
<div class="title">Using manual tracking with defaults</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .manualTrackingStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>

          <span class="keyword">if</span> (conditionToStore()) {
            context.storeOffset();   <i class="conum" data-value="3"></i><b>(3)</b>
          }
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use manual tracking with defaults</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Store the current offset on some condition</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Manual tracking has only one setting: the <strong>check interval</strong>. The client checks
that the last requested stored offset has been actually stored at the
specified interval. <em>The default check interval is 5 seconds</em>.</p>
</div>
<div class="paragraph">
<p>The following snippet shows the configuration of manual tracking:</p>
</div>
<div class="listingblock">
<div class="title">Configuring manual tracking strategy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .manualTrackingStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
            .checkInterval(<span class="predefined-type">Duration</span>.ofSeconds(<span class="integer">10</span>))   <i class="conum" data-value="3"></i><b>(3)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>

          <span class="keyword">if</span> (conditionToStore()) {
            context.storeOffset();   <i class="conum" data-value="4"></i><b>(4)</b>
          }
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use manual tracking with defaults</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Check last requested offset every 10 seconds</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Store the current offset on some condition</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The snippet above uses <code>MessageHandler.Context#storeOffset()</code> to store at the
offset of the current message, but it is possible to store anywhere
in the stream with <code>MessageHandler.Context#consumer()#store(long)</code> or
simply <code>Consumer#store(long)</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="considerations-on-offset-tracking"><a class="anchor" href="#considerations-on-offset-tracking"></a>Considerations On Offset Tracking</h5>
<div class="paragraph">
<p><em>When to store offsets?</em> Avoid storing offsets too often or, worse, for each message.
Even though offset tracking is a small and fast operation, it will
make the stream grow unnecessarily, as the broker persists offset
tracking entries in the stream itself.</p>
</div>
<div class="paragraph">
<p>A good rule of thumb is to store the offset every few thousands
of messages. Of course, when the consumer will restart consuming in a new incarnation, the
last tracked offset may be a little behind the very last message the previous incarnation
actually processed, so the consumer may see some messages that have been already processed.</p>
</div>
<div class="paragraph">
<p>A solution to this problem is to make sure processing is idempotent or filter out the
last duplicated messages.</p>
</div>
<hr>
<div class="paragraph">
<p><em>Is the offset a reliable absolute value?</em> Message offsets may not be contiguous.
This implies that the message at offset 500 in a stream may
not be the 501 message in the stream (offsets start at 0).
There can be different types of entries in a stream storage, a message is
just one of them. For example, storing an offset creates an offset tracking
entry, which has its own offset.</p>
</div>
<div class="paragraph">
<p>This means one must be careful when basing some decision on offset values, like
a modulo to perform an operation every X messages. As the message offsets have
no guarantee to be contiguous, the operation may not happen exactly every X messages.</p>
</div>
</div>
<div class="sect4">
<h5 id="consumer-subscription-listener"><a class="anchor" href="#consumer-subscription-listener"></a>Subscription Listener</h5>
<div class="paragraph">
<p>The client provides a <code>SubscriptionListener</code> interface callback to add behavior before a subscription is created.
This callback can be used to customize the offset the client library computed for the subscription.
The callback is called when the consumer is first created and when the client has to re-subscribe (e.g. after a disconnection or a topology change).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This API is <strong>experimental</strong>, it is subject to change.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to use the callback to get the last processed offset from an external store, that is not using the server-side offset tracking feature RabbitMQ Stream provides.
The following code snippet shows how this can be done (note the interaction with the external store is not detailed):</p>
</div>
<div class="listingblock">
<div class="title">Using an external store for offset tracking with a subscription listener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .subscriptionListener(subscriptionContext -&gt; {  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="type">long</span> offset = getOffsetFromExternalStore();  <i class="conum" data-value="2"></i><b>(2)</b>
        subscriptionContext.offsetSpecification(OffsetSpecification.offset(offset + <span class="integer">1</span>));  <i class="conum" data-value="3"></i><b>(3)</b>
    })
    .messageHandler((context, message) -&gt; {
        <span class="comment">// message handling code...</span>

        storeOffsetInExternalStore(context.offset());  <i class="conum" data-value="4"></i><b>(4)</b>
    })
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set subscription listener</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get offset from external store</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set offset to use for the subscription</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Store the offset in the external store after processing</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When using an external store for offset tracking, it is no longer necessary to set a name and an offset strategy, as these only apply when server-side offset tracking is in use.</p>
</div>
<div class="paragraph">
<p>Using a subscription listener can also be useful to have more accurate offset tracking on re-subscription, at the cost of making the application code slightly more complex.
This requires a good understanding on how and when subscription occurs in the client, and so when the subscription listener is called:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for a consumer with no name (server-side offset tracking <em>disabled</em>)</p>
<div class="ulist">
<ul>
<li>
<p>on the first subscription (when the consumer is created): the offset specification is the one specified with <code>ConsumerBuilder#offset(OffsetSpecification)</code>, the default being <code>OffsetSpecification#next()</code></p>
</li>
<li>
<p>on re-subscription (after a disconnection or topology change): the offset specification is the offset of the last dispatched message</p>
</li>
</ul>
</div>
</li>
<li>
<p>for a consumer with a name (server-side offset tracking <em>enabled</em>)</p>
<div class="ulist">
<ul>
<li>
<p>on the first subscription (when the consumer is created): the server-side stored offset (if any) overrides the value specified with <code>ConsumerBuilder#offset(OffsetSpecification)</code></p>
</li>
<li>
<p>on re-subscription (after a disconnection or topology change): the server-side stored offset is used</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The subscription listener comes in handy on re-subscription.
The application can track the last processed offset in-memory, with an <code>AtomicLong</code> for example.
The application knows exactly when a message is processed and updates its in-memory tracking accordingly, whereas the value computed by the client may not be perfectly appropriate on re-subscription.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take the example of a named consumer with an offset tracking strategy that is lagging because of bad timing and a long flush interval.
When a glitch happens and triggers the re-subscription, the server-side stored offset can be quite behind what the application actually processed.
Using this server-side stored offset can lead to duplicates, whereas using the in-memory, application-specific offset tracking variable is more accurate.
A custom <code>SubscriptionListener</code> lets the application developer uses what&#8217;s best for the application if the computed value is not optimal.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="flow-control"><a class="anchor" href="#flow-control"></a>Flow Control</h4>
<div class="paragraph">
<p>This section covers how a consumer can tell the broker when to send more messages.</p>
</div>
<div class="paragraph">
<p>By default, the broker keeps sending messages as long as messages are processed and the <code>MessageHandler#handle(Context, Message)</code> method returns.
This strategy works fine if message processing is fast enough.
If message processing takes longer, one can be tempted to process messages in parallel with an <code>ExecutorService</code>.
This will make the <code>handle</code> method return immediately and the broker will keep sending messages, potentially overflowing the consumer.</p>
</div>
<div class="paragraph">
<p>What we miss in the parallel processing case is a way to tell the library we are done processing a message and that we are ready at some point to handle more messages.
This is the goal of the <code>MessageHandler.Context#processed()</code> method.</p>
</div>
<div class="paragraph">
<p>This method is by default a no-op because the default flow control strategy keeps asking for more messages as soon as message processing is done.
This method gets some real behavior to control the flow of messages when an appropriate <code>ConsumerFlowStrategy</code> is set <code>ConsumerBuilder#flow()</code>.
The following code snippet shows how to set a handy consumer flow strategy:</p>
</div>
<div class="listingblock">
<div class="title">Setting a consumer flow control strategy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .flow()
        .strategy(ConsumerFlowStrategy.creditWhenHalfMessagesProcessed())  <i class="conum" data-value="1"></i><b>(1)</b>
    .builder()
    .messageHandler((context, message) -&gt; {
      <span class="comment">// message handling code (possibly asynchronous)...</span>
      context.processed();  <i class="conum" data-value="2"></i><b>(2)</b>
    })
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the flow control strategy</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Make sure to call <code>Context#processed()</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the example we set up the <code>creditWhenHalfMessagesProcessed</code> strategy which asks for more messages once half of the current messages have been marked as processed.
The broker does not send messages one by one, it sends <a href="#chunk-definition">chunks</a> of messages.
A chunk of messages can contain 1 to several thousands of messages.
So with the strategy set above, once <code>processed()</code> has been called for half of the messages of the current chunk, the library will ask the broker for another one (it will provide a <em>credit</em> for the subscription).
By doing this, the next chunk should arrive by the time we are done with the other half of the current chunk.
This way the consumer is neither overwhelmed nor idle.</p>
</div>
<div class="paragraph">
<p>The <code>ConsumerFlowStrategy</code> interface provides some static helpers to configure the appropriate strategy.</p>
</div>
<div class="paragraph">
<p>Additional notes on consumer flow control:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure to <strong>call the <code>processed()</code> method</strong> once you set up a <code>ConsumerFlowStrategy</code>.
The method is a no-op by default, but it is essential to call it with count-based strategies like <code>creditWhenHalfMessagesProcessed</code> or <code>creditOnProcessedMessageCount</code>.
No calling it will stop the dispatching of messages.</p>
</li>
<li>
<p>Make sure to call <code>processed()</code> only once.
Whether the method is idempotent depends on the flow strategy implementation.
Apart from the default one, the implementations the library provides does not make <code>processed()</code> idempotent.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="single-active-consumer"><a class="anchor" href="#single-active-consumer"></a>Single Active Consumer</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Single Active Consumer requires <strong>RabbitMQ 3.11</strong> or more.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the single active consumer feature is enabled for several consumer instances sharing the same stream and name, only one of these instances will be active at a time and so will receive messages.
The other instances will be idle.</p>
</div>
<div class="paragraph">
<p>The single active consumer feature provides 2 benefits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Messages are processed in order: there is only one consumer at a time.</p>
</li>
<li>
<p>Consumption continuity is maintained: a consumer from the group will take over if the active one stops or crashes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A typical sequence of events would be the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Several instances of the same consuming application start up.</p>
</li>
<li>
<p>Each application instance registers a single active consumer.
The consumer instances share the same name.</p>
</li>
<li>
<p>The broker makes the first registered consumer the active one.</p>
</li>
<li>
<p>The active consumer receives and processes messages, the other consumer instances remain idle.</p>
</li>
<li>
<p>The active consumer stops or crashes.</p>
</li>
<li>
<p>The broker chooses the consumer next in line to become the new active one.</p>
</li>
<li>
<p>The new active consumer starts receiving messages.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next figures illustrates this mechanism.
There can be only one active consumer:</p>
</div>
<div class="listingblock">
<div class="title">The first registered consumer is active, the next ones are inactive</div>
<div class="content">
<pre>Failed to generate image: cannot link Java class org.asciidoctor.diagram.CommandProcessor org/asciidoctor/diagram/CommandProcessor has been compiled by a more recent version of the Java Runtime (class file version 55.0), this version of the Java Runtime only recognizes class file versions up to 52.0
                    +----------+
             +------+ consumer + Active
             |      +----------+
             |
+--------+   |      +=---------+
+ stream +---+------+ consumer + Inactive
+--------+   |      +----------+
             |
             |      +=---------+
             +------+ consumer + Inactive
                    +----------+</pre>
</div>
</div>
<div class="paragraph">
<p>The broker rolls over to another consumer when the active one stops or crashes:</p>
</div>
<div class="listingblock">
<div class="title">When the active consumer stops, the next in line becomes active</div>
<div class="content">
<pre>Failed to generate image: cannot link Java class org.asciidoctor.diagram.CommandProcessor org/asciidoctor/diagram/CommandProcessor has been compiled by a more recent version of the Java Runtime (class file version 55.0), this version of the Java Runtime only recognizes class file versions up to 52.0
                    +=---------+
                    | consumer + Closed
                    +----------+

+--------+          +----------+
+ stream +---+------+ consumer + Active
+--------+   |      +----------+
             |
             |      +=---------+
             +------+ consumer + Inactive
                    +----------+</pre>
</div>
</div>
<div class="paragraph">
<p>Note there can be several groups of single active consumers on the same stream.
What makes them different from each other is the name used by the consumers.
The broker deals with them independently.
Let&#8217;s use an example.
Imagine 2 different <code>app-1</code> and <code>app-2</code> applications consuming from the same stream, with 3 identical instances each.
Each instance registers 1 single active consumer with the name of the application.
We end up with 3 <code>app-1</code> consumers and 3 <code>app-2</code> consumers, 1 active consumer in each group, so overall 6 consumers and 2 active ones, all of this on the same stream.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see now the API for single active consumer.</p>
</div>
<div class="sect4">
<h5 id="enabling-single-active-consumer"><a class="anchor" href="#enabling-single-active-consumer"></a>Enabling Single Active Consumer</h5>
<div class="paragraph">
<p>Use the <code>ConsumerBuilder#singleActiveConsumer()</code> method to enable the feature:</p>
</div>
<div class="listingblock">
<div class="title">Enabling single active consumer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .singleActiveConsumer()  <i class="conum" data-value="2"></i><b>(2)</b>
    .messageHandler((context, message) -&gt; {
      <span class="comment">// message handling code...</span>
    })
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory to enable single active consumer)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable single active consumer</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the configuration above, the consumer will take part in the <code>application-1</code> group on the <code>my-stream</code> stream.
If the consumer instance is the first in a group, it will get messages as soon as there are some available. If it is not the first in the group, it will remain idle until it is its turn to be active (likely when all the instances registered before it are gone).</p>
</div>
</div>
<div class="sect4">
<h5 id="offset-tracking"><a class="anchor" href="#offset-tracking"></a>Offset Tracking</h5>
<div class="paragraph">
<p>Single active consumer and offset tracking work together: when the active consumer goes away, another consumer takes over and resumes when the former active left off.
Well, this is how things should work and luckily this is what happens when using <a href="#consumer-offset-tracking">server-side offset tracking</a>.
So as long as you use <a href="#consumer-automatic-offset-tracking">automatic offset tracking</a> or <a href="#consumer-manual-offset-tracking">manual offset tracking</a>, the handoff between a former active consumer and the new one will go well.</p>
</div>
<div class="paragraph">
<p>The story is different is you are using an external store for offset tracking.
In this case you need to tell the client library where to resume from and you can do this by implementing the <code>ConsumerUpdateListener</code> API.</p>
</div>
</div>
<div class="sect4">
<h5 id="consumer-update-listener"><a class="anchor" href="#consumer-update-listener"></a>Reacting to Consumer State Change</h5>
<div class="paragraph">
<p>The broker notifies a consumer that becomes active before dispatching messages to it.
The broker expects a response from the consumer and this response contains the offset the dispatching should start from.
So this is the consumer&#8217;s responsibility to compute the appropriate offset, not the broker&#8217;s.
The default behavior is to look up the last stored offset for the consumer on the stream.
This works when server-side offset tracking is in use, but it does not when the application chose to use an external store for offset tracking.
In this case, it is possible to use the <code>ConsumerBuilder#consumerUpdateListener(ConsumerUpdateListener)</code> method like demonstrated in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Fetching the last stored offset from an external store in the consumer update listener callback</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .singleActiveConsumer()  <i class="conum" data-value="2"></i><b>(2)</b>
    .noTrackingStrategy()  <i class="conum" data-value="3"></i><b>(3)</b>
    .consumerUpdateListener(context -&gt; {  <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="type">long</span> offset = getOffsetFromExternalStore();  <i class="conum" data-value="5"></i><b>(5)</b>
      <span class="keyword">return</span> OffsetSpecification.offset(offset + <span class="integer">1</span>); <i class="conum" data-value="6"></i><b>(6)</b>
    })
    .messageHandler((context, message) -&gt; {
      <span class="comment">// message handling code...</span>

      storeOffsetInExternalStore(context.offset());
    })
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory to enable single active consumer)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable single active consumer</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Disable server-side offset tracking</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the consumer update listener</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Fetch last offset from external store</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Return the offset to resume consuming from to the broker</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="super-streams"><a class="anchor" href="#super-streams"></a>Super Streams (Partitioned Streams)</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Super Streams require <strong>RabbitMQ 3.11</strong> or more.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A super stream is a logical stream made of several individual streams.
In essence, a super stream is a partitioned stream that brings scalability compared to a single stream.</p>
</div>
<div class="paragraph">
<p>The stream Java client uses the same programming model for super streams as with individual streams, that is the <code>Producer</code>, <code>Consumer</code>, <code>Message</code>, etc API are still valid when super streams are in use.
Application code should not be impacted whether it uses individual or super streams.</p>
</div>
<div class="paragraph">
<p>Consuming applications can use super streams and <a href="#single-active-consumer">single active consumer</a> at the same time.
The 2 features combined make sure only one consumer instance consumes from an individual stream at a time.
In this configuration, super streams provide scalability and single active consumer provides the guarantee that messages of an individual stream are processed in order.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Super streams do not deprecate streams</div>
<div class="paragraph">
<p>Super streams are a <a href="https://en.wikipedia.org/wiki/Partition_(database)">partitioning</a> solution.
They are not meant to replace individual streams, they sit on top of them to handle some use cases in a better way.
If the stream data is likely to be large â€“ hundreds of gigabytes or even terabytes, size remains relative â€“ and even presents an obvious partition key (e.g. country), a super stream can be appropriate.
It can help to cope with the data size and to take advantage of data locality for some processing use cases.
Remember that partitioning always comes with complexity though, even if the implementation of super streams strives to make it as transparent as possible for the application developer.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="topology"><a class="anchor" href="#topology"></a>Topology</h4>
<div class="paragraph">
<p>A super stream is made of several individual streams, so it can be considered a logical entity rather than an actual physical entity.
The topology of a super stream is based on the <a href="https://www.rabbitmq.com/tutorials/amqp-concepts.html">AMQP 0.9.1 model</a>, that is exchange, queues, and bindings between them.
This does not mean AMQP resources are used to transport or store stream messages, it means that they are used to <em>describe</em> the super stream topology, that is the streams it is made of.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take the example of an <code>invoices</code> super stream made of 3 streams (i.e. partitions):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an <code>invoices</code> exchange represents the super stream</p>
</li>
<li>
<p>the <code>invoices-0</code>, <code>invoices-1</code>, <code>invoices-2</code> streams are the partitions of the super stream (streams are also AMQP queues in RabbitMQ)</p>
</li>
<li>
<p>3 bindings between the exchange and the streams link the super stream to its partitions and represent <em>routing rules</em></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">The topology of a super stream is defined with bindings between an exchange and queues</div>
<div class="content">
<pre>Failed to generate image: cannot link Java class org.asciidoctor.diagram.CommandProcessor org/asciidoctor/diagram/CommandProcessor has been compiled by a more recent version of the Java Runtime (class file version 55.0), this version of the Java Runtime only recognizes class file versions up to 52.0
                 0    +------------+
               +-----&gt;+ invoicesâ€“0 |
               |      +------------+
+----------+   |
| invoices |   | 1    +------------+
|          +---+-----&gt;+ invoicesâ€“1 |
| exchange |   |      +------------+
+----------+   |
               | 2    +------------+
               +-----&gt;+ invoicesâ€“2 |
                      +------------+</pre>
</div>
</div>
<div class="paragraph">
<p>When a super stream is in use, the stream Java client queries this information to find out about the partitions of a super stream and the routing rules.
From the application code point of view, using a super stream is mostly configuration-based.
Some logic must also be provided to extract routing information from messages.</p>
</div>
</div>
<div class="sect3">
<h4 id="super-stream-creation"><a class="anchor" href="#super-stream-creation"></a>Super Stream Creation</h4>
<div class="paragraph">
<p>It is possible to create the topology of a super stream with any AMQP 0.9.1 library or with the <a href="https://www.rabbitmq.com/management.html">management plugin</a>, but the <code>rabbitmq-streams add_super_stream</code> command is a handy shortcut.
Here is how to create an invoices super stream with 3 partitions:</p>
</div>
<div class="listingblock">
<div class="title">Creating a super stream from the CLI</div>
<div class="content">
<pre>rabbitmq-streams add_super_stream invoices --partitions 3</pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>rabbitmq-streams add_super_stream --help</code> to learn more about the command.</p>
</div>
</div>
<div class="sect3">
<h4 id="super-stream-producer"><a class="anchor" href="#super-stream-producer"></a>Publishing to a Super Stream</h4>
<div class="paragraph">
<p>When the topology of a super stream like the one described above has been set, creating a producer for it is straightforward:</p>
</div>
<div class="listingblock">
<div class="title">Creating a Producer for a Super Stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
        .superStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
        .routing(message -&gt; message.getProperties().getMessageIdAsString()) <i class="conum" data-value="2"></i><b>(2)</b>
        .producerBuilder()
        .build();  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="comment">// ...</span>
producer.close();  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the super stream name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Provide the logic to get the routing key from a message</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the producer instance</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Close the producer when it&#8217;s no longer necessary</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that even though the <code>invoices</code> super stream is not an actual stream, its name must be used to declare the producer.
Internally the client will figure out the streams that compose the super stream.
The application code must provide the logic to extract a routing key from a message as a <code>Function&lt;Message, String&gt;</code>.
The client will hash the routing key to determine the stream to send the message to (using partition list and a modulo operation).</p>
</div>
<div class="paragraph">
<p>The client uses 32-bit <a href="https://en.wikipedia.org/wiki/MurmurHash">MurmurHash3</a> by default to hash the routing key.
This hash function provides good uniformity, performance, and portability, making it a good default choice, but it is possible to specify a custom hash function:</p>
</div>
<div class="listingblock">
<div class="title">Specifying a custom hash function</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .superStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)
    .routing(message -&gt; message.getProperties().getMessageIdAsString())
    .hash(rk -&gt; rk.hashCode())  <i class="conum" data-value="1"></i><b>(1)</b>
    .producerBuilder()
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>String#hashCode()</code> to hash the routing key</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note using Java&#8217;s <code>hashCode()</code> method is a debatable choice as potential producers in other languages are unlikely to implement it, making the routing different between producers in different languages.</p>
</div>
<div class="sect4">
<h5 id="resolving-routes-with-bindings"><a class="anchor" href="#resolving-routes-with-bindings"></a>Resolving Routes with Bindings</h5>
<div class="paragraph">
<p>Hashing the routing key to pick a partition is only one way to route messages to the appropriate streams.
The stream Java client provides another way to resolve streams, based on the routing key <em>and</em> the bindings between the super stream exchange and the streams.</p>
</div>
<div class="paragraph">
<p>This routing strategy makes sense when the partitioning has a business meaning, e.g. with a partition for a region in the world, like in the diagram below:</p>
</div>
<div class="listingblock">
<div class="title">A super stream with a partition for a region in a world</div>
<div class="content">
<pre>Failed to generate image: cannot link Java class org.asciidoctor.diagram.CommandProcessor org/asciidoctor/diagram/CommandProcessor has been compiled by a more recent version of the Java Runtime (class file version 55.0), this version of the Java Runtime only recognizes class file versions up to 52.0
                 amer  +---------------+
               +------&gt;+ invoicesâ€“amer |
               |       +---------------+
+----------+   |
| invoices |   | emea  +---------------+
|          +---+------&gt;+ invoicesâ€“emea |
| exchange |   |       +---------------+
+----------+   |
               | apac  +---------------+
               +------&gt;+ invoicesâ€“apac |
                       +---------------+</pre>
</div>
</div>
<div class="paragraph">
<p>In such a case, the routing key will be a property of the message that represents the region:</p>
</div>
<div class="listingblock">
<div class="title">Enabling the "key" routing strategy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .superStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)
    .routing(msg -&gt; msg.getApplicationProperties().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">region</span><span class="delimiter">&quot;</span></span>).toString())  <i class="conum" data-value="1"></i><b>(1)</b>
    .key()  <i class="conum" data-value="2"></i><b>(2)</b>
    .producerBuilder()
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Extract the routing key</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable the "key" routing strategy</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Internally the client will query the broker to resolve the destination streams for a given routing key, making the routing logic from any exchange type available to streams.
Note the client caches results, it does not query the broker for every message.</p>
</div>
</div>
<div class="sect4">
<h5 id="using-a-custom-routing-strategy"><a class="anchor" href="#using-a-custom-routing-strategy"></a>Using a Custom Routing Strategy</h5>
<div class="paragraph">
<p>The solution that provides the most control over routing is using a custom routing strategy.
This should be needed only for specific cases.</p>
</div>
<div class="paragraph">
<p>Here is an excerpt of the <code>RoutingStrategy</code> interface:</p>
</div>
<div class="listingblock">
<div class="title">The routing strategy interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RoutingStrategy</span> {

  <span class="comment">/** Where to route a message. */</span>
  <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; route(Message message, Metadata metadata);

  <span class="comment">/** Metadata on the super stream. */</span>
  <span class="type">interface</span> <span class="class">Metadata</span> {

    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; partitions();

    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; route(<span class="predefined-type">String</span> routingKey);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note it is possible to route a message to several streams or even nowhere.
The "hash" routing strategy always routes to 1 stream and the "key" routing strategy can route to several streams.</p>
</div>
<div class="paragraph">
<p>The following code sample shows how to implement a simplistic round-robin <code>RoutingStrategy</code> and use it in the producer.
Note this implementation should not be used in production as the modulo operation is not sign-safe for simplicity&#8217;s sake.</p>
</div>
<div class="listingblock">
<div class="title">Setting a round-robin routing strategy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">AtomicLong</span> messageCount = <span class="keyword">new</span> <span class="predefined-type">AtomicLong</span>(<span class="integer">0</span>);
RoutingStrategy routingStrategy = (message, metadata) -&gt; {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; partitions = metadata.partitions();
    <span class="predefined-type">String</span> stream = partitions.get(
        (<span class="type">int</span>) messageCount.getAndIncrement() % partitions.size()
    );
    <span class="keyword">return</span> <span class="predefined-type">Collections</span>.singletonList(stream);
};
Producer producer = environment.producerBuilder()
    .superStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)
    .routing(<span class="predefined-constant">null</span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .strategy(routingStrategy)  <i class="conum" data-value="2"></i><b>(2)</b>
    .producerBuilder()
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>No need to set the routing key extraction logic</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the custom routing strategy</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="deduplication"><a class="anchor" href="#deduplication"></a>Deduplication</h5>
<div class="paragraph">
<p>Deduplication for a super stream producer works the same way as with a <a href="#outbound-message-deduplication">single stream producer</a>.
The publishing ID values are spread across the streams but this does affect the mechanism.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="consuming-from-a-super-stream"><a class="anchor" href="#consuming-from-a-super-stream"></a>Consuming From a Super Stream</h4>
<div class="paragraph">
<p>A super stream consumer is a composite consumer: it will look up the super stream partitions and create a consumer for each or them.
The programming model is the same as with regular consumers for the application developer: their main job is to provide the application code to process messages, that is a <code>MessageHandler</code> instance.
The configuration is different though and this section covers its subtleties.
But let&#8217;s focus on the behavior of a super stream consumer first.</p>
</div>
<div class="sect4">
<h5 id="super-stream-consumer-in-practice"><a class="anchor" href="#super-stream-consumer-in-practice"></a>Super Stream Consumer in Practice</h5>
<div class="paragraph">
<p>Imagine you have a super stream made of 3 partitions (individual streams).
You start an instance of your application, that itself creates a super stream consumer for this super stream.
The super stream consumer will create 3 consumers internally, one for each partition, and messages will flow in your <code>MessageHandler</code>.</p>
</div>
<div class="paragraph">
<p>Imagine now that you start another instance of your application.
It will do the exact same thing as previously and the 2 instances will process the exact same messages in parallel.
This may be not what you want: the messages will be processed twice!</p>
</div>
<div class="paragraph">
<p>Having one instance of your application may be enough: the data are spread across several streams automatically and the messages from the different partitions are processed in parallel from a single OS process.</p>
</div>
<div class="paragraph">
<p>But if you want to scale the processing across several OS processes (or bare-metal machines, or virtual machines) and you don&#8217;t want your messages to be processed several times as illustrated above, you&#8217;ll have to enable the <strong>single active consumer</strong> feature on your super stream consumer.</p>
</div>
<div class="paragraph">
<p>The next subsections cover the basic settings of a super stream consumer and a <a href="#super-stream-sac">dedicated section</a> covers how super stream consumers and single active consumer play together.</p>
</div>
</div>
<div class="sect4">
<h5 id="declaring-a-super-stream-consumer"><a class="anchor" href="#declaring-a-super-stream-consumer"></a>Declaring a Super Stream Consumer</h5>
<div class="paragraph">
<p>Declaring a super stream consumer is not much different from declaring a single stream consumer.
The <code>ConsumerBuilder#superStream(String)</code> must be used to set the super stream to consume from:</p>
</div>
<div class="listingblock">
<div class="title">Declaring a super stream consumer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()
    .superStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .messageHandler((context, message) -&gt; {
        <span class="comment">// message processing</span>
    })
    .build();
<span class="comment">// ...</span>
consumer.close();  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the super stream name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Close the consumer when it is no longer necessary</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s all.
The super stream consumer will take of the details (partitions lookup, coordination of the single consumers, etc).</p>
</div>
</div>
<div class="sect4">
<h5 id="offset-tracking-2"><a class="anchor" href="#offset-tracking-2"></a>Offset Tracking</h5>
<div class="paragraph">
<p>The semantic of offset tracking for a super stream consumer are roughly the same as for an individual stream consumer.
There are still some subtle differences, so a good understanding of <a href="#consumer-offset-tracking">offset tracking</a> in general and of the <a href="#consumer-automatic-offset-tracking">automatic</a> and <a href="#consumer-manual-offset-tracking">manual</a> offset tracking strategies is recommended.</p>
</div>
<div class="paragraph">
<p>Here are the main differences for the automatic/manual offset tracking strategies between single and super stream consuming:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>automatic offset tracking</strong>: internally, <em>the client divides the <code>messageCountBeforeStorage</code> setting by the number of partitions for each individual consumer</em>.
Imagine a 3-partition super stream, <code>messageCountBeforeStorage</code> set to 10,000, and 10,000 messages coming in, perfectly balanced across the partitions (that is about 3,333 messages for each partition).
In this case, the automatic offset tracking strategy will not kick in, because the expected count message has not been reached on any partition.
Making the client divide <code>messageCountBeforeStorage</code> by the number of partitions can be considered "more accurate" if the message are well balanced across the partitions.
A good rule of thumb is to then multiply the expected per-stream <code>messageCountBeforeStorage</code> by the number of partitions, to avoid storing offsets too often. So the default being 10,000, it can be set to 30,000 for a 3-partition super stream.</p>
</li>
<li>
<p><strong>manual offset tracking</strong>: the <code>MessageHandler.Context#storeOffset()</code> method must be used, the <code>Consumer#store(long)</code> will fail, because an offset value has a meaning only in one stream, not in other streams.
A call to <code>MessageHandler.Context#storeOffset()</code> will store the current message offset in <em>its</em> stream, but also the offset of the last dispatched message for the other streams of the super stream.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="super-stream-sac"><a class="anchor" href="#super-stream-sac"></a>Single Active Consumer Support</h5>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Single Active Consumer requires <strong>RabbitMQ 3.11</strong> or more.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As <a href="#super-stream-consumer-in-practice">stated previously</a>, super stream consumers and single active consumer provide scalability and the guarantee that messages of an individual stream are processed in order.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take an example with a 3-partition super stream:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You have an application that creates a super stream consumer instance with single active consumer enabled.</p>
</li>
<li>
<p>You start 3 instances of this application. An instance in this case is a JVM process, which can be in a Docker container, a virtual machine, or a bare-metal server.</p>
</li>
<li>
<p>As the super stream has 3 partitions, each application instance will create a super stream consumer that maintains internally 3 consumer instances.
That is 9 Java instances of consumer overall.
Such a super stream consumer is a <em>composite consumer</em>.</p>
</li>
<li>
<p>The broker and the different application instances coordinate so that only 1 consumer instance for a given partition receives messages at a time.
So among these 9 consumer instances, only 3 are actually <em>active</em>, the other ones are idle or <em>inactive</em>.</p>
</li>
<li>
<p>If one of the application instances stops, the broker will <em>rebalance</em> its active consumer to one of the other instances.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following figure illustrates how the client library supports the combination of the super stream and single active consumer features.
It uses a composite consumer that creates an individual consumer for each partition of the super stream.
If there is only one single active consumer instance with a given name for a super stream, each individual consumer is active.</p>
</div>
<div class="listingblock">
<div class="title">A single active consumer on a super stream is a composite consumer that creates an individual consumer for each partition</div>
<div class="content">
<pre>Failed to generate image: cannot link Java class org.asciidoctor.diagram.CommandProcessor org/asciidoctor/diagram/CommandProcessor has been compiled by a more recent version of the Java Runtime (class file version 55.0), this version of the Java Runtime only recognizes class file versions up to 52.0
              +--------------------+
              |                    |
              |cGRE invoicesâ€“0     |
              |                    |    +-------------------+
              +--------------------+    |+-----------------+|
                                        |+cGRE consumer    ||Active
                                        |+-----------------+|
  invoices    +--------------------+    |                   |
              |                    |    |+-----------------+|
              |cPNK invoicesâ€“1     |    |+cPNK consumer    ||Active
              |                    |    |+-----------------+|
super stream  +--------------------+    |                   |
                                        |+-----------------+|
                                        |+cBLU consumer    ||Active
              +--------------------+    |+-----------------+|
              |                    |    +-------------------+
              |cBLU invoicesâ€“2     |     Composite Consumer
              |                    |
              +--------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>Imagine now we start 3 instances of the consuming application to scale out the processing.
The individual consumer instances spread out across the super stream partitions and only one is active for each partition, as illustrated in the following figure:</p>
</div>
<div class="listingblock">
<div class="title">Consumer instances spread across the super stream partitions and are activated accordingly</div>
<div class="content">
<pre>Failed to generate image: cannot link Java class org.asciidoctor.diagram.CommandProcessor org/asciidoctor/diagram/CommandProcessor has been compiled by a more recent version of the Java Runtime (class file version 55.0), this version of the Java Runtime only recognizes class file versions up to 52.0
                                        +-------------------+
                                        |+-----------------+|
                                        |+cGRE consumer    ||Active
                                        |+-----------------+|
                                        |                   |
                                        |+-----------------+|
                                        |+cPNK consumer    ||Inactive
                                        |+-----------------+|
                                        |                   |
                                        |+-----------------+|
                                        |+cBLU consumer    ||Inactive
                                        |+-----------------+|
              +--------------------+    +-------------------+
              |                    |     Composite Consumer
              |cGRE invoicesâ€“0     |
              |                    |    +-------------------+
              +--------------------+    |+-----------------+|
                                        |+cGRE consumer    ||Inactive
                                        |+-----------------+|
  invoices    +--------------------+    |                   |
              |                    |    |+-----------------+|
              |cPNK invoicesâ€“1     |    |+cPNK consumer    ||Active
              |                    |    |+-----------------+|
super stream  +--------------------+    |                   |
                                        |+-----------------+|
                                        |+cBLU consumer    ||Inactive
              +--------------------+    |+-----------------+|
              |                    |    +-------------------+
              |cBLU invoicesâ€“2     |     Composite Consumer
              |                    |
              +--------------------+    +-------------------+
                                        |+-----------------+|
                                        |+cGRE consumer    ||Inactive
                                        |+-----------------+|
                                        |                   |
                                        |+-----------------+|
                                        |+cPNK consumer    ||Inactive
                                        |+-----------------+|
                                        |                   |
                                        |+-----------------+|
                                        |+cBLU consumer    ||Active
                                        |+-----------------+|
                                        +-------------------+
                                         Composite Consumer</pre>
</div>
</div>
<div class="paragraph">
<p>After this overview, let&#8217;s see the API and the configuration details.</p>
</div>
<div class="paragraph">
<p>The following snippet shows how to declare a single active consumer on a super stream with the <code>ConsumerBuilder#superStream(String)</code> and <code>ConsumerBuilder#singleActiveConsumer()</code> methods:</p>
</div>
<div class="listingblock">
<div class="title">Enabling single active consumer on a super stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()
    .superStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
    .singleActiveConsumer()  <i class="conum" data-value="3"></i><b>(3)</b>
    .messageHandler((context, message) -&gt; {
        <span class="comment">// message processing</span>
    })
    .build();
<span class="comment">// ...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the super stream name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the consumer name (mandatory to enable single active consumer)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Enable single active consumer</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note it is mandatory to specify a name for the consumer.
This name will be used to identify the <em>group</em> of consumer instances and make sure only one is active for each partition.
The name is also the reference for offset tracking.</p>
</div>
<div class="paragraph">
<p>The example above uses by default <a href="#consumer-automatic-offset-tracking">automatic offset tracking</a>.
With this strategy, the client library takes care of offset tracking when consumers become active or inactive.
It looks up the latest stored offset when a consumer becomes active to start consuming at the appropriate offset and it stores the last dispatched offset when a consumer becomes inactive.</p>
</div>
<div class="paragraph">
<p>The story is not the same with <a href="#consumer-manual-offset-tracking">manual offset tracking</a> as the client library does not know which offset it should store when a consumer becomes inactive.
The application developer can use the <a href="#consumer-update-listener"><code>ConsumerUpdateListener)</code> callback</a> to react appropriately when a consumer changes state.
The following snippet illustrates the use of the <code>ConsumerUpdateListener</code> callback:</p>
</div>
<div class="listingblock">
<div class="title">Using manual offset tracking for a super stream single active consumer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .superStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
        .singleActiveConsumer()  <i class="conum" data-value="3"></i><b>(3)</b>
        .manualTrackingStrategy()  <i class="conum" data-value="4"></i><b>(4)</b>
        .builder()
        .consumerUpdateListener(context -&gt; {  <i class="conum" data-value="5"></i><b>(5)</b>
           <span class="keyword">if</span>(context.isActive()) {  <i class="conum" data-value="6"></i><b>(6)</b>
               <span class="keyword">try</span> {
                   <span class="keyword">return</span> OffsetSpecification.offset(
                       context.consumer().storedOffset() + <span class="integer">1</span>
                   );
               } <span class="keyword">catch</span> (NoOffsetException e) {
                   <span class="keyword">return</span> OffsetSpecification.next();
               }
           } <span class="keyword">else</span> {
               context.consumer().store(lastProcessedOffsetForThisStream);  <i class="conum" data-value="7"></i><b>(7)</b>
               <span class="keyword">return</span> <span class="predefined-constant">null</span>;
           }
        })
        .messageHandler((context, message) -&gt; {
            <span class="comment">// message handling code...</span>

            <span class="keyword">if</span> (conditionToStore()) {
                context.storeOffset();  <i class="conum" data-value="8"></i><b>(8)</b>
            }
        })
        .build();
<span class="comment">// ...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the super stream name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the consumer name (mandatory to enable single active consumer)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Enable single active consumer</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Enable manual offset tracking strategy</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set <code>ConsumerUpdateListener</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Return stored offset + 1 or default when consumer becomes active</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Store last processed offset for the stream when consumer becomes inactive</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Store the current offset on some condition</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>ConsumerUpdateListener</code> callback must return the offset to start consuming from when a consumer becomes active.
This is what the code above does: it checks if the consumer is active with <code>ConsumerUpdateListener.Context#isActive()</code> and looks up the last stored offset.
If there is no stored offset yet, it returns a default value, <code>OffsetSpecification#next()</code> here.</p>
</div>
<div class="paragraph">
<p>When a consumer becomes inactive, it should store the last processed offset, as another consumer instance will take over elsewhere.
It is expected this other consumer runs the exact same code, so it will execute the same sequence when it becomes active (looking up the stored offset, returning the value + 1).</p>
</div>
<div class="paragraph">
<p>Note the <code>ConsumerUpdateListener</code> is called for a <em>partition</em>, that is an individual stream.
The application code should take care of maintaining a reference of the last processed offset for each partition of the super stream, e.g. with a <code>Map&lt;String, Long&gt;</code> (partition-to-offset map).
To do so, the <code>context</code> parameter of the <code>MessageHandler</code> and <code>ConsumerUpdateListener</code> callbacks provide a <code>stream()</code> method.</p>
</div>
<div class="paragraph">
<p>RabbitMQ Stream provides server-side offset tracking, but it is possible to use an external store to track offsets for streams.
The <code>ConsumerUpdateListener</code> callback is still your friend in this case.
The following snippet shows how to leverage it when an external store is in use:</p>
</div>
<div class="listingblock">
<div class="title">Using external offset tracking for a super stream single active consumer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()
    .superStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
    .singleActiveConsumer()  <i class="conum" data-value="3"></i><b>(3)</b>
    .noTrackingStrategy()  <i class="conum" data-value="4"></i><b>(4)</b>
    .consumerUpdateListener(context -&gt; {  <i class="conum" data-value="5"></i><b>(5)</b>
      <span class="keyword">if</span> (context.isActive()) {  <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="type">long</span> offset = getOffsetFromExternalStore();
        <span class="keyword">return</span> OffsetSpecification.offset(offset + <span class="integer">1</span>);
      }
      <span class="keyword">return</span> <span class="predefined-constant">null</span>;  <i class="conum" data-value="7"></i><b>(7)</b>
    })
    .messageHandler((context, message) -&gt; {
      <span class="comment">// message handling code...</span>

      storeOffsetInExternalStore(context.stream(), context.offset());  <i class="conum" data-value="8"></i><b>(8)</b>
    })
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the super stream name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the consumer name (mandatory to enable single active consumer)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Enable single active consumer</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Disable server-side offset tracking</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set <code>ConsumerUpdateListener</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Use external store for stored offset when consumer becomes active</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Assume offset already stored when consumer becomes inactive</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Use external store for offset tracking</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here are the takeaway points of this code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Even though there is no server-side offset tracking to use it, the consumer must still have a name to identify the group it belongs to.
The external offset tracking mechanism is free to use the same name or not.</p>
</li>
<li>
<p>Calling <code>ConsumerBuilder#noTrackingStrategy()</code> is necessary to disable server-side offset tracking, or the automatic tracking strategy will kick in.</p>
</li>
<li>
<p>The snippet does not provide the details, but the offset tracking mechanism seems to store the offset for each message.
The external store must be able to cope with the message rate in a real-world scenario.</p>
</li>
<li>
<p>The <code>ConsumerUpdateListener</code> callback returns the last stored offset + 1 when the consumer becomes active.
This way the broker will resume the dispatching at this location in the stream.</p>
</li>
<li>
<p>A well-behaved <code>ConsumerUpdateListener</code> must make sure the last processed offset is stored when the consumer becomes inactive, so that the consumer that will take over can look up the offset and resume consuming at the right location.
Our <code>ConsumerUpdateListener</code> does not do anything when the consumer becomes inactive (it returns <code>null</code>): it can afford this because the offset is stored for each message.
Make sure to store the last processed offset when the consumer becomes inactive to avoid duplicates when the consumption resumes elsewhere.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced-topics"><a class="anchor" href="#advanced-topics"></a>Advanced Topics</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="filtering"><a class="anchor" href="#filtering"></a>Filtering</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Filtering requires <strong>RabbitMQ 3.13</strong> or more.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>RabbitMQ Stream provides a server-side filtering feature that avoids reading all the messages of a stream and filtering only on the client side.
This helps to save network bandwidth when a consuming application needs only a subset of messages, e.g. the messages from a given geographical region.</p>
</div>
<div class="paragraph">
<p>The filtering feature works as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>each message is published with an associated <em>filter value</em></p>
</li>
<li>
<p>a consumer that wants to enable filtering must:</p>
<div class="ulist">
<ul>
<li>
<p>define one or several filter values</p>
</li>
<li>
<p>define some client-side filtering logic</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Why does the consumer need to define some client-side filtering logic?
Because the server-side filtering is probabilistic: messages that do not match the filter value(s) can still be sent to the consumer.
The server uses a <a href="https://en.wikipedia.org/wiki/Bloom_filter">Bloom filter</a>, <em>a space-efficient probabilistic data structure</em>, where false positives are possible.
Despite this, the filtering saves some bandwidth, which is its primary goal.</p>
</div>
<div class="sect3">
<h4 id="filtering-on-the-publishing-side"><a class="anchor" href="#filtering-on-the-publishing-side"></a>Filtering on the Publishing Side</h4>
<div class="paragraph">
<p>Filtering on the publishing side consists in defining some logic to extract the filter value from a message.
The following snippet shows how to extract the filter value from an application property:</p>
</div>
<div class="listingblock">
<div class="title">Declaring a producer with logic to extract a filter value from each message</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
  .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)
  .filterValue(msg -&gt;
    msg.getApplicationProperties().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">state</span><span class="delimiter">&quot;</span></span>).toString())  <i class="conum" data-value="1"></i><b>(1)</b>
  .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get filter value from <code>state</code> application property</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the filter value can be null: the message is then published in a regular way.
It is called in this context an <em>unfiltered</em> message.</p>
</div>
</div>
<div class="sect3">
<h4 id="filtering-on-the-consuming-side"><a class="anchor" href="#filtering-on-the-consuming-side"></a>Filtering on the Consuming Side</h4>
<div class="paragraph">
<p>A consumer needs to set up one or several filter values and some filtering logic to enable filtering.
The filtering logic must be consistent with the filter values.
In the next snippet, the consumer wants to process only messages from the state of California.
It sets a filter value to <code>california</code> and a predicate that accepts a message only if the <code>state</code> application properties is <code>california</code>:</p>
</div>
<div class="listingblock">
<div class="title">Declaring a consumer with a filter value and filtering logic</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> filterValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">california</span><span class="delimiter">&quot;</span></span>;
Consumer consumer = environment.consumerBuilder()
  .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)
  .filter()
    .values(filterValue)  <i class="conum" data-value="1"></i><b>(1)</b>
    .postFilter(msg -&gt;
      filterValue.equals(msg.getApplicationProperties().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">state</span><span class="delimiter">&quot;</span></span>)))  <i class="conum" data-value="2"></i><b>(2)</b>
  .builder()
  .messageHandler((ctx, msg) -&gt; { })
  .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set filter value</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set filtering logic</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The filter logic is a <code>Predicate&lt;Message&gt;</code>.
It must return <code>true</code> if a message is accepted, following the same semantics as <code>java.util.stream.Stream#filter(Predicate)</code>.</p>
</div>
<div class="paragraph">
<p>As stated above, not all messages must have an associated filter value.
Many applications may not need some filtering, so they can publish messages the regular way.
So a stream can contain messages with and without an associated filter value.</p>
</div>
<div class="paragraph">
<p>By default, messages without a filter value (a.k.a <em>unfiltered</em> messages) are not sent to a consumer that enabled filtering.</p>
</div>
<div class="paragraph">
<p>But what if a consumer wants to process messages with a filter value and messages without any filter value as well?
It must use the <code>matchUnfiltered()</code> method in its declaration and also make sure to keep the filtering logic consistent:</p>
</div>
<div class="listingblock">
<div class="title">Getting unfiltered messages as well when enabling filtering</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> filterValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">california</span><span class="delimiter">&quot;</span></span>;
Consumer consumer = environment.consumerBuilder()
  .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)
  .filter()
    .values(filterValue)  <i class="conum" data-value="1"></i><b>(1)</b>
    .matchUnfiltered()  <i class="conum" data-value="2"></i><b>(2)</b>
    .postFilter(msg -&gt;
        filterValue.equals(msg.getApplicationProperties().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">state</span><span class="delimiter">&quot;</span></span>))
        || !msg.getApplicationProperties().containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">state</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="3"></i><b>(3)</b>
    )
  .builder()
  .messageHandler((ctx, msg) -&gt; { })
  .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Request messages from California</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Request messages without a filter value as well</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Let both types of messages pass</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the example above, the filtering logic has been adapted to let pass <code>california</code> messages <em>and</em> messages without a state set as well.</p>
</div>
</div>
<div class="sect3">
<h4 id="considerations-on-filtering"><a class="anchor" href="#considerations-on-filtering"></a>Considerations on Filtering</h4>
<div class="paragraph">
<p>As stated previously, the server can send messages that do not match the filter value(s) set by consumers.
This is why application developers must be very careful with the filtering logic they define to avoid processing unwanted messages.</p>
</div>
<div class="paragraph">
<p>What are good candidates for filter values?
Unique identifiers are <em>not</em>: if you know a given message property will be unique in a stream, do not use it as a filter value.
A defined set of values shared across the messages is a good candidate: geographical locations (e.g. countries, states), document types in a stream that stores document information (e.g. payslip, invoice, order), categories of products (e.g. book, luggage, toy).</p>
</div>
<div class="paragraph">
<p>Cardinality of filter values can be from a few to a few thousands.
Extreme cardinality (a couple or dozens of thousands) can make filtering less efficient.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-native-epoll"><a class="anchor" href="#using-native-epoll"></a>Using Native <code>epoll</code></h3>
<div class="paragraph">
<p>The stream Java client uses the <a href="https://netty.io/">Netty</a> network framework and its Java NIO transport implementation by default.
This should be a reasonable default for most applications.</p>
</div>
<div class="paragraph">
<p>Netty also allows using <a href="https://netty.io/wiki/native-transports.html">JNI transports</a>.
They are less portable than Java NIO, but they can be more performant for some workloads (even though the RabbitMQ team has not seen any significant improvement in their own tests).</p>
</div>
<div class="paragraph">
<p>The <a href="https://en.wikipedia.org/wiki/Epoll">Linux <code>epoll</code> transport</a> is a popular choice, so we&#8217;ll see how to configure with the stream Java client.
Other JNI transports can be configured in the same way.</p>
</div>
<div class="paragraph">
<p>The native transport dependency must be added to the dependency manager.
We must pull the native binaries compiled for our OS and architecture, in our example Linux x86-64, so we are using the <code>linux-x86_64</code> classifier.
Here is the declaration for Maven:</p>
</div>
<div class="listingblock">
<div class="title">Declaring the Linux x86-64 native <code>epoll</code> transport dependency with Maven</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>

  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>io.netty<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>netty-transport-native-epoll<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>4.1.100.Final<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;classifier&gt;</span>linux-x86_64<span class="tag">&lt;/classifier&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>

<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And for Gradle:</p>
</div>
<div class="listingblock">
<div class="title">Declaring the Linux x86-64 native <code>epoll</code> transport dependency with Gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
  compile <span class="string"><span class="delimiter">&quot;</span><span class="content">io.netty:netty-transport-native-epoll:4.1.100.Final:linux-x86_64</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The native <code>epoll</code> transport is set up when the environment is configured:</p>
</div>
<div class="listingblock">
<div class="title">Configuring the native <code>epoll</code> transport in the environment</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EventLoopGroup epollEventLoopGroup = <span class="keyword">new</span> EpollEventLoopGroup();  <i class="conum" data-value="1"></i><b>(1)</b>
Environment environment = Environment.builder()
    .netty()  <i class="conum" data-value="2"></i><b>(2)</b>
        .eventLoopGroup(epollEventLoopGroup)  <i class="conum" data-value="3"></i><b>(3)</b>
        .bootstrapCustomizer(b -&gt; b.channel(EpollSocketChannel.class))  <i class="conum" data-value="4"></i><b>(4)</b>
        .environmentBuilder()
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>epoll</code> event loop group (don&#8217;t forget to close it!)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the Netty configuration helper</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the event loop group</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the channel class to use</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the event loop group must be closed explicitly: the environment will not close it itself as it is provided externally.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-the-client"><a class="anchor" href="#building-the-client"></a>Building the Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need JDK 1.8 or more installed.</p>
</div>
<div class="paragraph">
<p>To build the JAR file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./mvnw clean package -DskipITs -DskipTests</pre>
</div>
</div>
<div class="paragraph">
<p>To launch the test suite (requires a local RabbitMQ node with stream plugin enabled):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./mvnw verify -Drabbitmqctl.bin=/path/to/rabbitmqctl</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="micrometer-observation"><a class="anchor" href="#micrometer-observation"></a>Appendix A: Micrometer Observation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is possible to use <a href="https://micrometer.io/docs/observation">Micrometer Observation</a> to instrument publishing and consuming in the stream Java client.
Micrometer Observation provides <a href="https://spring.io/blog/2022/10/12/observability-with-spring-boot-3">metrics, tracing, and log correlation with one single API</a>.</p>
</div>
<div class="paragraph">
<p>The stream Java client provides an <code>ObservationCollector</code> abstraction and an implementation for Micrometer Observation.
The following snippet shows how to create and set up the Micrometer <code>ObservationCollector</code> implementation with an existing <code>ObservationRegistry</code>:</p>
</div>
<div class="listingblock">
<div class="title">Configuring Micrometer Observation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder()
    .observationCollector(<span class="keyword">new</span> MicrometerObservationCollectorBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .registry(observationRegistry).build())  <i class="conum" data-value="2"></i><b>(2)</b>
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure Micrometer <code>ObservationCollector</code> with builder</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set Micrometer <code>ObservationRegistry</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next sections document the conventions, spans, and metrics made available by the instrumentation.
They are automatically generated from the source code with the <a href="https://github.com/micrometer-metrics/micrometer-docs-generator">Micrometer documentation generator</a>.</p>
</div>
<div class="sect2">
<h3 id="observability-conventions"><a class="anchor" href="#observability-conventions"></a>Observability - Conventions</h3>
<div class="paragraph">
<p>Below you can find a list of all <code>GlobalObservationConvention</code> and <code>ObservationConvention</code> declared by this project.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. ObservationConvention implementations</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ObservationConvention Class Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Applicable ObservationContext Class Name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.rabbitmq.stream.observation.micrometer.DefaultProcessObservationConvention</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ProcessContext</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.rabbitmq.stream.observation.micrometer.ProcessObservationConvention</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ProcessContext</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.rabbitmq.stream.observation.micrometer.DefaultPublishObservationConvention</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PublishContext</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.rabbitmq.stream.observation.micrometer.PublishObservationConvention</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PublishContext</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="observability-spans"><a class="anchor" href="#observability-spans"></a>Observability - Spans</h3>
<div class="paragraph">
<p>Below you can find a list of all spans declared by this project.</p>
</div>
<div class="sect3">
<h4 id="observability-spans-process-observation"><a class="anchor" href="#observability-spans-process-observation"></a>Process Observation Span</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Observation for processing a message.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>Span name</strong> <code>rabbitmq.stream.process</code> (defined by convention class <code>com.rabbitmq.stream.observation.micrometer.DefaultProcessObservationConvention</code>).</p>
</div>
<div class="paragraph">
<p>Fully qualified name of the enclosing class <code>com.rabbitmq.stream.observation.micrometer.StreamObservationDocumentation</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Tag Keys</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messaging.operation</code> <em>(required)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string identifying the kind of messaging operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messaging.system</code> <em>(required)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string identifying the messaging system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>net.protocol.name</code> <em>(required)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string identifying the protocol (RabbitMQ Stream).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>net.protocol.version</code> <em>(required)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string identifying the protocol version (1.0).</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="observability-spans-publish-observation"><a class="anchor" href="#observability-spans-publish-observation"></a>Publish Observation Span</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Observation for publishing a message.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>Span name</strong> <code>rabbitmq.stream.publish</code> (defined by convention class <code>com.rabbitmq.stream.observation.micrometer.DefaultPublishObservationConvention</code>).</p>
</div>
<div class="paragraph">
<p>Fully qualified name of the enclosing class <code>com.rabbitmq.stream.observation.micrometer.StreamObservationDocumentation</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Tag Keys</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messaging.operation</code> <em>(required)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string identifying the kind of messaging operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messaging.system</code> <em>(required)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string identifying the messaging system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>net.protocol.name</code> <em>(required)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string identifying the protocol (RabbitMQ Stream).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>net.protocol.version</code> <em>(required)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string identifying the protocol version (1.0).</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="observability-metrics"><a class="anchor" href="#observability-metrics"></a>Observability - Metrics</h3>
<div class="paragraph">
<p>Below you can find a list of all metrics declared by this project.</p>
</div>
<div class="sect3">
<h4 id="observability-metrics-process-observation"><a class="anchor" href="#observability-metrics-process-observation"></a>Process Observation</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Observation for processing a message.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>Metric name</strong> <code>rabbitmq.stream.process</code> (defined by convention class <code>com.rabbitmq.stream.observation.micrometer.DefaultProcessObservationConvention</code>). <strong>Type</strong> <code>timer</code>.</p>
</div>
<div class="paragraph">
<p><strong>Metric name</strong> <code>rabbitmq.stream.process.active</code> (defined by convention class <code>com.rabbitmq.stream.observation.micrometer.DefaultProcessObservationConvention</code>). <strong>Type</strong> <code>long task timer</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
KeyValues that are added after starting the Observation might be missing from the *.active metrics.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Micrometer internally uses <code>nanoseconds</code> for the baseunit. However, each backend determines the actual baseunit. (i.e. Prometheus uses seconds)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Fully qualified name of the enclosing class <code>com.rabbitmq.stream.observation.micrometer.StreamObservationDocumentation</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Low cardinality Keys</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Name</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Description</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>messaging.operation</code> <em>(required)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A string identifying the kind of messaging operation.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>messaging.system</code> <em>(required)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A string identifying the messaging system.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>net.protocol.name</code> <em>(required)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A string identifying the protocol (RabbitMQ Stream).</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>net.protocol.version</code> <em>(required)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A string identifying the protocol version (1.0).</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="observability-metrics-publish-observation"><a class="anchor" href="#observability-metrics-publish-observation"></a>Publish Observation</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Observation for publishing a message.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>Metric name</strong> <code>rabbitmq.stream.publish</code> (defined by convention class <code>com.rabbitmq.stream.observation.micrometer.DefaultPublishObservationConvention</code>). <strong>Type</strong> <code>timer</code>.</p>
</div>
<div class="paragraph">
<p><strong>Metric name</strong> <code>rabbitmq.stream.publish.active</code> (defined by convention class <code>com.rabbitmq.stream.observation.micrometer.DefaultPublishObservationConvention</code>). <strong>Type</strong> <code>long task timer</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
KeyValues that are added after starting the Observation might be missing from the *.active metrics.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Micrometer internally uses <code>nanoseconds</code> for the baseunit. However, each backend determines the actual baseunit. (i.e. Prometheus uses seconds)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Fully qualified name of the enclosing class <code>com.rabbitmq.stream.observation.micrometer.StreamObservationDocumentation</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Low cardinality Keys</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Name</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Description</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>messaging.operation</code> <em>(required)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A string identifying the kind of messaging operation.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>messaging.system</code> <em>(required)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A string identifying the messaging system.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>net.protocol.name</code> <em>(required)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A string identifying the protocol (RabbitMQ Stream).</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>net.protocol.version</code> <em>(required)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A string identifying the protocol version (1.0).</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.14.0<br>
Last updated 2023-10-26 10:17:36 UTC
</div>
</div>
</body>
</html>