<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>RabbitMQ Stream Java Client</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>RabbitMQ Stream Java Client</h1>
<div class="details">
<span id="revnumber">version 0.1.0-SNAPSHOT</span>
<br><span id="revremark">(9af4f01)</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#what-is-a-rabbitmq-stream">What is a RabbitMQ Stream?</a></li>
<li><a href="#when-to-use-rabbitmq-stream">When to Use RabbitMQ Stream?</a></li>
<li><a href="#other-way-to-use-streams-in-rabbitmq">Other Way to Use Streams in RabbitMQ</a></li>
<li><a href="#guarantees">Guarantees</a></li>
<li><a href="#stream-client-overview">Stream Client Overview</a></li>
<li><a href="#the-stream-java-client">The Stream Java Client</a>
<ul class="sectlevel2">
<li><a href="#setting-up-rabbitmq">Setting up RabbitMQ</a>
<ul class="sectlevel3">
<li><a href="#with-docker">With Docker</a></li>
<li><a href="#with-the-generic-unix-package">With the Generic Unix Package</a></li>
</ul>
</li>
<li><a href="#dependencies">Dependencies</a>
<ul class="sectlevel3">
<li><a href="#maven">Maven</a></li>
<li><a href="#gradle">Gradle</a></li>
</ul>
</li>
<li><a href="#sample-application">Sample Application</a></li>
<li><a href="#rabbitmq-stream-java-api">RabbitMQ Stream Java API</a>
<ul class="sectlevel3">
<li><a href="#overview">Overview</a></li>
<li><a href="#environment">Environment</a>
<ul class="sectlevel4">
<li><a href="#creating-the-environment">Creating the Environment</a></li>
<li><a href="#managing-streams">Managing Streams</a></li>
</ul>
</li>
<li><a href="#producer">Producer</a>
<ul class="sectlevel4">
<li><a href="#creating-a-producer">Creating a Producer</a></li>
<li><a href="#sending-messages">Sending Messages</a></li>
<li><a href="#working-with-complex-messages">Working with Complex Messages</a></li>
</ul>
</li>
<li><a href="#consumer">Consumer</a>
<ul class="sectlevel4">
<li><a href="#creating-a-consumer">Creating a Consumer</a></li>
<li><a href="#specifying-an-offset">Specifying an Offset</a></li>
<li><a href="#consumer-offset-tracking">Tracking the Offset for a Consumer</a>
<ul class="sectlevel5">
<li><a href="#automatic-offset-commit">Automatic Offset Commit</a></li>
<li><a href="#manual-offset-commit">Manual Offset Commit</a></li>
<li><a href="#considerations-on-offset-tracking">Considerations On Offset Tracking</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#building-the-client">Building the Client</a></li>
</ul>
</li>
<li><a href="#the-performance-tool">The Performance Tool</a>
<ul class="sectlevel2">
<li><a href="#using-the-performance-tool">Using the Performance Tool</a>
<ul class="sectlevel3">
<li><a href="#with-docker-2">With Docker</a>
<ul class="sectlevel4">
<li><a href="#with-docker-host-network-driver">With Docker Host Network Driver</a></li>
<li><a href="#with-docker-bridge-network-driver">With Docker Bridge Network Driver</a></li>
</ul>
</li>
<li><a href="#with-the-java-binary">With the Java Binary</a></li>
<li><a href="#common-usage">Common Usage</a>
<ul class="sectlevel4">
<li><a href="#connection">Connection</a></li>
<li><a href="#publishing-rate">Publishing Rate</a></li>
<li><a href="#number-of-producers-and-consumers">Number of Producers and Consumers</a></li>
<li><a href="#streams">Streams</a></li>
<li><a href="#publishing-batch-size">Publishing Batch Size</a></li>
<li><a href="#unconfirmed-messages">Unconfirmed Messages</a></li>
<li><a href="#message-size">Message Size</a></li>
</ul>
</li>
<li><a href="#advanced-usage">Advanced Usage</a>
<ul class="sectlevel4">
<li><a href="#retention">Retention</a></li>
<li><a href="#offset-consumer">Offset (Consumer)</a></li>
<li><a href="#offset-tracking-consumer">Offset Tracking (Consumer)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#building-the-performance-tool">Building the Performance Tool</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The RabbitMQ Stream Java Client is a Java library to communicate with
the <a href="https://github.com/rabbitmq/rabbitmq-stream">RabbitMQ Stream Plugin</a>.
It allows creating and deleting streams, as well as publishing to and consuming from
these streams. Learn more in the <a href="#stream-client-overview">the client overview</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-a-rabbitmq-stream"><a class="anchor" href="#what-is-a-rabbitmq-stream"></a>What is a RabbitMQ Stream?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A RabbitMQ stream is a persistent and replicated data structure that models
an <a href="https://en.wikipedia.org/wiki/Append-only">append-only log</a>. It differs from the classical
RabbitMQ queue in the way message consumption works. In a classical RabbitMQ queue,
consuming removes messages from the queue. In a RabbitMQ stream, consuming leaves
the stream intact. So the content of a stream can be read and re-read without
impact or destructive effect.</p>
</div>
<div class="paragraph">
<p>None of the stream or classical queue data structure is better than the other,
they are usually suited for different use cases.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="when-to-use-rabbitmq-stream"><a class="anchor" href="#when-to-use-rabbitmq-stream"></a>When to Use RabbitMQ Stream?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RabbitMQ Stream was developed to cover the following messaging use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Large fan-outs:</em> when several consumer applications need to read the same messages.</p>
</li>
<li>
<p><em>Replay / Time-traveling:</em> when consumer applications need to read the whole
history of data or from a given point in a stream.</p>
</li>
<li>
<p><em>Throughput performance:</em> when higher throughput than with other protocols
(AMQP, STOMP, MQTT) is required.</p>
</li>
<li>
<p><em>Large logs:</em> when large amount of data need to be stored, with minimal
in-memory overhead.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="other-way-to-use-streams-in-rabbitmq"><a class="anchor" href="#other-way-to-use-streams-in-rabbitmq"></a>Other Way to Use Streams in RabbitMQ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is also possible to use the stream abstraction in RabbitMQ
with the AMQP 0-9-1 protocol. Instead of consuming from a stream
with the stream protocol, one consumes from a "stream-powered" queue with
the AMQP 0-9-1 protocol. A "stream-powered" queue is a special type of queue that
is backed up with a stream infrastructure layer and adapted to
provide the stream semantics (mainly non-destructive reading).</p>
</div>
<div class="paragraph">
<p>Using such a queue has the advantage to provide the features
inherent to the stream abstraction (append-only structure, non-destructive
reading) with any AMQP 0-9-1 client library. This is clearly
interesting when considering the maturity of AMQP 0-9-1 client libraries
and the ecosystem around AMQP 0-9-1.</p>
</div>
<div class="paragraph">
<p>But by using it, one does not benefit from the performance
of the stream protocol, which has been designed for performance in mind,
whereas AMQP 0-9-1 is a more general-purpose protocol.</p>
</div>
<div class="paragraph">
<p>It is not possible to use "stream-powered" queues with the stream Java client,
you need to use an AMQP 0-9-1 client library.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="guarantees"><a class="anchor" href="#guarantees"></a>Guarantees</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RabbitMQ stream provides at-least-once guarantees thanks to the
publisher confirm mechanism, which is supported by the stream Java client.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stream-client-overview"><a class="anchor" href="#stream-client-overview"></a>Stream Client Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The RabbitMQ Stream Java Client implements the
<a href="https://github.com/rabbitmq/rabbitmq-stream/blob/master/docs/PROTOCOL.adoc">RabbitMQ Stream protocol</a>
and avoids dealing with low-level concerns by providing high-level functionalities
to build fast, efficient, and robust client applications.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>administrate streams (creation/deletion) directly from applications.</em> This
can also be useful for development and testing.</p>
</li>
<li>
<p><em>adapt publishing throughput</em> thanks to the configurable batch size and flow control.</p>
</li>
<li>
<p><em>consume asynchronously from streams and resume where left off</em> thanks to
automatic or manual offset tracking.</p>
</li>
<li>
<p><em>use cluster nodes appropriately</em> by letting the client decide which node to connect to - to
stream leaders for publishers to avoid network traffic and to stream replicas
for consumers to offload leaders.</p>
</li>
<li>
<p><em>optimize resources</em> thanks to automatic growing and shrinking of
connections depending on the number of publishers and consumers.</p>
</li>
<li>
<p><em>let the client handle network failure</em> thanks to automatic connection
recovery and automatic re-subscription for consumers.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-stream-java-client"><a class="anchor" href="#the-stream-java-client"></a>The Stream Java Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The library requires Java 8 or more.</p>
</div>
<div class="sect2">
<h3 id="setting-up-rabbitmq"><a class="anchor" href="#setting-up-rabbitmq"></a>Setting up RabbitMQ</h3>
<div class="paragraph">
<p>A RabbitMQ node with the stream plugin enabled is required. The easiest way
to get up and running is to use Docker. It is also possible to use the
generic Unix package.</p>
</div>
<div class="sect3">
<h4 id="with-docker"><a class="anchor" href="#with-docker"></a>With Docker</h4>
<div class="paragraph">
<p>The following command creates a one-time Docker container to run RabbitMQ
with the stream plugin enabled:</p>
</div>
<div class="listingblock">
<div class="title">Running the stream plugin with Docker</div>
<div class="content">
<pre>docker run -it --rm --name rabbitmq -p 5555:5555 pivotalrabbitmq/rabbitmq-stream</pre>
</div>
</div>
<div class="paragraph">
<p>The previous command exposes only the stream port (5555), you can expose
ports for other protocols:</p>
</div>
<div class="listingblock">
<div class="title">Exposing the AMQP 0.9.1 and management ports:</div>
<div class="content">
<pre>docker run -it --rm --name rabbitmq -p 5555:5555 -p 5672:5672 -p 15672:15672 \
    pivotalrabbitmq/rabbitmq-stream</pre>
</div>
</div>
<div class="paragraph">
<p>Refer to the official <a href="https://hub.docker.com/_/rabbitmq">RabbitMQ Docker image web page</a>
to find out more about its usage. Make sure to use the <code>pivotalrabbitmq/rabbitmq-stream</code>
image in the command line.</p>
</div>
<div class="paragraph">
<p>The <code>pivotalrabbitmq/rabbitmq-stream</code> Docker image is meant for development usage only. It does not
support all the features of the official Docker image, like TLS.</p>
</div>
</div>
<div class="sect3">
<h4 id="with-the-generic-unix-package"><a class="anchor" href="#with-the-generic-unix-package"></a>With the Generic Unix Package</h4>
<div class="paragraph">
<p>The generic Unix package requires <a href="https://www.rabbitmq.com/which-erlang.html">Erlang</a> to be installed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download the <a href="https://bintray.com/rabbitmq/all-dev/rabbitmq-stream">latest generic Unix alpha from Bintray</a>.</p>
</li>
<li>
<p>Follow the <a href="https://www.rabbitmq.com/install-generic-unix.html">instructions to install the generic Unix package</a>.</p>
</li>
<li>
<p>Enable the plugin <code>./rabbitmq-plugins enable rabbitmq_stream</code>.</p>
</li>
<li>
<p>Start the broker <code>./rabbitmq-server -detached</code>. This starts the stream listener on port 5555.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dependencies"><a class="anchor" href="#dependencies"></a>Dependencies</h3>
<div class="paragraph">
<p>Use your favorite build management tool to add the client dependencies to your project.</p>
</div>
<div class="paragraph">
<p>Note the client uses the <a href="https://github.com/apache/qpid-proton-j">Apache QPid Proton-J</a>
library for <a href="#working-with-complex-messages">AMQP 1.0 message encoding and decoding</a>.</p>
</div>
<div class="sect3">
<h4 id="maven"><a class="anchor" href="#maven"></a>Maven</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>

  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.rabbitmq<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>stream-client<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>0.1.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>

  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.qpid<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>proton-j<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>0.33.7<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>

<span class="tag">&lt;/dependencies&gt;</span>

<span class="tag">&lt;repositories&gt;</span>

  <span class="tag">&lt;repository&gt;</span>
    <span class="tag">&lt;id&gt;</span>ossrh<span class="tag">&lt;/id&gt;</span>
    <span class="tag">&lt;url&gt;</span>https://oss.sonatype.org/content/repositories/snapshots<span class="tag">&lt;/url&gt;</span>
    <span class="tag">&lt;snapshots&gt;</span><span class="tag">&lt;enabled&gt;</span>true<span class="tag">&lt;/enabled&gt;</span><span class="tag">&lt;/snapshots&gt;</span>
    <span class="tag">&lt;releases&gt;</span><span class="tag">&lt;enabled&gt;</span>false<span class="tag">&lt;/enabled&gt;</span><span class="tag">&lt;/releases&gt;</span>
  <span class="tag">&lt;/repository&gt;</span>

<span class="tag">&lt;/repositories&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="gradle"><a class="anchor" href="#gradle"></a>Gradle</h4>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
  compile <span class="string"><span class="delimiter">&quot;</span><span class="content">com.rabbitmq:stream-client:0.1.0-SNAPSHOT</span><span class="delimiter">&quot;</span></span>
  compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.qpid:proton-j:0.33.7</span><span class="delimiter">&quot;</span></span>
}

repositories {
  maven { url <span class="string"><span class="delimiter">'</span><span class="content">https://oss.sonatype.org/content/repositories/snapshots</span><span class="delimiter">'</span></span> }
  mavenCentral()
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-application"><a class="anchor" href="#sample-application"></a>Sample Application</h3>
<div class="paragraph">
<p>This section covers the basics of the RabbitMQ Stream Java API by building
a small publish/consume application. This is a good way to get
an overview of the API. If you want a more comprehensive introduction,
you can go to the <a href="#rabbitmq-stream-java-api">the reference documentation section</a>.</p>
</div>
<div class="paragraph">
<p>The sample application publishes some messages and then registers
a consumer to make some computations out of them. The
<a href="https://github.com/rabbitmq/rabbitmq-stream-java-client/blob/master/src/test/java/com/rabbitmq/stream/docs/SampleApplication.java">source code is available on GitHub</a>.</p>
</div>
<div class="paragraph">
<p>The sample class starts with a few imports:</p>
</div>
<div class="listingblock">
<div class="title">Imports for the sample application</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.rabbitmq.stream</span>.*;
<span class="keyword">import</span> <span class="include">java.util.UUID</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.CountDownLatch</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.TimeUnit</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.atomic.AtomicLong</span>;
<span class="keyword">import</span> <span class="include">java.util.stream.IntStream</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to create the <code>Environment</code>. It is a management object
used to manage streams and create producers as well as consumers. The
next snippet shows how to create an <code>Environment</code> instance and
create the stream used in the application:</p>
</div>
<div class="listingblock">
<div class="title">Creating the environment</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Connecting...</span><span class="delimiter">&quot;</span></span>);
Environment environment = Environment.builder().build();  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">String</span> stream = <span class="predefined-type">UUID</span>.randomUUID().toString();
environment.streamCreator().stream(stream).create();  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>Environment#builder</code> to create the environment</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create the stream</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then comes the publishing part. The next snippet shows how to create
a <code>Producer</code>, send messages, and handle publishing confirmations, to
make sure the broker has taken outbound messages into account.
The application uses a count down latch to move on once the messages
have been confirmed.</p>
</div>
<div class="listingblock">
<div class="title">Publishing messages</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Starting publishing...</span><span class="delimiter">&quot;</span></span>);
<span class="type">int</span> messageCount = <span class="integer">10000</span>;
<span class="predefined-type">CountDownLatch</span> publishConfirmLatch = <span class="keyword">new</span> <span class="predefined-type">CountDownLatch</span>(messageCount);
Producer producer = environment.producerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(stream)
        .build();
IntStream.range(<span class="integer">0</span>, messageCount)
        .forEach(i -&gt; producer.send(  <i class="conum" data-value="2"></i><b>(2)</b>
                producer.messageBuilder()                    <i class="conum" data-value="3"></i><b>(3)</b>
                    .addData(<span class="predefined-type">String</span>.valueOf(i).getBytes())   <i class="conum" data-value="3"></i><b>(3)</b>
                    .build(),                                <i class="conum" data-value="3"></i><b>(3)</b>
                confirmationStatus -&gt; publishConfirmLatch.countDown()  <i class="conum" data-value="4"></i><b>(4)</b>
        ));
publishConfirmLatch.await(<span class="integer">10</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);  <i class="conum" data-value="5"></i><b>(5)</b>
producer.close();  <i class="conum" data-value="6"></i><b>(6)</b>
<span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Published %,d messages%n</span><span class="delimiter">&quot;</span></span>, messageCount);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>Producer</code> with <code>Environment#producerBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Send messages with <code>Producer#send(Message, ConfirmationHandler)</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a message with <code>Producer#messageBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Count down on message publishing confirmation</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Wait for all publishing confirmations to have arrived</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Close the producer</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is now time to consume the messages. The <code>Environment</code> lets us create a <code>Consumer</code>
and provide some logic on each incoming message by implementing a <code>MessageHandler</code>.
The next snippet does this to calculate a sum and output it once all the messages
have been received:</p>
</div>
<div class="listingblock">
<div class="title">Consuming messages</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Starting consuming...</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">AtomicLong</span> sum = <span class="keyword">new</span> <span class="predefined-type">AtomicLong</span>(<span class="integer">0</span>);
<span class="predefined-type">CountDownLatch</span> consumeLatch = <span class="keyword">new</span> <span class="predefined-type">CountDownLatch</span>(messageCount);
Consumer consumer = environment.consumerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(stream)
        .messageHandler((offset, message) -&gt; {  <i class="conum" data-value="2"></i><b>(2)</b>
            sum.addAndGet(<span class="predefined-type">Long</span>.parseLong(<span class="keyword">new</span> <span class="predefined-type">String</span>(message.getBodyAsBinary())));  <i class="conum" data-value="3"></i><b>(3)</b>
            consumeLatch.countDown();  <i class="conum" data-value="4"></i><b>(4)</b>
        })
        .build();

consumeLatch.await(<span class="integer">10</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);  <i class="conum" data-value="5"></i><b>(5)</b>

<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Sum: </span><span class="delimiter">&quot;</span></span> + sum.get());  <i class="conum" data-value="6"></i><b>(6)</b>

consumer.close();  <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>Consumer</code> with <code>Environment#consumerBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set up the logic to handle messages</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the value in the message body to the sum</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Count down on each message</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Wait for all messages to have arrived</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Output the sum</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Close the consumer</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The application has some cleaning to do before terminating, that is
deleting the stream and closing the environment:</p>
</div>
<div class="listingblock">
<div class="title">Cleaning before terminating</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.deleteStream(stream);  <i class="conum" data-value="1"></i><b>(1)</b>
environment.close();  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Delete the stream</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Close the environment</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can run the sample application from the root of the project (you need
a running local RabbitMQ node with the stream plugin enabled):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./mvnw -q test-compile exec:java -Dexec.classpathScope="test" \
    -Dexec.mainClass="com.rabbitmq.stream.docs.SampleApplication"
Starting publishing...
Published 10000 messages
Starting consuming...
Sum: 49995000</pre>
</div>
</div>
<div class="paragraph">
<p>You can remove the <code>-q</code> flag if you want more insight on the execution of the build.</p>
</div>
</div>
<div class="sect2">
<h3 id="rabbitmq-stream-java-api"><a class="anchor" href="#rabbitmq-stream-java-api"></a>RabbitMQ Stream Java API</h3>
<div class="sect3">
<h4 id="overview"><a class="anchor" href="#overview"></a>Overview</h4>
<div class="paragraph">
<p>This section describes the API to connect to the RabbitMQ Stream Plugin, publish messages, and
consume messages. There are 3 main interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.rabbitmq.stream.Environment</code> for connecting to a node and optionally
managing streams.</p>
</li>
<li>
<p><code>com.rabbitmq.stream.Producer</code> to publish messages.</p>
</li>
<li>
<p><code>com.rabbitmq.stream.Consumer</code> to consume messages.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="environment"><a class="anchor" href="#environment"></a>Environment</h4>
<div class="sect4">
<h5 id="creating-the-environment"><a class="anchor" href="#creating-the-environment"></a>Creating the Environment</h5>
<div class="paragraph">
<p>The environment is the main entry point to a node or a cluster of nodes. <code>Producer</code> and
<code>Consumer</code> instances are created from an <code>Environment</code> instance. Here is the simplest
way to create an <code>Environment</code> instance:</p>
</div>
<div class="listingblock">
<div class="title">Creating an environment with all the defaults</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder().build();  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="comment">// ...</span>
environment.close(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create an environment that will connect to localhost:5555</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Close the environment after usage</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the environment must be closed to release resources when it is no
longer needed.</p>
</div>
<div class="paragraph">
<p>Consider the environment like a long-lived object. An application will usually
create one <code>Environment</code> instance when it starts up and close it when it exits.</p>
</div>
<div class="paragraph">
<p>It is possible to use a URI to specify all the necessary information to
connect to a node:</p>
</div>
<div class="listingblock">
<div class="title">Creating an environment with a URI</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder()
        .uri(<span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://guest:guest@localhost:5555/%2f</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>uri</code> method to specify the URI to connect to</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous snippet uses a URI that specifies the following information: host, port,
username, password, and virtual host (<code>/</code>, which is encoded as <code>%2f</code>).
The URI follows the same rules as the
<a href="https://www.rabbitmq.com/uri-spec.html">AMQP 0.9.1 URI</a>,
except the protocol must be <code>rabbitmq-stream</code> and TLS is not supported.</p>
</div>
<div class="paragraph">
<p>When using one URI, the corresponding node will be the main entry point to connect to. The
<code>Environment</code> will then use the stream protocol to find out more about streams topology
(leaders and replicas) when asked to create <code>Producer`s and `Consumer`s. The `Environment</code>
may become blind if this node goes down though, so it may be more appropriate to specify
several other URIs to try in case of failure of a node:</p>
</div>
<div class="listingblock">
<div class="title">Creating an environment with several URIs</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder()
        .uris(<span class="predefined-type">Arrays</span>.asList(                     <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://host1:5555</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://host2:5555</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://host3:5555</span><span class="delimiter">&quot;</span></span>)
        )
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>uris</code> method to specify several URIs</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By specifying several URIs, the environment will try to connect to the first one, and
will pick a new URI randomly in case of disconnection.</p>
</div>
<div class="paragraph">
<p>The following table sums up the main settings to create a <code>Environment</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uri</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URI of the node to connect to (single node).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rabbitmq-stream://guest:guest@localhost:5555/%2f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uris</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URI of the nodes to try to connect to (cluster).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rabbitmq-stream://guest:guest@localhost:5555/%2f</code> singleton list</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>host</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Host to connect to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>localhost</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port to use.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5555</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>username</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use to connect.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>guest</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use to connect.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>guest</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtualHost</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtual host to connect to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>recoveryBackOffDelayPolicy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delay policy to use for backoff on connection recovery.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed delay of 5 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topologyUpdateBackOffDelayPolicy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delay policy to use for backoff on topology update, e.g.
when a stream replica moves and a consumer needs to connect to another
node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initial delay of 5 seconds then delay of 1 second.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scheduledExecutorService</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executor used to schedule infrastructure tasks like background publishing, producers
and consumers migration after disconnection or topology update. If a custom executor is provided,
it is the developer&#8217;s responsibility to close it once it is no longer necessary.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Executors</span>
  .newScheduledThreadPool(
    <span class="predefined-type">Runtime</span>
      .getRuntime()
      .availableProcessors()
);</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="managing-streams"><a class="anchor" href="#managing-streams"></a>Managing Streams</h5>
<div class="paragraph">
<p>Streams are usually long-lived, centrally-managed entities, that is, applications
are not supposed to create and delete them. It is nevertheless possible to create and
delete stream with the <code>Environment</code>. This comes in handy for development and testing
purposes.</p>
</div>
<div class="paragraph">
<p>Streams are created with the <code>Environment#streamCreator()</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Creating a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.streamCreator().stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>).create();  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>my-stream</code> stream</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Streams can be deleted with the <code>Environment#delete(String)</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Deleting a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.deleteStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>);  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Delete the <code>my-stream</code> stream</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note you should avoid stream churn (creating and deleting streams repetitively)
as their creation and deletion imply some significant housekeeping on
the server side (interactions with the file system, communication between nodes of the cluster).</p>
</div>
<div class="paragraph">
<p><a id="limiting-the-size-of-a-stream"></a>It is also possible to limit the size of a stream
when creating it. A stream
is an append-only data structure and reading from it does not remove data.
This means a stream can grow indefinitely. RabbitMQ Stream supports a
size-based and time-based retention policies: once the stream reaches a given size
or a given age, it is truncated (starting from the beginning).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Limit the size of streams if appropriate!</div>
<div class="paragraph">
<p>Make sure to set up a retention policy on potentially large streams
if you don&#8217;t want to saturate the storage devices of your servers. Keep
in mind that this means some data will be erased!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to set up the retention policy when creating the stream:</p>
</div>
<div class="listingblock">
<div class="title">Setting the retention policy when creating a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.streamCreator()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .maxLengthBytes(ByteCapacity.GB(<span class="integer">10</span>))  <i class="conum" data-value="1"></i><b>(1)</b>
        .maxSegmentSizeBytes(ByteCapacity.MB(<span class="integer">500</span>))  <i class="conum" data-value="2"></i><b>(2)</b>
        .create();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the maximum size to 10 GB</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the segment size to 500 MB</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous snippet mentions a segment size. RabbitMQ Stream does not store a stream
in a big, single file, it uses segment files for technical reasons.
A stream is truncated by deleting whole segment files (and not part of them)so
the maximum size of a stream is usually significantly higher than the size of
segment files. 500 MB is a reasonable segment file size to begin with.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">When does the broker enforce the retention policy?</div>
<div class="paragraph">
<p>The broker enforces the retention policy when the segments of a stream
roll over, that is when the current segment has reached its maximum
size and is closed in favor of a new one. This means the maximum segment
size is a critical setting in the retention mechanism.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>RabbitMQ Stream also supports a time-based retention policy: segments get truncated
when they reach a certain age. The following snippet
illustrates how to set the time-based retention policy:</p>
</div>
<div class="listingblock">
<div class="title">Setting a time-based retention policy when creating a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.streamCreator()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .maxAge(<span class="predefined-type">Duration</span>.ofHours(<span class="integer">6</span>))  <i class="conum" data-value="1"></i><b>(1)</b>
        .maxSegmentSizeBytes(ByteCapacity.MB(<span class="integer">500</span>))  <i class="conum" data-value="2"></i><b>(2)</b>
        .create();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the maximum age to 6 hours</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the segment size to 500 MB</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="producer"><a class="anchor" href="#producer"></a>Producer</h4>
<div class="sect4">
<h5 id="creating-a-producer"><a class="anchor" href="#creating-a-producer"></a>Creating a Producer</h5>
<div class="paragraph">
<p>A <code>Producer</code> instance is created from the <code>Environment</code>. The only mandatory
setting to specify is the stream to publish to:</p>
</div>
<div class="listingblock">
<div class="title">Creating a producer from the environment</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
        .build();  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="comment">// ...</span>
producer.close();  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>Environment#producerBuilder()</code> to define the producer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specify the stream to publish to</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the producer instance with <code>build()</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Close the producer after usage</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider a <code>Producer</code> instance like a long-lived object, do not create one
to send just one message.</p>
</div>
<div class="paragraph">
<p>Internally, the <code>Environment</code> will query the broker to find out about
the topology of the stream and will create or re-use a connection to
publish to the leader node of the stream.</p>
</div>
<div class="paragraph">
<p>The following table sums up the main settings to create a <code>Producer</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>batchSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of messages to accumulate before sending them to the broker.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>subEntrySize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of messages to put in a sub-entry. A sub-entry is one "slot" in a publishing
frame, meaning outbound messages are not only batched in publishing frames, but in sub-entries
as well. Use this feature to increase throughput at the cost of increased latency.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 (meaning no use of sub-entry batching)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxUnconfirmedMessages</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of unconfirmed outbound messages. <code>Producer#send</code> will start
blocking when the limit is reached.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10,000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>batchPublishingDelay</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Period to send a batch of messages.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 ms</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="sending-messages"><a class="anchor" href="#sending-messages"></a>Sending Messages</h5>
<div class="paragraph">
<p>Once a <code>Producer</code> has been created, it is possible to send a message with
the <code>Producer#send(Message, ConfirmationHandler)</code> method. The following
snippet shows how to publish a message with a byte array payload:</p>
</div>
<div class="listingblock">
<div class="title">Sending a message</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">byte</span><span class="type">[]</span> messagePayload = <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>.getBytes(StandardCharsets.UTF_8);  <i class="conum" data-value="1"></i><b>(1)</b>
producer.send(
        producer.messageBuilder().addData(messagePayload).build(),  <i class="conum" data-value="2"></i><b>(2)</b>
        confirmationStatus -&gt; {  <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="keyword">if</span> (confirmationStatus.isConfirmed()) {
                <span class="comment">// the message made it to the broker</span>
            } <span class="keyword">else</span> {
                <span class="comment">// the message did not make it to the broker</span>
            }
        });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The payload of a message is an array of bytes</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create the message with <code>Producer#messageBuilder()</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the behavior on publish confirmation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Messages are not only made of a <code>byte[]</code> payload, we will see in
<a href="#working-with-complex-messages">the next section</a>
they can also carry pre-defined and application properties.</p>
</div>
<div class="paragraph">
<p>The <code>ConfirmationHandler</code> defines an asynchronous callback invoked
when the client received from the broker the confirmation the message
has been taken into account. The <code>ConfirmationHandler</code> is the place
for any logic on publishing confirmation, including
re-publishing the message if it is negatively acknowledged.</p>
</div>
</div>
<div class="sect4">
<h5 id="working-with-complex-messages"><a class="anchor" href="#working-with-complex-messages"></a>Working with Complex Messages</h5>
<div class="paragraph">
<p>The publishing example above showed that messages are made of
a byte array payload, but it did not go much further. Messages in RabbitMQ Stream
can actually be more sophisticated, as they comply to the
<a href="https://www.amqp.org/resources/specifications">AMQP 1.0 message format</a>.</p>
</div>
<div class="paragraph">
<p>In a nutshell, a message in RabbitMQ Stream has the following structure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>properties: <em>a defined set of standard properties of the message</em> (e.g.
message ID, correlation ID, content type, etc).</p>
</li>
<li>
<p>application properties: a set of arbitrary key/value pairs.</p>
</li>
<li>
<p>body: typically an array of bytes.</p>
</li>
<li>
<p>message annotations: a set of key/value pairs (aimed at the infrastructure).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The RabbitMQ Stream Java client uses the <code>Message</code> interface to abstract
a message and the recommended way to create <code>Message</code> instances is to
use the <code>Producer#messageBuilder()</code> method. To publish a <code>Message</code>, use
the <code>Producer#send(Message,ConfirmationHandler)</code>:</p>
</div>
<div class="listingblock">
<div class="title">Creating a message with properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Message message = producer.messageBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .properties()  <i class="conum" data-value="2"></i><b>(2)</b>
            .messageId(<span class="predefined-type">UUID</span>.randomUUID())
            .correlationId(<span class="predefined-type">UUID</span>.randomUUID())
            .contentType(<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>)
        .messageBuilder()  <i class="conum" data-value="3"></i><b>(3)</b>
            .addData(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>.getBytes(StandardCharsets.UTF_8))  <i class="conum" data-value="4"></i><b>(4)</b>
        .build();  <i class="conum" data-value="5"></i><b>(5)</b>
producer.send(message, confirmationStatus -&gt; { }); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the message builder from the producer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the properties builder and set some properties</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Go back to message builder</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set byte array payload</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Build the message instance</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Publish the message</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Is RabbitMQ Stream based on AMQP 1.0?</div>
<div class="paragraph">
<p>AMQP 1.0 is a standard that defines <em>an efficient binary peer-to-peer
protocol for transporting messages between two processes over a network</em>.
It also defines <em>an abstract message format, with concrete standard encoding</em>.
This is only the latter part that RabbitMQ Stream uses. The AMQP 1.0 protocol is not used,
only AMQP 1.0 encoded messages are wrapped into the RabbitMQ Stream binary protocol.</p>
</div>
<div class="paragraph">
<p>The actual AMQP 1.0 message encoding and decoding happen on the client side, the
RabbitMQ Stream plugin stores only bytes, it has no idea that AMQP 1.0 message format
is used.</p>
</div>
<div class="paragraph">
<p>AMQP 1.0 message format was chosen because of its flexibility and its advanced
type system. It provides good interoperability, which allows streams
to be accessed as AMQP 0-9-1 queues, without data loss.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="consumer"><a class="anchor" href="#consumer"></a>Consumer</h4>
<div class="paragraph">
<p><code>Consumer</code> is the API to consume messages from a stream.</p>
</div>
<div class="sect4">
<h5 id="creating-a-consumer"><a class="anchor" href="#creating-a-consumer"></a>Creating a Consumer</h5>
<div class="paragraph">
<p>A <code>Consumer</code> instance is created with <code>Environment#consumerBuilder()</code>. The main
settings are the stream to consume from, the place in the stream to start
consuming from (the <em>offset</em>), and a callback when a message is received
(the <code>MessageHandler</code>). The next snippet shows how to create a <code>Consumer</code>:</p>
</div>
<div class="listingblock">
<div class="title">Creating a consumer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
        .offset(OffsetSpecification.first())  <i class="conum" data-value="3"></i><b>(3)</b>
        .messageHandler((offset, message) -&gt; {
            message.getBodyAsBinary(); <i class="conum" data-value="4"></i><b>(4)</b>
        })
        .build();  <i class="conum" data-value="5"></i><b>(5)</b>
<span class="comment">// ...</span>
consumer.close();  <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>Environment#consumerBuilder()</code> to define the consumer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specify the stream to consume from</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify where to start consuming from</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define behavior on message consumption</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Build the consumer</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Close consumer after usage</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The broker start sending messages as soon as the <code>Consumer</code> instance is created.</p>
</div>
</div>
<div class="sect4">
<h5 id="specifying-an-offset"><a class="anchor" href="#specifying-an-offset"></a>Specifying an Offset</h5>
<div class="paragraph">
<p>The offset is the place in the stream where the consumer starts consuming from.
The possible values for the offset parameter are the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>OffsetSpecification.first()</code>: starting from the first available offset. If
the stream has not been <a href="#limiting-the-size-of-a-stream">truncated</a>, this
means the beginning of the stream (offset 0).</p>
</li>
<li>
<p><code>OffsetSpecification.last()</code>: starting from the end of the stream and returning
the last <a href="#chunk-definition">chunk</a> of messages immediately (if the stream is not empty).</p>
</li>
<li>
<p><code>OffsetSpecification.next()</code>: starting from the next offset to be written. Contrary
to <code>OffsetSpecification.last()</code>, consuming with <code>OffsetSpecification.next()</code>
will not return anything if no-one is publishing to the stream. The broker will start
sending messages to the consumer when messages are published to the stream.</p>
</li>
<li>
<p><code>OffsetSpecification.offset(offset)</code>: starting from the specified offset. 0 means consuming
from the beginning of the stream (first messages). The client
can also specify any number, for example the offset where it left off
in a previous incarnation of the application.</p>
</li>
<li>
<p><code>OffsetSpecification.timestamp(timestamp)</code>: starting from the messages stored
after the specified timestamp.</p>
</li>
</ul>
</div>
<div id="chunk-definition" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">What is a chunk of messages?</div>
<div class="paragraph">
<p>A chunk is simply a batch of messages. This is the storage and transportation
unit used in RabbitMQ Stream, that is messages are stored contiguously in a chunk
and they are delivered as part of a chunk. A chunk can be made of one to several
thousands of messages, depending on the ingress.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="consumer-offset-tracking"><a class="anchor" href="#consumer-offset-tracking"></a>Tracking the Offset for a Consumer</h5>
<div class="paragraph">
<p>A consumer can track the offset it has reached in a stream. This allows a new incarnation
of the consumer to restart consuming where it left off. Offset tracking works in 2 steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the consumer must have a <strong>name</strong>. The name is set with <code>ConsumerBuilder#name(String)</code>. The name
can be any value (under 256 characters) and is expected to be unique (from the application
point of view). Note neither the client library, nor the broker
enforces uniqueness of the name: if 2 <code>Consumer</code> Java instances share the same name, their
offset tracking will likely be interleaved, which applications usually do not expect.</p>
</li>
<li>
<p>the consumer must periodically <strong>commit the offset</strong> it has reached so far. The way
offsets are committed depends on the commit strategy: automatic or manual.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Whatever commit strategy you use, <strong>a consumer must have a name to be able to commit offsets</strong>.</p>
</div>
<div class="sect5">
<h6 id="automatic-offset-commit"><a class="anchor" href="#automatic-offset-commit"></a>Automatic Offset Commit</h6>
<div class="paragraph">
<p>The following snippet shows how to enable automatic commit with the defaults:</p>
</div>
<div class="listingblock">
<div class="title">Using automatic commit strategy with the defaults</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .autoCommitStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use automatic commit strategy with defaults</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The automatic commit strategy has the following available settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>message count before commit</strong>: the client will commit the offset
after the specified number of messages, right after the execution
of the message handler. <em>The default is every 10,000 messages</em>.</p>
</li>
<li>
<p><strong>flush interval</strong>: the client will make sure to commit the last received offset
at the specified interval. This avoids having pending, not committed offsets in
case of inactivity. <em>The default is 5 seconds</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those settings are configurable, as shown in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Configuring the automatic commit strategy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .autoCommitStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
            .messageCountBeforeCommit(<span class="integer">50</span>_000)   <i class="conum" data-value="3"></i><b>(3)</b>
            .flushInterval(<span class="predefined-type">Duration</span>.ofSeconds(<span class="integer">10</span>))   <i class="conum" data-value="4"></i><b>(4)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use automatic commit strategy</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Commit every 50,000 messages</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Make sure to commit offset at least every 10 seconds</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the automatic commit is the default commit strategy, so if you are fine
with its defaults, it is enabled as soon as you specify a name
for the consumer:</p>
</div>
<div class="listingblock">
<div class="title">Setting only the consumer name to enable automatic commit</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set only the consumer name to enable automatic commit with defaults</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Automatic commit is simple and provides good guarantees. It is nevertheless
possible to have more fine-grained control over offset commit by using
manual commit.</p>
</div>
</div>
<div class="sect5">
<h6 id="manual-offset-commit"><a class="anchor" href="#manual-offset-commit"></a>Manual Offset Commit</h6>
<div class="paragraph">
<p>The manual commit strategy lets the developer in charge of committing offsets
whenever they want, not only after a given number of messages has been received
and supposedly processed, like automatic commit does.</p>
</div>
<div class="paragraph">
<p>The following snippet shows how to enable manual commit and how to commit
the offset at some point:</p>
</div>
<div class="listingblock">
<div class="title">Using manual commit with defaults</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .manualCommitStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>

          <span class="keyword">if</span> (conditionToCommit()) {
            context.commit();   <i class="conum" data-value="3"></i><b>(3)</b>
          }
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use manual commit with defaults</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Commit at the current offset on some condition</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Manual commit has only one setting: the <strong>check interval</strong>. The client checks
that the last requested committed offset has been actually committed at the
specified interval. <em>The default check interval is 5 seconds</em>.</p>
</div>
<div class="paragraph">
<p>The following snippet shows the configuration of manual commit:</p>
</div>
<div class="listingblock">
<div class="title">Configuring manual commit strategy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .manualCommitStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
            .checkInterval(<span class="predefined-type">Duration</span>.ofSeconds(<span class="integer">10</span>))   <i class="conum" data-value="3"></i><b>(3)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>

          <span class="keyword">if</span> (conditionToCommit()) {
            context.commit();   <i class="conum" data-value="4"></i><b>(4)</b>
          }
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use manual commit with defaults</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Check last requested offset every 10 seconds</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Commit at the current offset on some condition</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The snippet above uses <code>MessageHandler.Context#commit()</code> to commit at the
offset of the current message, but it is possible to commit anywhere
in the stream with <code>MessageHandler.Context#consumer()#commit(long)</code> or
simply <code>Consumer#commit(long)</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="considerations-on-offset-tracking"><a class="anchor" href="#considerations-on-offset-tracking"></a>Considerations On Offset Tracking</h6>
<div class="paragraph">
<p><em>When to commit offsets?</em> Avoid committing offsets too often or, worse, for each message.
Even though offset tracking is a small and fast operation, it will
make the stream grow unnecessarily, as the broker persists offset
tracking entries in the stream itself.</p>
</div>
<div class="paragraph">
<p>A good rule of thumb is to commit every few thousands
of messages. Of course, when the consumer will restart consuming in a new incarnation, the
last tracked offset may be a little behind the very last message the previous incarnation
actually processed, so the consumer may see some messages that have been already processed.</p>
</div>
<div class="paragraph">
<p>A solution to this problem is to make sure processing is idempotent or filter out the
last duplicated messages.</p>
</div>
<hr>
<div class="paragraph">
<p><em>Is the offset a reliable absolute value?</em> Message offsets may not be contiguous.
This implies that the message at offset 500 in a stream may
not be the 501 message in the stream (offsets start at 0).
There can be different types of entries in a stream storage, a message is
just one of them. For example, committing an offset creates an offset tracking
entry, which has its own offset.</p>
</div>
<div class="paragraph">
<p>This means one must be careful when basing some decision on offset values, like
a modulo to perform an operation every X messages. As the message offsets have
no guarantee to be contiguous, the operation may not happen exactly every X messages.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="building-the-client"><a class="anchor" href="#building-the-client"></a>Building the Client</h3>
<div class="paragraph">
<p>You need JDK 1.8 or more installed.</p>
</div>
<div class="paragraph">
<p>To build the JAR file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./mvnw clean package -DskipITs -DskipTests</pre>
</div>
</div>
<div class="paragraph">
<p>To launch the test suite (requires a local RabbitMQ node with stream plugin enabled):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./mvnw verify -Drabbitmqctl.bin=/path/to/rabbitmqctl</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-performance-tool"><a class="anchor" href="#the-performance-tool"></a>The Performance Tool</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The library contains also a performance tool to test the RabbitMQ Stream plugin.
It is usable as an uber JAR
<a href="https://bintray.com/rabbitmq/java-tools-dev/stream-perf-test">downloadable from Bintray</a>
or as a <a href="https://hub.docker.com/r/pivotalrabbitmq/stream-perf-test">Docker image</a>.
It can be built separately as well.</p>
</div>
<div class="sect2">
<h3 id="using-the-performance-tool"><a class="anchor" href="#using-the-performance-tool"></a>Using the Performance Tool</h3>
<div class="sect3">
<h4 id="with-docker-2"><a class="anchor" href="#with-docker-2"></a>With Docker</h4>
<div class="paragraph">
<p>The performance tool is available as a
<a href="https://hub.docker.com/r/pivotalrabbitmq/stream-perf-test">Docker image</a>.
You can use the Docker image to list the available options:</p>
</div>
<div class="listingblock">
<div class="title">Listing the available options of the performance tool</div>
<div class="content">
<pre>docker run -it --rm pivotalrabbitmq/stream-perf-test --help</pre>
</div>
</div>
<div class="paragraph">
<p>There are all sorts of options, if none is provided,
the tool will start publishing to and consuming from a stream created
only for the test.</p>
</div>
<div class="paragraph">
<p>When using Docker, the container running the performance tool must be able to
connect to the broker, so you have to figure out the appropriate Docker
configuration to make this possible.
You can have a look at the <a href="https://docs.docker.com/network/">Docker network documentation</a>
to find out more.</p>
</div>
<div class="paragraph">
<p>We show next a couple of options to easily use the Docker image.</p>
</div>
<div class="sect4">
<h5 id="with-docker-host-network-driver"><a class="anchor" href="#with-docker-host-network-driver"></a>With Docker Host Network Driver</h5>
<div class="paragraph">
<p>This is the simplest way to run the image locally, with a local broker running in Docker as well.
The containers use the <a href="https://docs.docker.com/network/host/">host network</a>,
this is perfect for experimenting locally.</p>
</div>
<div class="listingblock">
<div class="title">Running the broker and performance tool with the host network driver</div>
<div class="content">
<pre># run the broker
docker run -it --rm --network host pivotalrabbitmq/rabbitmq-stream
# open another terminal and run the performance tool
docker run -it --rm --network host pivotalrabbitmq/stream-perf-test</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="with-docker-bridge-network-driver"><a class="anchor" href="#with-docker-bridge-network-driver"></a>With Docker Bridge Network Driver</h5>
<div class="paragraph">
<p>Containers need to be able to communicate with each other with
the <a href="https://docs.docker.com/network/bridge/">bridge network driver</a>, this
can be done by defining a network and running the containers in this network.</p>
</div>
<div class="listingblock">
<div class="title">Running the broker and performance tool with the bridge network driver</div>
<div class="content">
<pre># create a network
docker network create stream-perf-test
# run the broker
docker run -it --rm --network stream-perf-test --name rabbitmq pivotalrabbitmq/rabbitmq-stream
# open another terminal and run the performance tool
docker run -it --rm --network stream-perf-test pivotalrabbitmq/stream-perf-test \
    --addresses rabbitmq:5555</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="with-the-java-binary"><a class="anchor" href="#with-the-java-binary"></a>With the Java Binary</h4>
<div class="paragraph">
<p>The Java binary is <a href="https://bintray.com/rabbitmq/java-tools-dev/stream-perf-test">on Bintray</a>.</p>
</div>
<div class="paragraph">
<p>To launch a run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ java -jar stream-perf-test-{version}.jar
14:49:09.695 [main] INFO  c.r.stream.perf.StreamPerfTest - Created stream stream1
14:49:09.935 [main] INFO  c.r.stream.perf.StreamPerfTest - Starting producer
1, published 356120 msg/s, confirmed 353872 msg/s, consumed 351870 msg/s, latency min/median/75th/95th/99th 3925/14539/17383/23765/31068 s, chunk size 1724
2, published 554087 msg/s, confirmed 551654 msg/s, consumed 552472 msg/s, latency min/median/75th/95th/99th 3297/12430/15489/20140/25733 s, chunk size 2301
3, published 663102 msg/s, confirmed 660917 msg/s, consumed 662571 msg/s, latency min/median/75th/95th/99th 3146/11914/14645/19149/24354 s, chunk size 2484
4, published 714358 msg/s, confirmed 712882 msg/s, consumed 714016 msg/s, latency min/median/75th/95th/99th 2836/11651/14466/18840/24509 s, chunk size 2624
5, published 732703 msg/s, confirmed 731439 msg/s, consumed 732150 msg/s, latency min/median/75th/95th/99th 2992/11868/14593/18846/24066 s, chunk size 2771
6, published 768071 msg/s, confirmed 767277 msg/s, consumed 767941 msg/s, latency min/median/75th/95th/99th 2992/11719/14532/18388/23895 s, chunk size 2855
7, published 794034 msg/s, confirmed 793072 msg/s, consumed 793992 msg/s, latency min/median/75th/95th/99th 2992/11607/14251/18144/23895 s, chunk size 2864
8, published 801647 msg/s, confirmed 800804 msg/s, consumed 801628 msg/s, latency min/median/75th/95th/99th 2992/11460/14171/18063/24509 s, chunk size 2914
...
^C
Summary: published 783246 msg/s, confirmed 782755 msg/s, consumed 782755 msg/s, latency 95th 27212 s, chunk size 3095</pre>
</div>
</div>
<div class="paragraph">
<p>The previous command will start publishing to and consuming from a <code>stream1</code> stream created
only for the test. The tool outputs live metrics on the console and write more
detailed metrics in a <code>stream-perf-test-current.txt</code> file that get renamed to
<code>stream-perf-test-yyyy-MM-dd-HHmmss.txt</code> when the run ends.</p>
</div>
<div class="paragraph">
<p>To see the options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test-{version}.jar --help</pre>
</div>
</div>
<div class="paragraph">
<p>The performance tool comes also with a completion script. You can download it and enable it in
your <code>~/.zshrc</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>alias stream-perf-test='java -jar target/stream-perf-test.jar'
source ~/.zsh/stream-perf-test_completion</pre>
</div>
</div>
<div class="paragraph">
<p>Note the activation requires an alias which must be <code>stream-perf-test</code>. The command can be anything
though.</p>
</div>
</div>
<div class="sect3">
<h4 id="common-usage"><a class="anchor" href="#common-usage"></a>Common Usage</h4>
<div class="sect4">
<h5 id="connection"><a class="anchor" href="#connection"></a>Connection</h5>
<div class="paragraph">
<p>The performance tool connects by default to localhost, on port 5555, with
default credentials (<code>guest</code>/<code>guest</code>), on the default <code>/</code> virtual host.
This can be changed with the <code>--uris</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --uris rabbitmq-stream://rabbitmq-1:5555</pre>
</div>
</div>
<div class="paragraph">
<p>The URI follows the same rules as the
<a href="https://www.rabbitmq.com/uri-spec.html">AMQP 0.9.1 URI</a>,
except the protocol must be <code>rabbitmq-stream</code> and TLS is not supported.
The next command shows how to set up the different elements of the URI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar \
  --uris rabbitmq-stream://guest:guest@localhost:5555/%2f</pre>
</div>
</div>
<div class="paragraph">
<p>The option accepts several values, separated by commas. By doing so, the tool
will be able to pick another URI for its "locator" connection, in case a node
crashes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar \
  --uris rabbitmq-stream://rabbitmq-1:5555,rabbitmq-stream://rabbitmq-2:5555</pre>
</div>
</div>
<div class="paragraph">
<p>Note the tool uses those URIs only for management purposes, it does not use them
to distribute publishers and consumers across a cluster.</p>
</div>
</div>
<div class="sect4">
<h5 id="publishing-rate"><a class="anchor" href="#publishing-rate"></a>Publishing Rate</h5>
<div class="paragraph">
<p>It is possible to limit the publishing rate with the <code>--rate</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --rate 10000</pre>
</div>
</div>
<div class="paragraph">
<p>RabbitMQ Stream can easily saturate the resources of the hardware, it can especially
max out the storage IO. Reasoning when a system is under severe constraints can
be difficult, so setting a low publishing rate can be a good idea to get familiar
with the performance tool and the semantics of streams.</p>
</div>
</div>
<div class="sect4">
<h5 id="number-of-producers-and-consumers"><a class="anchor" href="#number-of-producers-and-consumers"></a>Number of Producers and Consumers</h5>
<div class="paragraph">
<p>You can set the number of producers and consumers with the <code>--producers</code> and
<code>--consumers</code> options, respectively:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 5 --consumers 5</pre>
</div>
</div>
<div class="paragraph">
<p>With the previous command, you should see a higher consuming rate than
publishing rate. It is because the 5 producers publish as fast as they can
and each consumer consume the messages from the 5 publishers. In theory
the consumer rate should be 5 times the publishing rate, but as stated previously,
the performance tool may put the broker under severe constraints, so the numbers
may not add up.</p>
</div>
<div class="paragraph">
<p>You can set a low publishing rate to verify this theory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 5 --consumers 5 --rate 10000</pre>
</div>
</div>
<div class="paragraph">
<p>With the previous command, each publisher should publish 10,000 messages per second,
that is 50,000 messages per second overall. As each consumer consumes each published messages,
the consuming rate should be 5 times the publishing rate, that is 250,000 messages per
second. Using a small publishing rate should let plenty of resources to the system,
so the rates should tend towards those values.</p>
</div>
</div>
<div class="sect4">
<h5 id="streams"><a class="anchor" href="#streams"></a>Streams</h5>
<div class="paragraph">
<p>The performance tool uses a <code>stream1</code> stream by default, the <code>--streams</code> option allows
specifying streams that will be created and used only for the test run. Note producer
and consumer counts must be set accordingly, as they are not spread across the
stream automatically. The following command will run a test with 3 streams, with
a producer and a consumer on each of them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --streams stream1,stream2,stream3 \
                               --producers 3 --consumers 3</pre>
</div>
</div>
<div class="paragraph">
<p>If you do not want the tool to create and delete streams for a run, because they are already created,
use the <code>--pre-declared</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --streams stream1,stream2,stream3 \
                               --producers 3 --consumers 3 \
                               --pre-declared</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="publishing-batch-size"><a class="anchor" href="#publishing-batch-size"></a>Publishing Batch Size</h5>
<div class="paragraph">
<p>The default publishing batch size is 100, that is a publishing frame is sent every 100 messages.
The following command sets the batch size to 50 with the <code>--batch-size</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --batch-size 50</pre>
</div>
</div>
<div class="paragraph">
<p>There is no ideal batch size, it is a tradeoff between throughput and latency.
High batch size values should increase throughput (usually good) and latency (usually not so
good), whereas low batch size should decrease throughput (usually not good) and latency (usually
good).</p>
</div>
</div>
<div class="sect4">
<h5 id="unconfirmed-messages"><a class="anchor" href="#unconfirmed-messages"></a>Unconfirmed Messages</h5>
<div class="paragraph">
<p>A publisher can have at most 10,000 unconfirmed messages at some point. If it reaches this value,
it has to wait until the broker confirms some messages. This avoids fast publishers overwhelming
the broker. The <code>--confirms</code> option allows changing the default value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --confirms 20000</pre>
</div>
</div>
<div class="paragraph">
<p>High values should increase throughput at the cost of consuming more memory, whereas low values
should decrease throughput and memory consumption.</p>
</div>
</div>
<div class="sect4">
<h5 id="message-size"><a class="anchor" href="#message-size"></a>Message Size</h5>
<div class="paragraph">
<p>The default size of a message is 10 bytes, which is rather small. The <code>--size</code> option lets you
specify a different size, usually higher, to have a value close to your use case. The next command
sets a size of 1 KB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --size 1024</pre>
</div>
</div>
<div class="paragraph">
<p>Note the message body size cannot be smaller that 8 bytes, as the performance tool stores
a long in each message to calculate the latency. Note also the actual size of a message will be
slightly higher, as the body is wrapped in an <a href="#working-with-complex-messages">AMQP 1.0 message</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="advanced-usage"><a class="anchor" href="#advanced-usage"></a>Advanced Usage</h4>
<div class="sect4">
<h5 id="retention"><a class="anchor" href="#retention"></a>Retention</h5>
<div class="paragraph">
<p>If you run performance tests for a long time, you might be interested in setting
a <a href="#limiting-the-size-of-a-stream">retention strategy</a> for
the streams the performance tool creates for a run. This
would typically avoid saturating the storage devices of your servers.
The default values are 20 GB for the maximum size of a stream and
500 MB for each segment files that composes a stream. You can change
these values with the <code>--max-length-bytes</code> and <code>--max-segment-size</code> options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --max-length-bytes 10gb \
                               --max-segment-size 250mb</pre>
</div>
</div>
<div class="paragraph">
<p>Both options accept units (<code>kb</code>, <code>mb</code>, <code>gb</code>, <code>tb</code>), as well as no unit to
specify a number of bytes.</p>
</div>
<div class="paragraph">
<p>It is also possible to use the time-based retention strategy with the <code>--max-age</code> option.
This can be less predictable than <code>--max-length-bytes</code> in the context of performance tests though.
The following command shows how to set the maximum age of segments to 5 minutes with
a maximum segment size of 250 MB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --max-age PT5M \
                               --max-segment-size 250mb</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--max-age</code> option uses the
<a href="https://en.wikipedia.org/wiki/ISO_8601#Durations">ISO 8601 duration format</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="offset-consumer"><a class="anchor" href="#offset-consumer"></a>Offset (Consumer)</h5>
<div class="paragraph">
<p>Consumers start by default at the first available offset of stream, that is
the beginning of the stream if it has not been truncated (offset 0). It is possible
to specify an <a href="#specifying-an-offset">offset</a> to start from with the <code>--offset</code> option,
if you have existing streams and you want to consume from them at a specific offset.
The following command sets the consumer to start consuming at the very end of
a stream, as soon as new messages are published:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --offset next</pre>
</div>
</div>
<div class="paragraph">
<p>The accepted values for <code>--offset</code> are <code>first</code> (the default), <code>last</code>, <code>next</code>,
an unsigned long for a given offset, and an ISO 8601 formatted timestamp
(eg. <code>2020-06-03T07:45:54Z</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="offset-tracking-consumer"><a class="anchor" href="#offset-tracking-consumer"></a>Offset Tracking (Consumer)</h5>
<div class="paragraph">
<p>A consumer can <a href="#consumer-offset-tracking">track the point</a> it has reached
in a stream to be able to restart where it left off in a new incarnation.
The performance tool has the <code>--commit-every</code> option to tell consumers to commit
the offset every <code>x</code> messages to be able to measure the impact of offset tracking
in terms of throughput and storage. This feature is disabled by default.
The following command shows how to commit the offset every 100,000 messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --commit-every 100000</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="building-the-performance-tool"><a class="anchor" href="#building-the-performance-tool"></a>Building the Performance Tool</h3>
<div class="paragraph">
<p>To build the uber JAR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./mvnw clean package -Dmaven.test.skip -P performance-tool</pre>
</div>
</div>
<div class="paragraph">
<p>Then run the tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar target/stream-perf-test.jar</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.1.0-SNAPSHOT<br>
Last updated 2020-11-10 16:34:08 UTC
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</body>
</html>