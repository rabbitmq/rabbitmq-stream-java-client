<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>RabbitMQ Stream Java Client</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>RabbitMQ Stream Java Client</h1>
<div class="details">
<span id="revnumber">version 0.6.0-SNAPSHOT</span>
<br><span id="revremark">(0a44469)</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#what-is-a-rabbitmq-stream">What is a RabbitMQ Stream?</a></li>
<li><a href="#when-to-use-rabbitmq-stream">When to Use RabbitMQ Stream?</a></li>
<li><a href="#other-way-to-use-streams-in-rabbitmq">Other Way to Use Streams in RabbitMQ</a></li>
<li><a href="#guarantees">Guarantees</a></li>
<li><a href="#stream-client-overview">Stream Client Overview</a></li>
<li><a href="#versioning">Versioning</a></li>
<li><a href="#stability-of-programming-interfaces">Stability of Programming Interfaces</a></li>
<li><a href="#the-stream-java-client">The Stream Java Client</a>
<ul class="sectlevel2">
<li><a href="#setting-up-rabbitmq">Setting up RabbitMQ</a>
<ul class="sectlevel3">
<li><a href="#with-docker">With Docker</a>
<ul class="sectlevel4">
<li><a href="#with-docker-bridge-network-driver">With Docker Bridge Network Driver</a></li>
<li><a href="#with-docker-host-network-driver">With Docker Host Network Driver</a></li>
</ul>
</li>
<li><a href="#with-a-rabbitmq-package-running-on-the-host">With a RabbitMQ Package Running on the Host</a></li>
</ul>
</li>
<li><a href="#dependencies">Dependencies</a>
<ul class="sectlevel3">
<li><a href="#maven">Maven</a></li>
<li><a href="#gradle">Gradle</a></li>
</ul>
</li>
<li><a href="#snapshots">Snapshots</a></li>
<li><a href="#sample-application">Sample Application</a></li>
<li><a href="#rabbitmq-stream-java-api">RabbitMQ Stream Java API</a>
<ul class="sectlevel3">
<li><a href="#overview">Overview</a></li>
<li><a href="#environment">Environment</a>
<ul class="sectlevel4">
<li><a href="#creating-the-environment">Creating the Environment</a></li>
<li><a href="#understanding-connection-logic">Understanding Connection Logic</a></li>
<li><a href="#enabling-tls">Enabling TLS</a></li>
<li><a href="#configuring-the-environment">Configuring the Environment</a></li>
<li><a href="#when-a-load-balancer-is-in-use">When a Load Balancer is in Use</a></li>
<li><a href="#managing-streams">Managing Streams</a></li>
</ul>
</li>
<li><a href="#producer">Producer</a>
<ul class="sectlevel4">
<li><a href="#creating-a-producer">Creating a Producer</a></li>
<li><a href="#sending-messages">Sending Messages</a></li>
<li><a href="#working-with-complex-messages">Working with Complex Messages</a></li>
<li><a href="#outbound-message-deduplication">Message Deduplication</a>
<ul class="sectlevel5">
<li><a href="#setting-the-name-of-a-producer">Setting the Name of a Producer</a></li>
<li><a href="#understanding-publishing-id">Understanding Publishing ID</a></li>
<li><a href="#restarting-a-producer-where-it-left-off">Restarting a Producer Where It Left Off</a></li>
</ul>
</li>
<li><a href="#sub-entry-batching-and-compression">Sub-Entry Batching and Compression</a></li>
</ul>
</li>
<li><a href="#consumer">Consumer</a>
<ul class="sectlevel4">
<li><a href="#creating-a-consumer">Creating a Consumer</a></li>
<li><a href="#specifying-an-offset">Specifying an Offset</a></li>
<li><a href="#consumer-offset-tracking">Tracking the Offset for a Consumer</a>
<ul class="sectlevel5">
<li><a href="#consumer-automatic-offset-tracking">Automatic Offset Tracking</a></li>
<li><a href="#consumer-manual-offset-tracking">Manual Offset Tracking</a></li>
<li><a href="#considerations-on-offset-tracking">Considerations On Offset Tracking</a></li>
<li><a href="#consumer-subscription-listener">Subscription Listener</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#super-streams">Super Streams (Partitioned Streams)</a>
<ul class="sectlevel4">
<li><a href="#topology">Topology</a></li>
<li><a href="#publishing-to-a-super-stream">Publishing to a Super Stream</a>
<ul class="sectlevel5">
<li><a href="#resolving-routes-with-bindings">Resolving Routes with Bindings</a></li>
<li><a href="#using-a-custom-routing-strategy">Using a Custom Routing Strategy</a></li>
<li><a href="#deduplication">Deduplication</a></li>
</ul>
</li>
<li><a href="#consuming-from-a-super-stream">Consuming From a Super Stream</a>
<ul class="sectlevel5">
<li><a href="#offset-tracking">Offset Tracking</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#building-the-client">Building the Client</a></li>
</ul>
</li>
<li><a href="#the-performance-tool">The Performance Tool</a>
<ul class="sectlevel2">
<li><a href="#using-the-performance-tool">Using the Performance Tool</a>
<ul class="sectlevel3">
<li><a href="#with-docker-2">With Docker</a>
<ul class="sectlevel4">
<li><a href="#with-docker-host-network-driver-2">With Docker Host Network Driver</a></li>
<li><a href="#with-docker-bridge-network-driver-2">With Docker Bridge Network Driver</a></li>
</ul>
</li>
<li><a href="#with-the-java-binary">With the Java Binary</a></li>
<li><a href="#common-usage">Common Usage</a>
<ul class="sectlevel4">
<li><a href="#connection">Connection</a></li>
<li><a href="#publishing-rate">Publishing Rate</a></li>
<li><a href="#number-of-producers-and-consumers">Number of Producers and Consumers</a></li>
<li><a href="#streams">Streams</a></li>
<li><a href="#publishing-batch-size">Publishing Batch Size</a></li>
<li><a href="#unconfirmed-messages">Unconfirmed Messages</a></li>
<li><a href="#message-size">Message Size</a></li>
<li><a href="#connection-pooling">Connection Pooling</a></li>
</ul>
</li>
<li><a href="#advanced-usage">Advanced Usage</a>
<ul class="sectlevel4">
<li><a href="#performance-tool-retention">Retention</a></li>
<li><a href="#offset-consumer">Offset (Consumer)</a></li>
<li><a href="#offset-tracking-consumer">Offset Tracking (Consumer)</a></li>
<li><a href="#consumer-names">Consumer Names</a></li>
<li><a href="#producer-names">Producer Names</a></li>
<li><a href="#load-balancer-in-front-of-the-cluster">Load Balancer in Front of the Cluster</a></li>
<li><a href="#monitoring">Monitoring</a></li>
<li><a href="#using-environment-variables-as-options">Using Environment Variables as Options</a></li>
<li><a href="#logging">Logging</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#building-the-performance-tool">Building the Performance Tool</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The RabbitMQ Stream Java Client is a Java library to communicate with
the <a href="https://rabbitmq.com/stream.html">RabbitMQ Stream Plugin</a>.
It allows creating and deleting streams, as well as publishing to and consuming from
these streams. Learn more in the <a href="#stream-client-overview">the client overview</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-a-rabbitmq-stream"><a class="anchor" href="#what-is-a-rabbitmq-stream"></a>What is a RabbitMQ Stream?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A RabbitMQ stream is a persistent and replicated data structure that models
an <a href="https://en.wikipedia.org/wiki/Append-only">append-only log</a>. It differs from the classical
RabbitMQ queue in the way message consumption works. In a classical RabbitMQ queue,
consuming removes messages from the queue. In a RabbitMQ stream, consuming leaves
the stream intact. So the content of a stream can be read and re-read without
impact or destructive effect.</p>
</div>
<div class="paragraph">
<p>None of the stream or classical queue data structure is better than the other,
they are usually suited for different use cases.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="when-to-use-rabbitmq-stream"><a class="anchor" href="#when-to-use-rabbitmq-stream"></a>When to Use RabbitMQ Stream?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RabbitMQ Stream was developed to cover the following messaging use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Large fan-outs:</em> when several consumer applications need to read the same messages.</p>
</li>
<li>
<p><em>Replay / Time-traveling:</em> when consumer applications need to read the whole
history of data or from a given point in a stream.</p>
</li>
<li>
<p><em>Throughput performance:</em> when higher throughput than with other protocols
(AMQP, STOMP, MQTT) is required.</p>
</li>
<li>
<p><em>Large logs:</em> when large amount of data need to be stored, with minimal
in-memory overhead.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="other-way-to-use-streams-in-rabbitmq"><a class="anchor" href="#other-way-to-use-streams-in-rabbitmq"></a>Other Way to Use Streams in RabbitMQ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is also possible to use the stream abstraction in RabbitMQ
with the AMQP 0-9-1 protocol. Instead of consuming from a stream
with the stream protocol, one consumes from a "stream-powered" queue with
the AMQP 0-9-1 protocol. A "stream-powered" queue is a special type of queue that
is backed up with a stream infrastructure layer and adapted to
provide the stream semantics (mainly non-destructive reading).</p>
</div>
<div class="paragraph">
<p>Using such a queue has the advantage to provide the features
inherent to the stream abstraction (append-only structure, non-destructive
reading) with any AMQP 0-9-1 client library. This is clearly
interesting when considering the maturity of AMQP 0-9-1 client libraries
and the ecosystem around AMQP 0-9-1.</p>
</div>
<div class="paragraph">
<p>But by using it, one does not benefit from the performance
of the stream protocol, which has been designed for performance in mind,
whereas AMQP 0-9-1 is a more general-purpose protocol.</p>
</div>
<div class="paragraph">
<p>It is not possible to use "stream-powered" queues with the stream Java client,
you need to use an AMQP 0-9-1 client library.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="guarantees"><a class="anchor" href="#guarantees"></a>Guarantees</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RabbitMQ stream provides at-least-once guarantees thanks to the
publisher confirm mechanism, which is supported by the stream Java client.</p>
</div>
<div class="paragraph">
<p>Message <a href="#outbound-message-deduplication">deduplication</a>
is also supported on the publisher side.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stream-client-overview"><a class="anchor" href="#stream-client-overview"></a>Stream Client Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The RabbitMQ Stream Java Client implements the
<a href="https://github.com/rabbitmq/rabbitmq-server/blob/v3.10.x/deps/rabbitmq_stream/docs/PROTOCOL.adoc">RabbitMQ Stream protocol</a>
and avoids dealing with low-level concerns by providing high-level functionalities
to build fast, efficient, and robust client applications.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>administrate streams (creation/deletion) directly from applications.</em> This
can also be useful for development and testing.</p>
</li>
<li>
<p><em>adapt publishing throughput</em> thanks to the configurable batch size and flow control.</p>
</li>
<li>
<p><em>avoid publishing duplicate messages</em> thanks to message deduplication.</p>
</li>
<li>
<p><em>consume asynchronously from streams and resume where left off</em> thanks to
automatic or manual offset tracking.</p>
</li>
<li>
<p><em>enforce <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/">best practices</a> to create client connections</em> â€“ to stream leaders for publishers to minimize inter-node traffic and to stream replicas for consumers to offload leaders.</p>
</li>
<li>
<p><em>optimize resources</em> thanks to automatic growing and shrinking of
connections depending on the number of publishers and consumers.</p>
</li>
<li>
<p><em>let the client handle network failure</em> thanks to automatic connection
recovery and automatic re-subscription for consumers.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="versioning"><a class="anchor" href="#versioning"></a>Versioning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The RabbitMQ Stream Java Client is in development and stabilization phase.
When the stabilization phase ends, a 1.0.0 version will be cut, and
<a href="https://semver.org/">semantic versioning</a> is likely to be enforced.</p>
</div>
<div class="paragraph">
<p>Before reaching the stable phase, the client will use a versioning scheme of <code>[0.MINOR.PATCH]</code> where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0</code> indicates the project is still in a stabilization phase.</p>
</li>
<li>
<p><code>MINOR</code> is a 0-based number incrementing with each new release cycle. It generally reflects significant changes like new features and potentially some programming interfaces changes.</p>
</li>
<li>
<p><code>PATCH</code> is a 0-based number incrementing with each service release, that is bux fixes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Breaking changes between releases can happen but will be kept to a minimum.
The next section provides more details about the evolution of programming interfaces.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stability-of-programming-interfaces"><a class="anchor" href="#stability-of-programming-interfaces"></a>Stability of Programming Interfaces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The RabbitMQ Stream Java Client is in active development but its programming interfaces will remain as stable as possible. There is no guarantee though that they will remain completely stable, at least until it reaches version 1.0.0.</p>
</div>
<div class="paragraph">
<p>The client contains 2 sets of programming interfaces whose stability are of interest for application developers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Application Programming Interfaces (API): those are the ones used to write application logic. They include the interfaces and classes in the <code>com.rabbitmq.stream</code> package (e.g. <code>Producer</code>, <code>Consumer</code>, <code>Message</code>). These API constitute the main programming model of the client and will be kept as stable as possible.</p>
</li>
<li>
<p>Service Provider Interfaces (SPI): those are interfaces to implement mainly technical behavior in the client. They are not meant to be used to implement application logic. Application developers may have to refer to them in the configuration phase and if they want to custom some internal behavior in the client. SPI include interfaces and classes in the <code>com.rabbitmq.stream.codec</code>, <code>com.rabbitmq.stream.compression</code>, <code>com.rabbitmq.stream.metrics</code> packages, among others. <em>These SPI are susceptible to change, but this should not impact the majority of applications</em>, as the changes would typically stay intern to the client.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-stream-java-client"><a class="anchor" href="#the-stream-java-client"></a>The Stream Java Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The library requires Java 8 or later. Java 11 is recommended (CRC calculation uses methods available as of Java 9.)</p>
</div>
<div class="sect2">
<h3 id="setting-up-rabbitmq"><a class="anchor" href="#setting-up-rabbitmq"></a>Setting up RabbitMQ</h3>
<div class="paragraph">
<p>A RabbitMQ 3.9+ node with the stream plugin enabled is required. The easiest way
to get up and running is to use Docker.</p>
</div>
<div class="sect3">
<h4 id="with-docker"><a class="anchor" href="#with-docker"></a>With Docker</h4>
<div class="paragraph">
<p>There are different ways to make the broker visible to the client application when running
in Docker. The next sections show a couple of options suitable for local development.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Docker on macOS</div>
<div class="paragraph">
<p>Docker runs on a virtual machine when using macOS, so do not expect high performance
when using RabbitMQ Stream inside Docker on a Mac.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="with-docker-bridge-network-driver"><a class="anchor" href="#with-docker-bridge-network-driver"></a>With Docker Bridge Network Driver</h5>
<div class="paragraph">
<p>This section shows how to start a broker instance for local development
(the broker Docker container and the client application are assumed to run on the
same host).</p>
</div>
<div class="paragraph">
<p>The following command creates a one-time Docker container to run RabbitMQ:</p>
</div>
<div class="listingblock">
<div class="title">Running the stream plugin with Docker</div>
<div class="content">
<pre>docker run -it --rm --name rabbitmq -p 5552:5552 \
    -e RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS='-rabbitmq_stream advertised_host localhost' \
    rabbitmq:3.10</pre>
</div>
</div>
<div class="paragraph">
<p>The previous command exposes only the stream port (5552), you can expose
ports for other protocols:</p>
</div>
<div class="listingblock">
<div class="title">Exposing the AMQP 0.9.1 and management ports:</div>
<div class="content">
<pre>docker run -it --rm --name rabbitmq -p 5552:5552 -p 5672:5672 -p 15672:15672 \
    -e RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS='-rabbitmq_stream advertised_host localhost' \
    rabbitmq:3.10-management</pre>
</div>
</div>
<div class="paragraph">
<p>Refer to the official <a href="https://hub.docker.com/_/rabbitmq">RabbitMQ Docker image web page</a>
to find out more about its usage.</p>
</div>
<div class="paragraph">
<p>Once the container is started, <strong>the stream plugin must be enabled</strong>:</p>
</div>
<div class="listingblock">
<div class="title">Enabling the stream plugin:</div>
<div class="content">
<pre>docker exec rabbitmq rabbitmq-plugins enable rabbitmq_stream</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="with-docker-host-network-driver"><a class="anchor" href="#with-docker-host-network-driver"></a>With Docker Host Network Driver</h5>
<div class="paragraph">
<p>This is the simplest way to run the broker locally.
The container uses the <a href="https://docs.docker.com/network/host/">host network</a>,
this is perfect for experimenting locally.</p>
</div>
<div class="listingblock">
<div class="title">Running RabbitMQ Stream with the host network driver</div>
<div class="content">
<pre>docker run -it --rm --name rabbitmq --network host rabbitmq:3.10</pre>
</div>
</div>
<div class="paragraph">
<p>Once the container is started, <strong>the stream plugin must be enabled</strong>:</p>
</div>
<div class="listingblock">
<div class="title">Enabling the stream plugin:</div>
<div class="content">
<pre>docker exec rabbitmq rabbitmq-plugins enable rabbitmq_stream</pre>
</div>
</div>
<div class="paragraph">
<p>The container will use the following ports: 5552 (for stream) and 5672 (for AMQP.)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Docker Host Network Driver Support</div>
<div class="paragraph">
<p>The host networking driver <strong>only works on Linux hosts</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="with-a-rabbitmq-package-running-on-the-host"><a class="anchor" href="#with-a-rabbitmq-package-running-on-the-host"></a>With a RabbitMQ Package Running on the Host</h4>
<div class="paragraph">
<p>Using a package implies installing Erlang.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure to use <a href="https://github.com/rabbitmq/rabbitmq-server/releases">RabbitMQ 3.9 or more</a>.</p>
</li>
<li>
<p>Follow the steps to
<a href="https://rabbitmq.com/download.html">install Erlang and the appropriate package</a></p>
</li>
<li>
<p>Enable the plugin <code>rabbitmq-plugins enable rabbitmq_stream</code>.</p>
</li>
<li>
<p>The stream plugin listens on port 5552.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to the <a href="https://rabbitmq.com/stream.html">stream plugin documentation</a> for more information on configuration.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dependencies"><a class="anchor" href="#dependencies"></a>Dependencies</h3>
<div class="paragraph">
<p>Use your favorite build management tool to add the client dependencies to your project.</p>
</div>
<div class="sect3">
<h4 id="maven"><a class="anchor" href="#maven"></a>Maven</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>

  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.rabbitmq<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>stream-client<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>0.6.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>

<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Snapshots require to declare the <a href="#snapshots">appropriate repository</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="gradle"><a class="anchor" href="#gradle"></a>Gradle</h4>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
  compile <span class="string"><span class="delimiter">&quot;</span><span class="content">com.rabbitmq:stream-client:0.6.0-SNAPSHOT</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Snapshots require to declare the <a href="#snapshots">appropriate repository</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="snapshots"><a class="anchor" href="#snapshots"></a>Snapshots</h3>
<div class="paragraph">
<p>Releases are available from Maven Central, which does not require specific declaration.
Snapshots are available from a repositoriy which must be declared in the dependency management configuration.</p>
</div>
<div class="paragraph">
<p>With Maven:</p>
</div>
<div class="listingblock">
<div class="title">Snapshot repository declaration for Maven</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;repositories&gt;</span>

  <span class="tag">&lt;repository&gt;</span>
    <span class="tag">&lt;id&gt;</span>ossrh<span class="tag">&lt;/id&gt;</span>
    <span class="tag">&lt;url&gt;</span>https://oss.sonatype.org/content/repositories/snapshots<span class="tag">&lt;/url&gt;</span>
    <span class="tag">&lt;snapshots&gt;</span><span class="tag">&lt;enabled&gt;</span>true<span class="tag">&lt;/enabled&gt;</span><span class="tag">&lt;/snapshots&gt;</span>
    <span class="tag">&lt;releases&gt;</span><span class="tag">&lt;enabled&gt;</span>false<span class="tag">&lt;/enabled&gt;</span><span class="tag">&lt;/releases&gt;</span>
  <span class="tag">&lt;/repository&gt;</span>

<span class="tag">&lt;/repositories&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With Gradle:</p>
</div>
<div class="listingblock">
<div class="title">Snapshot repository declaration for Gradle:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">repositories {
  maven { url <span class="string"><span class="delimiter">'</span><span class="content">https://oss.sonatype.org/content/repositories/snapshots</span><span class="delimiter">'</span></span> }
  mavenCentral()
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-application"><a class="anchor" href="#sample-application"></a>Sample Application</h3>
<div class="paragraph">
<p>This section covers the basics of the RabbitMQ Stream Java API by building
a small publish/consume application. This is a good way to get
an overview of the API. If you want a more comprehensive introduction,
you can go to the <a href="#rabbitmq-stream-java-api">reference documentation section</a>.</p>
</div>
<div class="paragraph">
<p>The sample application publishes some messages and then registers
a consumer to make some computations out of them. The
<a href="https://github.com/rabbitmq/rabbitmq-stream-java-client/blob/main/src/test/java/com/rabbitmq/stream/docs/SampleApplication.java">source code is available on GitHub</a>.</p>
</div>
<div class="paragraph">
<p>The sample class starts with a few imports:</p>
</div>
<div class="listingblock">
<div class="title">Imports for the sample application</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.rabbitmq.stream</span>.*;
<span class="keyword">import</span> <span class="include">java.util.UUID</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.CountDownLatch</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.TimeUnit</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.atomic.AtomicLong</span>;
<span class="keyword">import</span> <span class="include">java.util.stream.IntStream</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to create the <code>Environment</code>. It is a management object
used to manage streams and create producers as well as consumers. The
next snippet shows how to create an <code>Environment</code> instance and
create the stream used in the application:</p>
</div>
<div class="listingblock">
<div class="title">Creating the environment</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Connecting...</span><span class="delimiter">&quot;</span></span>);
Environment environment = Environment.builder().build();  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">String</span> stream = <span class="predefined-type">UUID</span>.randomUUID().toString();
environment.streamCreator().stream(stream).create();  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>Environment#builder</code> to create the environment</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create the stream</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then comes the publishing part. The next snippet shows how to create
a <code>Producer</code>, send messages, and handle publishing confirmations, to
make sure the broker has taken outbound messages into account.
The application uses a count down latch to move on once the messages
have been confirmed.</p>
</div>
<div class="listingblock">
<div class="title">Publishing messages</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Starting publishing...</span><span class="delimiter">&quot;</span></span>);
<span class="type">int</span> messageCount = <span class="integer">10000</span>;
<span class="predefined-type">CountDownLatch</span> publishConfirmLatch = <span class="keyword">new</span> <span class="predefined-type">CountDownLatch</span>(messageCount);
Producer producer = environment.producerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(stream)
        .build();
IntStream.range(<span class="integer">0</span>, messageCount)
        .forEach(i -&gt; producer.send(  <i class="conum" data-value="2"></i><b>(2)</b>
                producer.messageBuilder()                    <i class="conum" data-value="3"></i><b>(3)</b>
                    .addData(<span class="predefined-type">String</span>.valueOf(i).getBytes())   <i class="conum" data-value="3"></i><b>(3)</b>
                    .build(),                                <i class="conum" data-value="3"></i><b>(3)</b>
                confirmationStatus -&gt; publishConfirmLatch.countDown()  <i class="conum" data-value="4"></i><b>(4)</b>
        ));
publishConfirmLatch.await(<span class="integer">10</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);  <i class="conum" data-value="5"></i><b>(5)</b>
producer.close();  <i class="conum" data-value="6"></i><b>(6)</b>
<span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Published %,d messages%n</span><span class="delimiter">&quot;</span></span>, messageCount);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>Producer</code> with <code>Environment#producerBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Send messages with <code>Producer#send(Message, ConfirmationHandler)</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a message with <code>Producer#messageBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Count down on message publishing confirmation</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Wait for all publishing confirmations to have arrived</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Close the producer</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is now time to consume the messages. The <code>Environment</code> lets us create a <code>Consumer</code>
and provide some logic on each incoming message by implementing a <code>MessageHandler</code>.
The next snippet does this to calculate a sum and output it once all the messages
have been received:</p>
</div>
<div class="listingblock">
<div class="title">Consuming messages</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Starting consuming...</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">AtomicLong</span> sum = <span class="keyword">new</span> <span class="predefined-type">AtomicLong</span>(<span class="integer">0</span>);
<span class="predefined-type">CountDownLatch</span> consumeLatch = <span class="keyword">new</span> <span class="predefined-type">CountDownLatch</span>(messageCount);
Consumer consumer = environment.consumerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(stream)
        .offset(OffsetSpecification.first()) <i class="conum" data-value="2"></i><b>(2)</b>
        .messageHandler((offset, message) -&gt; {  <i class="conum" data-value="3"></i><b>(3)</b>
            sum.addAndGet(<span class="predefined-type">Long</span>.parseLong(<span class="keyword">new</span> <span class="predefined-type">String</span>(message.getBodyAsBinary())));  <i class="conum" data-value="4"></i><b>(4)</b>
            consumeLatch.countDown();  <i class="conum" data-value="5"></i><b>(5)</b>
        })
        .build();

consumeLatch.await(<span class="integer">10</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);  <i class="conum" data-value="6"></i><b>(6)</b>

<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Sum: </span><span class="delimiter">&quot;</span></span> + sum.get());  <i class="conum" data-value="7"></i><b>(7)</b>

consumer.close();  <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>Consumer</code> with <code>Environment#consumerBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start consuming from the beginning of the stream</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set up the logic to handle messages</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Add the value in the message body to the sum</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Count down on each message</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Wait for all messages to have arrived</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Output the sum</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Close the consumer</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The application has some cleaning to do before terminating, that is
deleting the stream and closing the environment:</p>
</div>
<div class="listingblock">
<div class="title">Cleaning before terminating</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.deleteStream(stream);  <i class="conum" data-value="1"></i><b>(1)</b>
environment.close();  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Delete the stream</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Close the environment</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can run the sample application from the root of the project (you need
a running local RabbitMQ node with the stream plugin enabled):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./mvnw -q test-compile exec:java -Dexec.classpathScope="test" \
    -Dexec.mainClass="com.rabbitmq.stream.docs.SampleApplication"
Starting publishing...
Published 10000 messages
Starting consuming...
Sum: 49995000</pre>
</div>
</div>
<div class="paragraph">
<p>You can remove the <code>-q</code> flag if you want more insight on the execution of the build.</p>
</div>
</div>
<div class="sect2">
<h3 id="rabbitmq-stream-java-api"><a class="anchor" href="#rabbitmq-stream-java-api"></a>RabbitMQ Stream Java API</h3>
<div class="sect3">
<h4 id="overview"><a class="anchor" href="#overview"></a>Overview</h4>
<div class="paragraph">
<p>This section describes the API to connect to the RabbitMQ Stream Plugin, publish messages, and
consume messages. There are 3 main interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.rabbitmq.stream.Environment</code> for connecting to a node and optionally
managing streams.</p>
</li>
<li>
<p><code>com.rabbitmq.stream.Producer</code> to publish messages.</p>
</li>
<li>
<p><code>com.rabbitmq.stream.Consumer</code> to consume messages.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="environment"><a class="anchor" href="#environment"></a>Environment</h4>
<div class="sect4">
<h5 id="creating-the-environment"><a class="anchor" href="#creating-the-environment"></a>Creating the Environment</h5>
<div class="paragraph">
<p>The environment is the main entry point to a node or a cluster of nodes. <code>Producer</code> and
<code>Consumer</code> instances are created from an <code>Environment</code> instance. Here is the simplest
way to create an <code>Environment</code> instance:</p>
</div>
<div class="listingblock">
<div class="title">Creating an environment with all the defaults</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder().build();  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="comment">// ...</span>
environment.close(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create an environment that will connect to localhost:5552</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Close the environment after usage</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the environment must be closed to release resources when it is no
longer needed.</p>
</div>
<div class="paragraph">
<p>Consider the environment like a long-lived object. An application will usually
create one <code>Environment</code> instance when it starts up and close it when it exits.</p>
</div>
<div class="paragraph">
<p>It is possible to use a URI to specify all the necessary information to
connect to a node:</p>
</div>
<div class="listingblock">
<div class="title">Creating an environment with a URI</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder()
        .uri(<span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://guest:guest@localhost:5552/%2f</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>uri</code> method to specify the URI to connect to</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous snippet uses a URI that specifies the following information: host, port,
username, password, and virtual host (<code>/</code>, which is encoded as <code>%2f</code>).
The URI follows the same rules as the
<a href="https://www.rabbitmq.com/uri-spec.html">AMQP 0.9.1 URI</a>,
except the protocol must be <code>rabbitmq-stream</code>. <a href="#enabling-tls">TLS is enabled</a> by using
the <code>rabbitmq-stream+tls</code> scheme in the URI.</p>
</div>
<div class="paragraph">
<p>When using one URI, the corresponding node will be the main entry point to connect to. The
<code>Environment</code> will then use the stream protocol to find out more about streams topology
(leaders and replicas) when asked to create <code>Producer</code> and <code>Consumer</code> instances. The <code>Environment</code>
may become blind if this node goes down though, so it may be more appropriate to specify
several other URIs to try in case of failure of a node:</p>
</div>
<div class="listingblock">
<div class="title">Creating an environment with several URIs</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder()
        .uris(<span class="predefined-type">Arrays</span>.asList(                     <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://host1:5552</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://host2:5552</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream://host3:5552</span><span class="delimiter">&quot;</span></span>)
        )
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>uris</code> method to specify several URIs</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By specifying several URIs, the environment will try to connect to the first one, and
will pick a new URI randomly in case of disconnection.</p>
</div>
</div>
<div class="sect4">
<h5 id="understanding-connection-logic"><a class="anchor" href="#understanding-connection-logic"></a>Understanding Connection Logic</h5>
<div class="paragraph">
<p>Creating the environment to connect to a cluster node works usually seamlessly.
Creating publishers and consumers can cause problems as the client uses hints from the cluster to find the nodes where stream leaders and replicas are located to connect to the appropriate nodes.</p>
</div>
<div class="paragraph">
<p>These connection hints can be accurate or less appropriate depending on the infrastructure.
If you hit some connection problems at some point â€“ like hostnames impossible to resolve for client applications - this <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/">blog post</a> should help you understand what is going on and fix the issues.</p>
</div>
</div>
<div class="sect4">
<h5 id="enabling-tls"><a class="anchor" href="#enabling-tls"></a>Enabling TLS</h5>
<div class="paragraph">
<p>TLS can be enabled by using the <code>rabbitmq-stream+tls</code> scheme in the URI.
The default TLS port is 5551.</p>
</div>
<div class="paragraph">
<p>Use the <code>EnvironmentBuilder#tls</code> method to configure TLS.
The most important setting is a <code>io.netty.handler.ssl.SslContext</code> instance,
which is created and configured with the
<code>io.netty.handler.ssl.SslContext#forClient</code> method. Note hostname verification
is enabled by default.</p>
</div>
<div class="paragraph">
<p>The following snippet shows a common configuration, whereby
the client is instructed to trust servers with certificates
signed by the configured certificate authority (CA).</p>
</div>
<div class="listingblock">
<div class="title">Creating an environment that uses TLS</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">X509Certificate</span> certificate;
<span class="keyword">try</span> (<span class="predefined-type">FileInputStream</span> inputStream =
            <span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/ca_certificate.pem</span><span class="delimiter">&quot;</span></span>)) {
    <span class="predefined-type">CertificateFactory</span> fact = <span class="predefined-type">CertificateFactory</span>.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">X.509</span><span class="delimiter">&quot;</span></span>);
    certificate = (<span class="predefined-type">X509Certificate</span>) fact.generateCertificate(inputStream); <i class="conum" data-value="1"></i><b>(1)</b>
}
SslContext sslContext = SslContextBuilder
    .forClient()
    .trustManager(certificate)  <i class="conum" data-value="2"></i><b>(2)</b>
    .build();

Environment environment = Environment.builder()
    .uri(<span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream+tls://guest:guest@localhost:5551/%2f</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="3"></i><b>(3)</b>
    .tls().sslContext(sslContext)  <i class="conum" data-value="4"></i><b>(4)</b>
    .environmentBuilder()
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Load certificate authority (CA) certificate from PEM file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure Netty <code>SslContext</code> to trust CA certificate</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use TLS scheme in environment URI</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set <code>SslContext</code> in environment configuration</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is sometimes handy to trust any server certificates
in development environments. <code>EnvironmentBuilder#tls</code> provides the
<code>trustEverything</code> method to do so. <strong>This should
not be used in a production environment</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Creating a TLS environment that trusts all server certificates for development</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Environment environment = Environment.builder()
    .uri(<span class="string"><span class="delimiter">&quot;</span><span class="content">rabbitmq-stream+tls://guest:guest@localhost:5551/%2f</span><span class="delimiter">&quot;</span></span>)
    .tls().trustEverything()  <i class="conum" data-value="1"></i><b>(1)</b>
    .environmentBuilder()
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Trust all server certificates</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="configuring-the-environment"><a class="anchor" href="#configuring-the-environment"></a>Configuring the Environment</h5>
<div class="paragraph">
<p>The following table sums up the main settings to create an <code>Environment</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uri</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URI of the node to connect to (single node).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rabbitmq-stream://guest:guest@localhost:5552/%2f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uris</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URI of the nodes to try to connect to (cluster).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rabbitmq-stream://guest:guest@localhost:5552/%2f</code> singleton list</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>host</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Host to connect to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>localhost</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port to use.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5552</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>username</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use to connect.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>guest</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use to connect.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>guest</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtualHost</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtual host to connect to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rpcTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout for RPC calls.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Duration.ofSeconds(10)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>recoveryBackOffDelayPolicy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delay policy to use for backoff on connection recovery.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed delay of 5 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topologyUpdateBackOffDelayPolicy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delay policy to use for backoff on topology update, e.g.
when a stream replica moves and a consumer needs to connect to another
node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initial delay of 5 seconds then delay of 1 second.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scheduledExecutorService</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executor used to schedule infrastructure tasks like background publishing, producers
and consumers migration after disconnection or topology update. If a custom executor is provided,
it is the developer&#8217;s responsibility to close it once it is no longer necessary.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Executors</span>
  .newScheduledThreadPool(
    <span class="predefined-type">Runtime</span>
      .getRuntime()
      .availableProcessors()
);</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxProducersByConnection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of <code>Producer</code> instances a single connection can maintain before
a new connection is open. The value must be between 1 and 255.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">255</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxTrackingConsumersByConnection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of <code>Consumer</code> instances that store their offset a single connection
can maintain before a new connection is open. The value must be between 1 and 255.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxConsumersByConnection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of <code>Consumer</code> instances a single connection can maintain before
a new connection is open. The value must be between 1 and 255.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">255</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lazyInitialization</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To delay the connection opening until necessary.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Informational ID for the environment instance.
Used as a prefix for connection names.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rabbitmq-stream</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>addressResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract to change resolved node address to connect to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass-through (no-op)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tls</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration helper for TLS.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TLS is enabled if a <code>rabbitmq-stream+tls</code> URI is provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tls#hostnameVerification</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable or disable hostname verification.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enabled by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tls#sslContext</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the <code>io.netty.handler.ssl.SslContext</code> used for the TLS connection.
Use <code>io.netty.handler.ssl.SslContextBuilder#forClient</code> to configure it.
The server certificate chain and the client private key are the typical
elements that need to be configured.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The JDK trust manager and no client private key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tls#trustEverything</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Helper to configure a <code>SslContext</code> that trusts all server certificates
and does not use a client private key. <strong>Only for development</strong>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disabled by default.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="when-a-load-balancer-is-in-use"><a class="anchor" href="#when-a-load-balancer-is-in-use"></a>When a Load Balancer is in Use</h5>
<div class="paragraph">
<p>A load balancer can misguide the client when it tries to connect to nodes that host stream leaders and replicas.
The <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/">"Connecting to Streams"</a> blog post covers why client applications must connect to the appropriate nodes in a cluster and how a <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/#with-a-load-balancer">load balancer can make things complicated</a> for them.</p>
</div>
<div class="paragraph">
<p>The <code>EnvironmentBuilder#addressResolver(AddressResolver)</code> method allows intercepting the node resolution after metadata hints and before connection.
Applications can use this hook to ignore metadata hints and always use the load balancer, as illustrated in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Using a custom address resolver to always use a load balancer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Address entryPoint = <span class="keyword">new</span> Address(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-load-balancer</span><span class="delimiter">&quot;</span></span>, <span class="integer">5552</span>);  <i class="conum" data-value="1"></i><b>(1)</b>
Environment environment = Environment.builder()
    .host(entryPoint.host())  <i class="conum" data-value="2"></i><b>(2)</b>
    .port(entryPoint.port())  <i class="conum" data-value="2"></i><b>(2)</b>
    .addressResolver(address -&gt; entryPoint)  <i class="conum" data-value="3"></i><b>(3)</b>
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the load balancer address</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use load balancer address for initial connection</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ignore metadata hints, always use load balancer</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The blog post covers the <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/#client-workaround-with-a-load-balancer">underlying details of this workaround</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="managing-streams"><a class="anchor" href="#managing-streams"></a>Managing Streams</h5>
<div class="paragraph">
<p>Streams are usually long-lived, centrally-managed entities, that is, applications
are not supposed to create and delete them. It is nevertheless possible to create and
delete stream with the <code>Environment</code>. This comes in handy for development and testing
purposes.</p>
</div>
<div class="paragraph">
<p>Streams are created with the <code>Environment#streamCreator()</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Creating a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.streamCreator().stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>).create();  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>my-stream</code> stream</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>StreamCreator#create</code> is idempotent: trying to re-create a stream with the same name
and same properties (e.g. maximum size, see below) will not throw an exception. In other words,
you can be sure the stream has been created once <code>StreamCreator#create</code> returns. Note it is
not possible to create a stream with the same name as an existing stream but with different
properties. Such a request will result in an exception.</p>
</div>
<div class="paragraph">
<p>Streams can be deleted with the <code>Environment#delete(String)</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Deleting a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.deleteStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>);  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Delete the <code>my-stream</code> stream</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note you should avoid stream churn (creating and deleting streams repetitively)
as their creation and deletion imply some significant housekeeping on
the server side (interactions with the file system, communication between nodes of the cluster).</p>
</div>
<div class="paragraph">
<p><a id="limiting-the-size-of-a-stream"></a>It is also possible to limit the size of a stream
when creating it. A stream
is an append-only data structure and reading from it does not remove data.
This means a stream can grow indefinitely. RabbitMQ Stream supports a
size-based and time-based retention policies: once the stream reaches a given size
or a given age, it is truncated (starting from the beginning).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Limit the size of streams if appropriate!</div>
<div class="paragraph">
<p>Make sure to set up a retention policy on potentially large streams
if you don&#8217;t want to saturate the storage devices of your servers. Keep
in mind that this means some data will be erased!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to set up the retention policy when creating the stream:</p>
</div>
<div class="listingblock">
<div class="title">Setting the retention policy when creating a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.streamCreator()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .maxLengthBytes(ByteCapacity.GB(<span class="integer">10</span>))  <i class="conum" data-value="1"></i><b>(1)</b>
        .maxSegmentSizeBytes(ByteCapacity.MB(<span class="integer">500</span>))  <i class="conum" data-value="2"></i><b>(2)</b>
        .create();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the maximum size to 10 GB</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the segment size to 500 MB</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous snippet mentions a segment size. RabbitMQ Stream does not store a stream
in a big, single file, it uses segment files for technical reasons.
A stream is truncated by deleting whole segment files (and not part of them)so
the maximum size of a stream is usually significantly higher than the size of
segment files. 500 MB is a reasonable segment file size to begin with.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">When does the broker enforce the retention policy?</div>
<div class="paragraph">
<p>The broker enforces the retention policy when the segments of a stream
roll over, that is when the current segment has reached its maximum
size and is closed in favor of a new one. This means the maximum segment
size is a critical setting in the retention mechanism.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>RabbitMQ Stream also supports a time-based retention policy: segments get truncated
when they reach a certain age. The following snippet
illustrates how to set the time-based retention policy:</p>
</div>
<div class="listingblock">
<div class="title">Setting a time-based retention policy when creating a stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">environment.streamCreator()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .maxAge(<span class="predefined-type">Duration</span>.ofHours(<span class="integer">6</span>))  <i class="conum" data-value="1"></i><b>(1)</b>
        .maxSegmentSizeBytes(ByteCapacity.MB(<span class="integer">500</span>))  <i class="conum" data-value="2"></i><b>(2)</b>
        .create();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the maximum age to 6 hours</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the segment size to 500 MB</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="producer"><a class="anchor" href="#producer"></a>Producer</h4>
<div class="sect4">
<h5 id="creating-a-producer"><a class="anchor" href="#creating-a-producer"></a>Creating a Producer</h5>
<div class="paragraph">
<p>A <code>Producer</code> instance is created from the <code>Environment</code>. The only mandatory
setting to specify is the stream to publish to:</p>
</div>
<div class="listingblock">
<div class="title">Creating a producer from the environment</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
        .build();  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="comment">// ...</span>
producer.close();  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>Environment#producerBuilder()</code> to define the producer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specify the stream to publish to</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the producer instance with <code>build()</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Close the producer after usage</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider a <code>Producer</code> instance like a long-lived object, do not create one
to send just one message.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Producer thread safety</div>
<div class="paragraph">
<p>Producer instances are thread-safe.
<a href="#outbound-message-deduplication">Deduplication</a> imposes <a href="#deduplication-multithreading">restrictions on the usage of threads</a> though.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Internally, the <code>Environment</code> will query the broker to find out about
the topology of the stream and will create or re-use a connection to
publish to the leader node of the stream.</p>
</div>
<div class="paragraph">
<p>The following table sums up the main settings to create a <code>Producer</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The stream to publish to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default, mandatory setting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The logical name of the producer. Specify a name to enable
<a href="#outbound-message-deduplication">message deduplication</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code> (no deduplication)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>batchSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of messages to accumulate before sending them to the broker.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>subEntrySize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="producer-sub-entry-size-configuration-entry"></a>The number of messages to put in a sub-entry.
A sub-entry is one "slot" in a publishing
frame, meaning outbound messages are not only batched in publishing frames, but in sub-entries
as well.
Use this feature to increase throughput at the cost of increased latency and
potential duplicated messages even when deduplication is enabled.
See the <a href="#sub-entry-batching-and-compression">dedicated section</a> for more information.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 (meaning no use of sub-entry batching)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>compression</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compression algorithm to use when sub-entry batching is in use.
See the <a href="#sub-entry-batching-and-compression">dedicated section</a> for more information.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compression.NONE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxUnconfirmedMessages</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of unconfirmed outbound messages. <code>Producer#send</code> will start
blocking when the limit is reached.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10,000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>batchPublishingDelay</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Period to send a batch of messages.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 ms</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>confirmTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="producer-confirm-timeout-configuration-entry"></a>Time before the client calls the confirm callback to signal
outstanding unconfirmed messages timed out.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enqueueTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time before enqueueing of a message fail when the maximum number of unconfirmed
is reached. The callback of the message will be called with a negative status.
Set the value to <code>Duration.ZERO</code> if there should be no timeout.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 seconds.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="sending-messages"><a class="anchor" href="#sending-messages"></a>Sending Messages</h5>
<div class="paragraph">
<p>Once a <code>Producer</code> has been created, it is possible to send a message with
the <code>Producer#send(Message, ConfirmationHandler)</code> method. The following
snippet shows how to publish a message with a byte array payload:</p>
</div>
<div class="listingblock">
<div class="title">Sending a message</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">byte</span><span class="type">[]</span> messagePayload = <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>.getBytes(StandardCharsets.UTF_8);  <i class="conum" data-value="1"></i><b>(1)</b>
producer.send(
        producer.messageBuilder().addData(messagePayload).build(),  <i class="conum" data-value="2"></i><b>(2)</b>
        confirmationStatus -&gt; {  <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="keyword">if</span> (confirmationStatus.isConfirmed()) {
                <span class="comment">// the message made it to the broker</span>
            } <span class="keyword">else</span> {
                <span class="comment">// the message did not make it to the broker</span>
            }
        });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The payload of a message is an array of bytes</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create the message with <code>Producer#messageBuilder()</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the behavior on publish confirmation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Messages are not only made of a <code>byte[]</code> payload, we will see in
<a href="#working-with-complex-messages">the next section</a>
they can also carry pre-defined and application properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Use a <code>MessageBuilder</code> instance only once</div>
<div class="paragraph">
<p>A <code>MessageBuilder</code> instance is meant to create only one message. You
need to create a new instance of <code>MessageBuilder</code> for every message
you want to create.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>ConfirmationHandler</code> defines an asynchronous callback invoked
when the client received from the broker the confirmation the message
has been taken into account. The <code>ConfirmationHandler</code> is the place
for any logic on publishing confirmation, including
re-publishing the message if it is negatively acknowledged.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Keep the confirmation callback as short as possible</div>
<div class="paragraph">
<p>The confirmation callback should be kept as short as possible
to avoid blocking the connection thread. Not doing so can
make the <code>Environment</code>, <code>Producer</code>, <code>Consumer</code> instances sluggish
or even block them. Any long processing should be done in
a separate thread (e.g. with an asynchronous <code>ExecutorService</code>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="working-with-complex-messages"><a class="anchor" href="#working-with-complex-messages"></a>Working with Complex Messages</h5>
<div class="paragraph">
<p>The publishing example above showed that messages are made of
a byte array payload, but it did not go much further. Messages in RabbitMQ Stream
can actually be more sophisticated, as they comply to the
<a href="https://www.amqp.org/resources/specifications">AMQP 1.0 message format</a>.</p>
</div>
<div class="paragraph">
<p>In a nutshell, a message in RabbitMQ Stream has the following structure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>properties: <em>a defined set of standard properties of the message</em> (e.g.
message ID, correlation ID, content type, etc).</p>
</li>
<li>
<p>application properties: a set of arbitrary key/value pairs.</p>
</li>
<li>
<p>body: typically an array of bytes.</p>
</li>
<li>
<p>message annotations: a set of key/value pairs (aimed at the infrastructure).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The RabbitMQ Stream Java client uses the <code>Message</code> interface to abstract
a message and the recommended way to create <code>Message</code> instances is to
use the <code>Producer#messageBuilder()</code> method. To publish a <code>Message</code>, use
the <code>Producer#send(Message,ConfirmationHandler)</code>:</p>
</div>
<div class="listingblock">
<div class="title">Creating a message with properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Message message = producer.messageBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .properties()  <i class="conum" data-value="2"></i><b>(2)</b>
            .messageId(<span class="predefined-type">UUID</span>.randomUUID())
            .correlationId(<span class="predefined-type">UUID</span>.randomUUID())
            .contentType(<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>)
        .messageBuilder()  <i class="conum" data-value="3"></i><b>(3)</b>
            .addData(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>.getBytes(StandardCharsets.UTF_8))  <i class="conum" data-value="4"></i><b>(4)</b>
        .build();  <i class="conum" data-value="5"></i><b>(5)</b>
producer.send(message, confirmationStatus -&gt; { }); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the message builder from the producer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the properties builder and set some properties</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Go back to message builder</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set byte array payload</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Build the message instance</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Publish the message</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Is RabbitMQ Stream based on AMQP 1.0?</div>
<div class="paragraph">
<p>AMQP 1.0 is a standard that defines <em>an efficient binary peer-to-peer
protocol for transporting messages between two processes over a network</em>.
It also defines <em>an abstract message format, with concrete standard encoding</em>.
This is only the latter part that RabbitMQ Stream uses. The AMQP 1.0 protocol is not used,
only AMQP 1.0 encoded messages are wrapped into the RabbitMQ Stream binary protocol.</p>
</div>
<div class="paragraph">
<p>The actual AMQP 1.0 message encoding and decoding happen on the client side, the
RabbitMQ Stream plugin stores only bytes, it has no idea that AMQP 1.0 message format
is used.</p>
</div>
<div class="paragraph">
<p>AMQP 1.0 message format was chosen because of its flexibility and its advanced
type system. It provides good interoperability, which allows streams
to be accessed as AMQP 0-9-1 queues, without data loss.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="outbound-message-deduplication"><a class="anchor" href="#outbound-message-deduplication"></a>Message Deduplication</h5>
<div class="paragraph">
<p>RabbitMQ Stream provides publisher confirms to avoid losing messages: once
the broker has persisted a message it sends a confirmation for this message.
But this can lead to duplicate messages: imagine the connection closes
because of a network glitch after the message has been persisted but <em>before</em>
the confirmation reaches the producer. Once reconnected, the producer will
retry to send the same message, as it never received the confirmation. So the
message will be persisted twice.</p>
</div>
<div class="paragraph">
<p>Luckily RabbitMQ Stream can detect and filter out duplicated messages, based
on 2 client-side elements: the <em>producer name</em> and the <em>message publishing ID</em>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Deduplication is not guaranteed when using sub-entries batching</div>
<div class="paragraph">
<p>It is not possible to guarantee deduplication when
<a href="#sub-entry-batching-and-compression">sub-entry batching</a> is in use.
Sub-entry batching is disabled by default and it does not prevent from
batching messages in a single publish frame, which can already provide
very high throughput.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="deduplication-multithreading" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Deduplication is not guaranteed when publishing on several threads</div>
<div class="paragraph">
<p>We&#8217;ll see below that deduplication works using a strictly increasing sequence for messages.
This means messages must be published in order and the preferred way to do this is usually <em>within a single thread</em>.
Even if messages are <em>created</em> in order, with the proper sequence ID, if they are published in several threads, they can get out of order, e.g. message 5 can be <em>published</em> before message 2.
The deduplication mechanism will then filter out message 2 in this case.</p>
</div>
<div class="paragraph">
<p>So you have to be very careful about the way your applications publish messages when deduplication is in use.
If you worry about performance, note it is possible to publish hundreds of thousands of messages in a single thread with RabbitMQ Stream.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="setting-the-name-of-a-producer"><a class="anchor" href="#setting-the-name-of-a-producer"></a>Setting the Name of a Producer</h6>
<div class="paragraph">
<p>The producer name is set when creating the producer instance, which automatically
enables deduplication:</p>
</div>
<div class="listingblock">
<div class="title">Naming a producer to enable message deduplication</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-app-producer</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .confirmTimeout(<span class="predefined-type">Duration</span>.ZERO)  <i class="conum" data-value="2"></i><b>(2)</b>
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set a name for the producer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Disable confirm timeout check</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Thanks to the name, the broker will be able to track the messages it has persisted
on a given stream for this producer. If the producer connection unexpectedly closes, it
will automatically recover and retry outstanding messages. The broker will then
filter out messages it has already received and persisted. No more duplicates!</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Why setting <code>confirmTimeout</code> to 0 when using deduplication?</div>
<div class="paragraph">
<p>The point of deduplication is to avoid duplicates when retrying unconfirmed messages.
But why retrying in the first place? To avoid <em>losing</em> messages, that is enforcing
<em>at-least-once</em> semantics. If the client does not stubbornly retry messages and gives
up at some point, messages can be lost, which maps to <em>at-most-once</em> semantics. This
is why the deduplication examples set the
<a href="#producer-confirm-timeout-configuration-entry"><code>confirmTimeout</code> setting</a> to <code>Duration.ZERO</code>:
to disable the background task that calls the confirmation callback for outstanding
messages that time out. This way the client will do its best to retry messages
until they are confirmed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider the producer name a logical name. It should not be a random sequence that
changes when the producer application is restarted. Names like <code>online-shop-order</code> or
<code>online-shop-invoice</code> are better names than <code>3d235e79-047a-46a6-8c80-9d159d3e1b05</code>.
There should be only one living instance of a producer with a given name on a given
stream at the same time.</p>
</div>
</div>
<div class="sect5">
<h6 id="understanding-publishing-id"><a class="anchor" href="#understanding-publishing-id"></a>Understanding Publishing ID</h6>
<div class="paragraph">
<p>The producer name is only one part of the deduplication mechanism, the other part
is the <em>message publishing ID</em>. If the producer has a name, the client automatically
assigns a publishing ID to each outbound message for the producer. The publishing ID
is a strictly increasing sequence, starting at 0 and incremented for each message. The default
publishing sequence is good enough for deduplication, but it is possible to
assign a publishing ID to each message:</p>
</div>
<div class="listingblock">
<div class="title">Using an explicit publishing ID</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Message message = producer.messageBuilder()
    .publishingId(<span class="integer">1</span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .addData(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>.getBytes(StandardCharsets.UTF_8))
    .build();
producer.send(message, confirmationStatus -&gt; { });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set a publishing ID on a message</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are a few rules to follow when using a custom publishing ID sequence:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the sequence should start at 0</p>
</li>
<li>
<p>the sequence must be strictly increasing</p>
</li>
<li>
<p>there can be gaps in the sequence (e.g. 0, 1, 2, 3, 6, 7, 9, 10, etc)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A custom publishing ID sequence has usually a meaning: it can be the line number of a file
or the primary key in a database.</p>
</div>
<div class="paragraph">
<p>Note the publishing ID is not part of the message: it is not stored with the message
and so is not available when consuming the message. It is still possible to store
the value in the AMQP 1.0 message application properties or in an appropriate
properties (e.g. <code>messageId</code>).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Do not mix client-assigned and custom publishing ID</div>
<div class="paragraph">
<p>As soon as a producer name is set, message deduplication is enabled.
It is then possible to let the producer assign a publishing ID to each
message or assign custom publishing IDs. <strong>Do one or the other, not both!</strong></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="restarting-a-producer-where-it-left-off"><a class="anchor" href="#restarting-a-producer-where-it-left-off"></a>Restarting a Producer Where It Left Off</h6>
<div class="paragraph">
<p>Using a custom publishing sequence is even more useful to restart a producer where it left
off. Imagine a scenario whereby the producer is sending a message for each line in a file and
the application uses the line number as the publishing ID. If the application restarts
because of some necessary maintenance or even a crash, the producer can restart
from the beginning of the file: there would no duplicate messages because the producer
has a name and the application sets publishing IDs appropriately. Nevertheless,
this is far from ideal, it would be much better to restart just after the last line
the broker successfully confirmed. Fortunately this is possible thanks to
the <code>Producer#getLastPublishing()</code> method, which returns the last publishing ID for a given
producer. As the publishing ID in this case is the line number, the application can
easily scroll to the next line and restart publishing from there.</p>
</div>
<div class="paragraph">
<p>The next snippet illustrates the use of <code>Producer#getLastPublishing()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Setting a producer where it left off</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-app-producer</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .confirmTimeout(<span class="predefined-type">Duration</span>.ZERO)  <i class="conum" data-value="2"></i><b>(2)</b>
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .build();
<span class="type">long</span> nextPublishingId = producer.getLastPublishingId() + <span class="integer">1</span>;  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="keyword">while</span> (moreContent(nextPublishingId)) {
    <span class="type">byte</span><span class="type">[]</span> content = getContent(nextPublishingId); <i class="conum" data-value="4"></i><b>(4)</b>
    Message message = producer.messageBuilder()
        .publishingId(nextPublishingId) <i class="conum" data-value="5"></i><b>(5)</b>
        .addData(content)
        .build();
    producer.send(message, confirmationStatus -&gt; {});
    nextPublishingId++;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set a name for the producer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Disable confirm timeout check</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Query last publishing ID for this producer and increment it</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Scroll to the content for the next publishing ID</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the message publishing</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sub-entry-batching-and-compression"><a class="anchor" href="#sub-entry-batching-and-compression"></a>Sub-Entry Batching and Compression</h5>
<div class="paragraph">
<p>RabbitMQ Stream provides a special mode to publish, store, and dispatch messages: sub-entry batching.
This mode increases throughput at the cost of increased latency and potential duplicated messages even when deduplication is enabled.
It also allows using compression to reduce bandwidth and storage if messages are reasonably similar, at the cost of increasing CPU usage on the client side.</p>
</div>
<div class="paragraph">
<p>Sub-entry batching consists in squeezing several messages â€“ a batch â€“ in the slot that is usually used for one message.
This means outbound messages are not only batched in publishing frames, but in sub-entries as well.</p>
</div>
<div class="paragraph">
<p>You can enable sub-entry batching by setting the <code>ProducerBuilder#subEntrySize</code> parameter to a value greater than 1, like in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Enabling sub-entry batching</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .batchSize(<span class="integer">100</span>) <i class="conum" data-value="1"></i><b>(1)</b>
    .subEntrySize(<span class="integer">10</span>) <i class="conum" data-value="2"></i><b>(2)</b>
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set batch size to 100 (the default)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set sub-entry size to 10</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Reasonable values for the sub-entry size usually go from 10 to a few dozens.</p>
</div>
<div class="paragraph">
<p>A sub-entry batch will go directly to disc after it reached the broker, so the publishing client has complete control over it.
This is the occasion to take advantage of the similarity of messages and compress them.
There is no compression by default but you can choose among several algorithms with the <code>ProducerBuilder#compression(Compression)</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Enabling compression of sub-entry messages</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .batchSize(<span class="integer">100</span>) <i class="conum" data-value="1"></i><b>(1)</b>
    .subEntrySize(<span class="integer">10</span>) <i class="conum" data-value="2"></i><b>(2)</b>
    .compression(<span class="predefined-type">Compression</span>.ZSTD) <i class="conum" data-value="3"></i><b>(3)</b>
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set batch size to 100 (the default)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set sub-entry size to 10</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the Zstandard compression algorithm</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the messages in a sub-entry are compressed altogether to benefit from their potential similarity, not one by one.</p>
</div>
<div class="paragraph">
<p>The following table lists the supported algorithms, general information about them, and the respective implementations used by default.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Algorithm</th>
<th class="tableblock halign-left valign-top">Overview</th>
<th class="tableblock halign-left valign-top">Implementation used</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.wikipedia.org/wiki/Gzip">gzip</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Has a high compression ratio but is slow compared to other algorithms.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDK implementation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.wikipedia.org/wiki/Snappy_(compression)">Snappy</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aims for reasonable compression ratio and very high speeds.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/xerial/snappy-java">Xerial Snappy</a> (framed)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.wikipedia.org/wiki/LZ4_(compression_algorithm)">LZ4</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aims for good trade-off between speed and compression ratio.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/lz4/lz4-java">LZ4 Java</a> (framed)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.wikipedia.org/wiki/Zstd">zstd</a> (Zstandard)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aims for high compression ratio and high speed, especially for decompression.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/luben/zstd-jni">zstd-jni</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You are encouraged to test and evaluate the compression algorithms depending on your needs.</p>
</div>
<div class="paragraph">
<p>The compression libraries are pluggable thanks to the <code>EnvironmentBuilder#compressionCodecFactory(CompressionCodecFactory)</code> method.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Consumers, sub-entry batching, and compression</div>
<div class="paragraph">
<p>There is no configuration required for consumers with regard to sub-entry batching and compression.
The broker dispatches messages to client libraries: they are supposed to figure out the format of messages, extract them from their sub-entry, and decompress them if necessary.
So when you set up sub-entry batching and compression in your publishers, the consuming applications must use client libraries that support this mode, which is the case for the stream Java client.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="consumer"><a class="anchor" href="#consumer"></a>Consumer</h4>
<div class="paragraph">
<p><code>Consumer</code> is the API to consume messages from a stream.</p>
</div>
<div class="sect4">
<h5 id="creating-a-consumer"><a class="anchor" href="#creating-a-consumer"></a>Creating a Consumer</h5>
<div class="paragraph">
<p>A <code>Consumer</code> instance is created with <code>Environment#consumerBuilder()</code>. The main
settings are the stream to consume from, the place in the stream to start
consuming from (the <em>offset</em>), and a callback when a message is received
(the <code>MessageHandler</code>). The next snippet shows how to create a <code>Consumer</code>:</p>
</div>
<div class="listingblock">
<div class="title">Creating a consumer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()  <i class="conum" data-value="1"></i><b>(1)</b>
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
        .offset(OffsetSpecification.first())  <i class="conum" data-value="3"></i><b>(3)</b>
        .messageHandler((offset, message) -&gt; {
            message.getBodyAsBinary(); <i class="conum" data-value="4"></i><b>(4)</b>
        })
        .build();  <i class="conum" data-value="5"></i><b>(5)</b>
<span class="comment">// ...</span>
consumer.close();  <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>Environment#consumerBuilder()</code> to define the consumer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specify the stream to consume from</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify where to start consuming from</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define behavior on message consumption</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Build the consumer</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Close consumer after usage</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The broker start sending messages as soon as the <code>Consumer</code> instance is created.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Keep the message processing callback as short as possible</div>
<div class="paragraph">
<p>The message processing callback should be kept as short as possible
to avoid blocking the connection thread. Not doing so can
make the <code>Environment</code>, <code>Producer</code>, <code>Consumer</code> instances sluggish
or even block them. Any long processing should be done in
a separate thread (e.g. with an asynchronous <code>ExecutorService</code>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following table sums up the main settings to create a <code>Consumer</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The stream to consume from.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default, mandatory setting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>offset</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The offset to start consuming from.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OffsetSpecification#next()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messageHandler</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The callback for inbound messages.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default, mandatory setting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The consumer name (for <a href="#consumer-offset-tracking">offset tracking</a>.)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code> (no offset tracking)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AutoTrackingStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable and configure the <a href="#consumer-automatic-offset-tracking">auto-tracking strategy</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the default tracking strategy if a consumer <code>name</code> is provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AutoTrackingStrategy#messageCountBeforeStorage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of messages before storing.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10,000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AutoTrackingStrategy#flushInterval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval to check and store the last received offset in case of inactivity.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Duration.ofSeconds(5)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ManualTrackingStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable and configure the <a href="#consumer-manual-offset-tracking">manual tracking strategy</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disabled by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ManualTrackingStrategy#checkInterval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval to check if the last requested stored offset has been actually stored.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Duration.ofSeconds(5)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">subscriptionListener</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <a href="#consumer-subscription-listener">callback</a> before the subscription is created.
Useful when using an external store for offset tracking.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Why is my consumer not consuming?</div>
<div class="paragraph">
<p>A consumer starts consuming at the very end of a stream by default (<code>next</code> offset).
This means the consumer will receive messages as soon as a producer publishes to the stream.
<em>This also means that if no producers are currently publishing to the stream, the
consumer will stay idle, waiting for new messages to come in</em>. Use the
<code>ConsumerBuilder#offset(OffsetSpecification)</code> to change the default behavior and
see the <a href="#specifying-an-offset">offset section</a> to find out more about the different
types of offset specification.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="specifying-an-offset"><a class="anchor" href="#specifying-an-offset"></a>Specifying an Offset</h5>
<div class="paragraph">
<p>The offset is the place in the stream where the consumer starts consuming from.
The possible values for the offset parameter are the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>OffsetSpecification.first()</code>: starting from the first available offset. If
the stream has not been <a href="#limiting-the-size-of-a-stream">truncated</a>, this
means the beginning of the stream (offset 0).</p>
</li>
<li>
<p><code>OffsetSpecification.last()</code>: starting from the end of the stream and returning
the last <a href="#chunk-definition">chunk</a> of messages immediately (if the stream is not empty).</p>
</li>
<li>
<p><code>OffsetSpecification.next()</code>: starting from the next offset to be written. Contrary
to <code>OffsetSpecification.last()</code>, consuming with <code>OffsetSpecification.next()</code>
will not return anything if no-one is publishing to the stream. The broker will start
sending messages to the consumer when messages are published to the stream.</p>
</li>
<li>
<p><code>OffsetSpecification.offset(offset)</code>: starting from the specified offset. 0 means consuming
from the beginning of the stream (first messages). The client
can also specify any number, for example the offset where it left off
in a previous incarnation of the application.</p>
</li>
<li>
<p><code>OffsetSpecification.timestamp(timestamp)</code>: starting from the messages stored
after the specified timestamp.</p>
</li>
</ul>
</div>
<div id="chunk-definition" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">What is a chunk of messages?</div>
<div class="paragraph">
<p>A chunk is simply a batch of messages. This is the storage and transportation
unit used in RabbitMQ Stream, that is messages are stored contiguously in a chunk
and they are delivered as part of a chunk. A chunk can be made of one to several
thousands of messages, depending on the ingress.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following figure shows the different offset specifications in a stream
made of 2 chunks:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="data:image/png;base64,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" alt="Diagram" width="840" height="168">
</div>
<div class="title">Figure 1. Offset specifications in a stream made of 2 chunks</div>
</div>
</div>
<div class="sect4">
<h5 id="consumer-offset-tracking"><a class="anchor" href="#consumer-offset-tracking"></a>Tracking the Offset for a Consumer</h5>
<div class="paragraph">
<p>A consumer can track the offset it has reached in a stream. This allows a new incarnation
of the consumer to restart consuming where it left off. Offset tracking works in 2 steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the consumer must have a <strong>name</strong>. The name is set with <code>ConsumerBuilder#name(String)</code>. The name
can be any value (under 256 characters) and is expected to be unique (from the application
point of view). Note neither the client library, nor the broker
enforces uniqueness of the name: if 2 <code>Consumer</code> Java instances share the same name, their
offset tracking will likely be interleaved, which applications usually do not expect.</p>
</li>
<li>
<p>the consumer must periodically <strong>store the offset</strong> it has reached so far. The way
offsets are stored depends on the tracking strategy: automatic or manual.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Whatever tracking strategy you use, <strong>a consumer must have a name to be able to store offsets</strong>.</p>
</div>
<div class="sect5">
<h6 id="consumer-automatic-offset-tracking"><a class="anchor" href="#consumer-automatic-offset-tracking"></a>Automatic Offset Tracking</h6>
<div class="paragraph">
<p>The following snippet shows how to enable automatic tracking with the defaults:</p>
</div>
<div class="listingblock">
<div class="title">Using automatic tracking strategy with the defaults</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .autoTrackingStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use automatic tracking strategy with defaults</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The automatic tracking strategy has the following available settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>message count before storage</strong>: the client will store the offset
after the specified number of messages, right after the execution
of the message handler. <em>The default is every 10,000 messages</em>.</p>
</li>
<li>
<p><strong>flush interval</strong>: the client will make sure to store the last received offset
at the specified interval. This avoids having pending, not stored offsets in
case of inactivity. <em>The default is 5 seconds</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those settings are configurable, as shown in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Configuring the automatic tracking strategy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .autoTrackingStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
            .messageCountBeforeStorage(<span class="integer">50</span>_000)   <i class="conum" data-value="3"></i><b>(3)</b>
            .flushInterval(<span class="predefined-type">Duration</span>.ofSeconds(<span class="integer">10</span>))   <i class="conum" data-value="4"></i><b>(4)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use automatic tracking strategy</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Store every 50,000 messages</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Make sure to store offset at least every 10 seconds</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the automatic tracking is the default tracking strategy, so if you are fine
with its defaults, it is enabled as soon as you specify a name
for the consumer:</p>
</div>
<div class="listingblock">
<div class="title">Setting only the consumer name to enable automatic tracking</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set only the consumer name to enable automatic tracking with defaults</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Automatic tracking is simple and provides good guarantees. It is nevertheless
possible to have more fine-grained control over offset tracking by using
manual tracking.</p>
</div>
</div>
<div class="sect5">
<h6 id="consumer-manual-offset-tracking"><a class="anchor" href="#consumer-manual-offset-tracking"></a>Manual Offset Tracking</h6>
<div class="paragraph">
<p>The manual tracking strategy lets the developer in charge of storing offsets
whenever they want, not only after a given number of messages has been received
and supposedly processed, like automatic tracking does.</p>
</div>
<div class="paragraph">
<p>The following snippet shows how to enable manual tracking and how to store
the offset at some point:</p>
</div>
<div class="listingblock">
<div class="title">Using manual tracking with defaults</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .manualTrackingStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>

          <span class="keyword">if</span> (conditionToStore()) {
            context.storeOffset();   <i class="conum" data-value="3"></i><b>(3)</b>
          }
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use manual tracking with defaults</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Store at the current offset on some condition</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Manual tracking has only one setting: the <strong>check interval</strong>. The client checks
that the last requested stored offset has been actually stored at the
specified interval. <em>The default check interval is 5 seconds</em>.</p>
</div>
<div class="paragraph">
<p>The following snippet shows the configuration of manual tracking:</p>
</div>
<div class="listingblock">
<div class="title">Configuring manual tracking strategy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer =
    environment.consumerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">application-1</span><span class="delimiter">&quot;</span></span>)   <i class="conum" data-value="1"></i><b>(1)</b>
        .manualTrackingStrategy()   <i class="conum" data-value="2"></i><b>(2)</b>
            .checkInterval(<span class="predefined-type">Duration</span>.ofSeconds(<span class="integer">10</span>))   <i class="conum" data-value="3"></i><b>(3)</b>
        .builder()
        .messageHandler((context, message) -&gt; {
          <span class="comment">// message handling code...</span>

          <span class="keyword">if</span> (conditionToStore()) {
            context.storeOffset();   <i class="conum" data-value="4"></i><b>(4)</b>
          }
        })
        .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer name (mandatory for offset tracking)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use manual tracking with defaults</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Check last requested offset every 10 seconds</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Store the current offset on some condition</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The snippet above uses <code>MessageHandler.Context#storeOffset()</code> to store at the
offset of the current message, but it is possible to store anywhere
in the stream with <code>MessageHandler.Context#consumer()#store(long)</code> or
simply <code>Consumer#store(long)</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="considerations-on-offset-tracking"><a class="anchor" href="#considerations-on-offset-tracking"></a>Considerations On Offset Tracking</h6>
<div class="paragraph">
<p><em>When to store offsets?</em> Avoid storing offsets too often or, worse, for each message.
Even though offset tracking is a small and fast operation, it will
make the stream grow unnecessarily, as the broker persists offset
tracking entries in the stream itself.</p>
</div>
<div class="paragraph">
<p>A good rule of thumb is to store the offset every few thousands
of messages. Of course, when the consumer will restart consuming in a new incarnation, the
last tracked offset may be a little behind the very last message the previous incarnation
actually processed, so the consumer may see some messages that have been already processed.</p>
</div>
<div class="paragraph">
<p>A solution to this problem is to make sure processing is idempotent or filter out the
last duplicated messages.</p>
</div>
<hr>
<div class="paragraph">
<p><em>Is the offset a reliable absolute value?</em> Message offsets may not be contiguous.
This implies that the message at offset 500 in a stream may
not be the 501 message in the stream (offsets start at 0).
There can be different types of entries in a stream storage, a message is
just one of them. For example, storing an offset creates an offset tracking
entry, which has its own offset.</p>
</div>
<div class="paragraph">
<p>This means one must be careful when basing some decision on offset values, like
a modulo to perform an operation every X messages. As the message offsets have
no guarantee to be contiguous, the operation may not happen exactly every X messages.</p>
</div>
</div>
<div class="sect5">
<h6 id="consumer-subscription-listener"><a class="anchor" href="#consumer-subscription-listener"></a>Subscription Listener</h6>
<div class="paragraph">
<p>The client provides a <code>SubscriptionListener</code> interface callback to add behavior before a subscription is created.
This callback can be used to customize the offset the client library computed for the subscription.
The callback is called when the consumer is first created and when the client has to re-subscribe (e.g. after a disconnection or a topology change).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Experimental</div>
<div class="paragraph">
<p>This API is experimental, it is subject to change.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to use the callback to get the last processed offset from an external store, that is not using the server-side offset tracking feature RabbitMQ Stream provides.
The following code snippet shows how this can be done (note the interaction with the external store is not detailed):</p>
</div>
<div class="listingblock">
<div class="title">Using an external store for offset tracking with a subscription listener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-stream</span><span class="delimiter">&quot;</span></span>)
    .subscriptionListener(subscriptionContext -&gt; {  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="type">long</span> offset = getOffsetFromExternalStore();  <i class="conum" data-value="2"></i><b>(2)</b>
        subscriptionContext.offsetSpecification(OffsetSpecification.offset(offset + <span class="integer">1</span>));  <i class="conum" data-value="3"></i><b>(3)</b>
    })
    .messageHandler((context, message) -&gt; {
        <span class="comment">// message handling code...</span>

        storeOffsetInExternalStore(context.offset());  <i class="conum" data-value="4"></i><b>(4)</b>
    })
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set subscription listener</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get offset from external store</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set offset to use for the subscription</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Store the offset in the external store after processing</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When using an external store for offset tracking, it is no longer necessary to set a name and an offset strategy, as these only apply when server-side offset tracking is in use.</p>
</div>
<div class="paragraph">
<p>Using a subscription listener can also be useful to have more accurate offset tracking on re-subscription, at the cost of making the application code slightly more complex.
This requires a good understanding on how and when subscription occurs in the client, and so when the subscription listener is called:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for a consumer with no name (server-side offset tracking <em>disabled</em>)</p>
<div class="ulist">
<ul>
<li>
<p>on the first subscription (when the consumer is created): the offset specification is the one specified with <code>ConsumerBuilder#offset(OffsetSpecification)</code>, the default being <code>OffsetSpecification#next()</code></p>
</li>
<li>
<p>on re-subscription (after a disconnection or topology change): the offset specification is the offset of the last dispatched message</p>
</li>
</ul>
</div>
</li>
<li>
<p>for a consumer with a name (server-side offset tracking <em>enabled</em>)</p>
<div class="ulist">
<ul>
<li>
<p>on the first subscription (when the consumer is created): the server-side stored offset (if any) overrides the value specified with <code>ConsumerBuilder#offset(OffsetSpecification)</code></p>
</li>
<li>
<p>on re-subscription (after a disconnection or topology change): the server-side stored offset is used</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The subscription listener comes in handy on re-subscription.
The application can track the last processed offset in-memory, with an <code>AtomicLong</code> for example.
The application knows exactly when a message is processed and updates its in-memory tracking accordingly, whereas the value computed by the client may not be perfectly appropriate on re-subscription.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take the example of a named consumer with an offset tracking strategy that is lagging because of bad timing and a long flush interval.
When a glitch happens and triggers the re-subscription, the server-side stored offset can be quite behind what the application actually processed.
Using this server-side stored offset can lead to duplicates, whereas using the in-memory, application-specific offset tracking variable is more accurate.
A custom <code>SubscriptionListener</code> lets the application developer uses what&#8217;s best for the application if the computed value is not optimal.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="super-streams"><a class="anchor" href="#super-streams"></a>Super Streams (Partitioned Streams)</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Experimental</div>
<div class="paragraph">
<p>Super streams are an experimental feature, they are subject to change.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A super stream is a logical stream made of several individual streams.
In essence, a super stream is a partitioned stream that brings scalability compared to a single stream.</p>
</div>
<div class="paragraph">
<p>The stream Java client uses the same programming model for super streams as with individual streams, that is the <code>Producer</code>, <code>Consumer</code>, <code>Message</code>, etc API are still valid when super streams are in use.
Application code should not be impacted whether it uses individual or super streams.</p>
</div>
<div class="sect4">
<h5 id="topology"><a class="anchor" href="#topology"></a>Topology</h5>
<div class="paragraph">
<p>A super stream is made of several individual streams, so it can be considered a logical entity rather than an actual physical entity.
The topology of a super stream is based on the <a href="https://www.rabbitmq.com/tutorials/amqp-concepts.html">AMQP 0.9.1 model</a>, that is exchange, queues, and bindings between them.
This does not mean AMQP resources are used to transport or store stream messages, it means that they are used to <em>describe</em> the super stream topology, that is the streams it is made of.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take the example of an <code>invoices</code> super stream made of 3 streams (i.e. partitions):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an <code>invoices</code> exchange represents the super stream</p>
</li>
<li>
<p>the <code>invoices-0</code>, <code>invoices-1</code>, <code>invoices-2</code> streams are the partitions of the super stream (streams are also AMQP queues in RabbitMQ)</p>
</li>
<li>
<p>3 bindings between the exchange and the streams link the super stream to its partitions and represent <em>routing rules</em></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="data:image/png;base64,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" alt="Diagram" width="400" height="210">
</div>
<div class="title">Figure 2. The topology of a super stream is defined with bindings between an exchange and queues</div>
</div>
<div class="paragraph">
<p>When a super stream is in use, the stream Java client queries this information to find out about the partitions of a super stream and the routing rules.
From the application code point of view, using a super stream is mostly configuration-based.
Some logic must also be provided to extract routing information from messages.</p>
</div>
</div>
<div class="sect4">
<h5 id="publishing-to-a-super-stream"><a class="anchor" href="#publishing-to-a-super-stream"></a>Publishing to a Super Stream</h5>
<div class="paragraph">
<p>When the topology of a super stream like the one described above has been set, creating a producer for it is straightforward:</p>
</div>
<div class="listingblock">
<div class="title">Creating a Producer for a Super Stream</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
        .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
        .routing(message -&gt; message.getProperties().getMessageIdAsString()) <i class="conum" data-value="2"></i><b>(2)</b>
        .producerBuilder()
        .build();  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="comment">// ...</span>
producer.close();  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the super stream name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Provide the logic to get the routing key from a message</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the producer instance</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Close the producer when it&#8217;s no longer necessary</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that even though the <code>invoices</code> super stream is not an actual stream, its name must be used to declare the producer.
Internally the client will figure out the streams that compose the super stream.
The application code must provide the logic to extract a routing key from a message as a <code>Function&lt;Message, String&gt;</code>.
The client will hash the routing key to determine the stream to send the message to (using partition list and a modulo operation).</p>
</div>
<div class="paragraph">
<p>The client uses 32-bit <a href="https://en.wikipedia.org/wiki/MurmurHash">MurmurHash3</a> by default to hash the routing key.
This hash function provides good uniformity, performance, and portability, making it a good default choice, but it is possible to specify a custom hash function:</p>
</div>
<div class="listingblock">
<div class="title">Specifying a custom hash function</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)
    .routing(message -&gt; message.getProperties().getMessageIdAsString())
    .hash(rk -&gt; rk.hashCode())  <i class="conum" data-value="1"></i><b>(1)</b>
    .producerBuilder()
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>String#hashCode()</code> to hash the routing key</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note using Java&#8217;s <code>hashCode()</code> method is a debatable choice as potential producers in other languages are unlikely to implement it, making the routing different between producers in different languages.</p>
</div>
<div class="sect5">
<h6 id="resolving-routes-with-bindings"><a class="anchor" href="#resolving-routes-with-bindings"></a>Resolving Routes with Bindings</h6>
<div class="paragraph">
<p>Hashing the routing key to pick a partition is only one way to route messages to the appropriate streams.
The stream Java client provides another way to resolve streams, based on the routing key <em>and</em> the bindings between the super stream exchange and the streams.</p>
</div>
<div class="paragraph">
<p>This routing strategy makes sense when the partitioning has a business meaning, e.g. with a partition for a region in the world, like in the diagram below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="data:image/png;base64,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" alt="Diagram" width="440" height="210">
</div>
<div class="title">Figure 3. A super stream with a partition for a region in a world</div>
</div>
<div class="paragraph">
<p>In such a case, the routing key will be a property of the message that represents the region:</p>
</div>
<div class="listingblock">
<div class="title">Enabling the "key" routing strategy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Producer producer = environment.producerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)
    .routing(msg -&gt; msg.getApplicationProperties().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">region</span><span class="delimiter">&quot;</span></span>).toString())  <i class="conum" data-value="1"></i><b>(1)</b>
    .key()  <i class="conum" data-value="2"></i><b>(2)</b>
    .producerBuilder()
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Extract the routing key</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable the "key" routing strategy</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Internally the client will query the broker to resolve the destination streams for a given routing key, making the routing logic from any exchange type available to streams.
Note the client caches results, it does not query the broker for every message.</p>
</div>
</div>
<div class="sect5">
<h6 id="using-a-custom-routing-strategy"><a class="anchor" href="#using-a-custom-routing-strategy"></a>Using a Custom Routing Strategy</h6>
<div class="paragraph">
<p>The solution that provides the most control over routing is using a custom routing strategy.
This should be needed only for specific cases.</p>
</div>
<div class="paragraph">
<p>Here is an excerpt of the <code>RoutingStrategy</code> interface:</p>
</div>
<div class="listingblock">
<div class="title">The routing strategy interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RoutingStrategy</span> {

  <span class="comment">/** Where to route a message. */</span>
  <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; route(Message message, Metadata metadata);

  <span class="comment">/** Metadata on the super stream. */</span>
  <span class="type">interface</span> <span class="class">Metadata</span> {

    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; partitions();

    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; route(<span class="predefined-type">String</span> routingKey);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note it is possible to route a message to several streams or even nowhere.
The "hash" routing strategy always routes to 1 stream and the "key" routing strategy can route to several streams.</p>
</div>
<div class="paragraph">
<p>The following code sample shows how to implement a simplistic round-robin <code>RoutingStrategy</code> and use it in the producer.
Note this implementation should not be used in production as the modulo operation is not sign-safe for simplicity&#8217;s sake.</p>
</div>
<div class="listingblock">
<div class="title">Setting a round-robin routing strategy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">AtomicLong</span> messageCount = <span class="keyword">new</span> <span class="predefined-type">AtomicLong</span>(<span class="integer">0</span>);
RoutingStrategy routingStrategy = (message, metadata) -&gt; {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; partitions = metadata.partitions();
    <span class="predefined-type">String</span> stream = partitions.get(
        (<span class="type">int</span>) messageCount.getAndIncrement() % partitions.size()
    );
    <span class="keyword">return</span> <span class="predefined-type">Collections</span>.singletonList(stream);
};
Producer producer = environment.producerBuilder()
    .stream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)
    .routing(<span class="predefined-constant">null</span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .strategy(routingStrategy)  <i class="conum" data-value="2"></i><b>(2)</b>
    .producerBuilder()
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>No need to set the routing key extraction logic</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the custom routing strategy</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="deduplication"><a class="anchor" href="#deduplication"></a>Deduplication</h6>
<div class="paragraph">
<p>Deduplication for a super stream producer works the same way as with a <a href="#outbound-message-deduplication">single stream producer</a>.
The publishing ID values are spread across the streams but this does affect the mechanism.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="consuming-from-a-super-stream"><a class="anchor" href="#consuming-from-a-super-stream"></a>Consuming From a Super Stream</h5>
<div class="paragraph">
<p>A super stream consumer is not much different from a single stream consumer.
The <code>ConsumerBuilder#superStream(String)</code> must be used to set the super stream to consume from:</p>
</div>
<div class="listingblock">
<div class="title">Declaring a super stream consumer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Consumer consumer = environment.consumerBuilder()
    .superStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoices</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    .messageHandler((context, message) -&gt; {
        <span class="comment">// message processing</span>
    })
    .build();
<span class="comment">// ...</span>
consumer.close();  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the super stream name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Close the consumer when it is no longer necessary</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A super stream consumer is a composite consumer: it will look up the super stream partitions and create a consumer for each or them.</p>
</div>
<div class="sect5">
<h6 id="offset-tracking"><a class="anchor" href="#offset-tracking"></a>Offset Tracking</h6>
<div class="paragraph">
<p>The semantic of offset tracking for a super stream consumer are roughly the same as for an individual stream consumer.
There are still some subtle differences, so a good understanding of <a href="#consumer-offset-tracking">offset tracking</a> in general and of the <a href="#consumer-automatic-offset-tracking">automatic</a> and <a href="#consumer-manual-offset-tracking">manual</a> offset tracking strategies is recommended.</p>
</div>
<div class="paragraph">
<p>Here are the main differences for the automatic/manual offset tracking strategies between single and super stream consuming:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>automatic offset tracking</strong>: internally, <em>the client divides the <code>messageCountBeforeStorage</code> setting by the number of partitions for each individual consumer</em>.
Imagine a 3-partition super stream, <code>messageCountBeforeStorage</code> set to 10,000, and 10,000 messages coming in, perfectly balanced across the partitions (that is about 3,333 messages for each partition).
In this case, the automatic offset tracking strategy will not kick in, because the expected count message has not been reached on any partition.
Making the client divide <code>messageCountBeforeStorage</code> by the number of partitions can be considered "more accurate" if the message are well balanced across the partitions.
A good rule of thumb is to then multiply the expected per-stream <code>messageCountBeforeStorage</code> by the number of partitions, to avoid storing offsets too often. So the default being 10,000, it can be set to 30,000 for a 3-partition super stream.</p>
</li>
<li>
<p><strong>manual offset tracking</strong>: the <code>MessageHandler.Context#storeOffset()</code> method must be used, the <code>Consumer#store(long)</code> will fail, because an offset value has a meaning only in one stream, not in other streams.
A call to <code>MessageHandler.Context#storeOffset()</code> will store the current message offset in <em>its</em> stream, but also the offset of the last dispatched message for the other streams of the super stream.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="building-the-client"><a class="anchor" href="#building-the-client"></a>Building the Client</h3>
<div class="paragraph">
<p>You need JDK 1.8 or more installed.</p>
</div>
<div class="paragraph">
<p>To build the JAR file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./mvnw clean package -DskipITs -DskipTests</pre>
</div>
</div>
<div class="paragraph">
<p>To launch the test suite (requires a local RabbitMQ node with stream plugin enabled):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./mvnw verify -Drabbitmqctl.bin=/path/to/rabbitmqctl</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-performance-tool"><a class="anchor" href="#the-performance-tool"></a>The Performance Tool</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The library contains also a performance tool to test the RabbitMQ Stream plugin.
It is usable as an uber JAR
<a href="https://github.com/rabbitmq/rabbitmq-stream-java-client/releases">downloadable from GitHub Release</a> or as a <a href="https://hub.docker.com/r/pivotalrabbitmq/stream-perf-test">Docker image</a>.
It can be built separately as well.</p>
</div>
<div class="paragraph">
<p>Snapshots are on <a href="https://github.com/rabbitmq/rabbitmq-java-tools-binaries-dev/releases">GitHub release</a> as well. Use the <code>pivotalrabbitmq/stream-perf-test:dev</code> image to use the latest snapshot in Docker.</p>
</div>
<div class="sect2">
<h3 id="using-the-performance-tool"><a class="anchor" href="#using-the-performance-tool"></a>Using the Performance Tool</h3>
<div class="sect3">
<h4 id="with-docker-2"><a class="anchor" href="#with-docker-2"></a>With Docker</h4>
<div class="paragraph">
<p>The performance tool is available as a
<a href="https://hub.docker.com/r/pivotalrabbitmq/stream-perf-test">Docker image</a>.
You can use the Docker image to list the available options:</p>
</div>
<div class="listingblock">
<div class="title">Listing the available options of the performance tool</div>
<div class="content">
<pre>docker run -it --rm pivotalrabbitmq/stream-perf-test --help</pre>
</div>
</div>
<div class="paragraph">
<p>There are all sorts of options, if none is provided,
the tool will start publishing to and consuming from a stream created
only for the test.</p>
</div>
<div class="paragraph">
<p>When using Docker, the container running the performance tool must be able to
connect to the broker, so you have to figure out the appropriate Docker
configuration to make this possible.
You can have a look at the <a href="https://docs.docker.com/network/">Docker network documentation</a>
to find out more.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Docker on macOS</div>
<div class="paragraph">
<p>Docker runs on a virtual machine when using macOS, so do not expect high performance
when using RabbitMQ Stream and the performance tool inside Docker on a Mac.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We show next a couple of options to easily use the Docker image.</p>
</div>
<div class="sect4">
<h5 id="with-docker-host-network-driver-2"><a class="anchor" href="#with-docker-host-network-driver-2"></a>With Docker Host Network Driver</h5>
<div class="paragraph">
<p>This is the simplest way to run the image locally, with a local broker running in Docker as well.
The containers use the <a href="https://docs.docker.com/network/host/">host network</a>,
this is perfect for experimenting locally.</p>
</div>
<div class="listingblock">
<div class="title">Running the broker and performance tool with the host network driver</div>
<div class="content">
<pre># run the broker
docker run -it --rm --name rabbitmq --network host rabbitmq:3.10
# open another terminal and enable the stream plugin
docker exec rabbitmq rabbitmq-plugins enable rabbitmq_stream
# run the performance tool
docker run -it --rm --network host pivotalrabbitmq/stream-perf-test</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Docker Host Network Driver Support</div>
<div class="paragraph">
<p>According to Docker&#8217;s documentation, the host networking driver <strong>only works on Linux hosts</strong>.
Nevertheless, the commands above work on some Mac hosts.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="with-docker-bridge-network-driver-2"><a class="anchor" href="#with-docker-bridge-network-driver-2"></a>With Docker Bridge Network Driver</h5>
<div class="paragraph">
<p>Containers need to be able to communicate with each other with
the <a href="https://docs.docker.com/network/bridge/">bridge network driver</a>, this
can be done by defining a network and running the containers in this network.</p>
</div>
<div class="listingblock">
<div class="title">Running the broker and performance tool with the bridge network driver</div>
<div class="content">
<pre># create a network
docker network create stream-perf-test
# run the broker
docker run -it --rm --network stream-perf-test --name rabbitmq rabbitmq:3.10
# open another terminal and enable the stream plugin
docker exec rabbitmq rabbitmq-plugins enable rabbitmq_stream
# run the performance tool
docker run -it --rm --network stream-perf-test pivotalrabbitmq/stream-perf-test \
    --uris rabbitmq-stream://rabbitmq:5552</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="with-the-java-binary"><a class="anchor" href="#with-the-java-binary"></a>With the Java Binary</h4>
<div class="paragraph">
<p>The Java binary is available on
<a href="https://github.com/rabbitmq/rabbitmq-stream-java-client/releases">GitHub Release</a>.
<a href="https://github.com/rabbitmq/rabbitmq-java-tools-binaries-dev/releases">Snaphots</a> are available as well. To use the latest snapshot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>wget https://github.com/rabbitmq/rabbitmq-java-tools-binaries-dev/releases/download/v-stream-perf-test-latest/stream-perf-test-latest.jar</pre>
</div>
</div>
<div class="paragraph">
<p>To launch a run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ java -jar stream-perf-test-latest.jar
17:51:26.207 [main] INFO  c.r.stream.perf.StreamPerfTest - Starting producer
1, published 560277 msg/s, confirmed 554088 msg/s, consumed 556983 msg/s, latency min/median/75th/95th/99th 2663/9799/13940/52304/57995 Âµs, chunk size 1125
2, published 770722 msg/s, confirmed 768209 msg/s, consumed 768585 msg/s, latency min/median/75th/95th/99th 2454/9599/12206/23940/55519 Âµs, chunk size 1755
3, published 915895 msg/s, confirmed 914079 msg/s, consumed 916103 msg/s, latency min/median/75th/95th/99th 2338/8820/11311/16750/52985 Âµs, chunk size 2121
4, published 1004257 msg/s, confirmed 1003307 msg/s, consumed 1004981 msg/s, latency min/median/75th/95th/99th 2131/8322/10639/14368/45094 Âµs, chunk size 2228
5, published 1061380 msg/s, confirmed 1060131 msg/s, consumed 1061610 msg/s, latency min/median/75th/95th/99th 2131/8247/10420/13905/37202 Âµs, chunk size 2379
6, published 1096345 msg/s, confirmed 1095947 msg/s, consumed 1097447 msg/s, latency min/median/75th/95th/99th 2131/8225/10334/13722/33109 Âµs, chunk size 2454
7, published 1127791 msg/s, confirmed 1127032 msg/s, consumed 1128039 msg/s, latency min/median/75th/95th/99th 1966/8150/10172/13500/23940 Âµs, chunk size 2513
8, published 1148846 msg/s, confirmed 1148086 msg/s, consumed 1149121 msg/s, latency min/median/75th/95th/99th 1966/8079/10135/13248/16771 Âµs, chunk size 2558
9, published 1167067 msg/s, confirmed 1166369 msg/s, consumed 1167311 msg/s, latency min/median/75th/95th/99th 1966/8063/9986/12977/16757 Âµs, chunk size 2631
10, published 1182554 msg/s, confirmed 1181938 msg/s, consumed 1182804 msg/s, latency min/median/75th/95th/99th 1966/7963/9949/12632/16619 Âµs, chunk size 2664
11, published 1197069 msg/s, confirmed 1196495 msg/s, consumed 1197291 msg/s, latency min/median/75th/95th/99th 1966/7917/9955/12503/15386 Âµs, chunk size 2761
12, published 1206687 msg/s, confirmed 1206176 msg/s, consumed 1206917 msg/s, latency min/median/75th/95th/99th 1966/7893/9975/12503/15280 Âµs, chunk size 2771
...
^C
Summary: published 1279444 msg/s, confirmed 1279019 msg/s, consumed 1279019 msg/s, latency 95th 12161 Âµs, chunk size 2910</pre>
</div>
</div>
<div class="paragraph">
<p>The previous command will start publishing to and consuming from a <code>stream</code> stream that
will be created. The tool outputs live metrics on the console and write more
detailed metrics in a <code>stream-perf-test-current.txt</code> file that get renamed to
<code>stream-perf-test-yyyy-MM-dd-HHmmss.txt</code> when the run ends.</p>
</div>
<div class="paragraph">
<p>To see the options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test-latest.jar --help</pre>
</div>
</div>
<div class="paragraph">
<p>The performance tool comes also with a
<a href="https://github.com/rabbitmq/rabbitmq-java-tools-binaries-dev/releases/download/v-stream-perf-test-latest/stream-perf-test-latest_completion">completion script</a>.
You can download it and enable it in
your <code>~/.zshrc</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>alias stream-perf-test='java -jar target/stream-perf-test.jar'
source ~/.zsh/stream-perf-test_completion</pre>
</div>
</div>
<div class="paragraph">
<p>Note the activation requires an alias which must be <code>stream-perf-test</code>. The command can be anything
though.</p>
</div>
</div>
<div class="sect3">
<h4 id="common-usage"><a class="anchor" href="#common-usage"></a>Common Usage</h4>
<div class="sect4">
<h5 id="connection"><a class="anchor" href="#connection"></a>Connection</h5>
<div class="paragraph">
<p>The performance tool connects by default to localhost, on port 5552, with
default credentials (<code>guest</code>/<code>guest</code>), on the default <code>/</code> virtual host.
This can be changed with the <code>--uris</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --uris rabbitmq-stream://rabbitmq-1:5552</pre>
</div>
</div>
<div class="paragraph">
<p>The URI follows the same rules as the
<a href="https://www.rabbitmq.com/uri-spec.html">AMQP 0.9.1 URI</a>,
except the protocol must be <code>rabbitmq-stream</code>.
The next command shows how to set up the different elements of the URI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar \
  --uris rabbitmq-stream://guest:guest@localhost:5552/%2f</pre>
</div>
</div>
<div class="paragraph">
<p>The option accepts several values, separated by commas. By doing so, the tool
will be able to pick another URI for its "locator" connection, in case a node
crashes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar \
  --uris rabbitmq-stream://rabbitmq-1:5552,rabbitmq-stream://rabbitmq-2:5552</pre>
</div>
</div>
<div class="paragraph">
<p>Note the tool uses those URIs only for management purposes, it does not use them
to distribute publishers and consumers across a cluster.</p>
</div>
<div class="paragraph">
<p>It is also possible to enable <a href="#enabling-tls">TLS</a> by using the <code>rabbitmq-stream+tls</code> scheme:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar \
  --uris rabbitmq-stream+tls://guest:guest@localhost:5551/%2f</pre>
</div>
</div>
<div class="paragraph">
<p>Note the performance tool will automatically configure the client to trust all
server certificates and to not use a private key (for client authentication).</p>
</div>
<div class="paragraph">
<p>Have a look at the <a href="#understanding-connection-logic">connection logic section</a> in case of connection problem.</p>
</div>
</div>
<div class="sect4">
<h5 id="publishing-rate"><a class="anchor" href="#publishing-rate"></a>Publishing Rate</h5>
<div class="paragraph">
<p>It is possible to limit the publishing rate with the <code>--rate</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --rate 10000</pre>
</div>
</div>
<div class="paragraph">
<p>RabbitMQ Stream can easily saturate the resources of the hardware, it can especially
max out the storage IO. Reasoning when a system is under severe constraints can
be difficult, so setting a low publishing rate can be a good idea to get familiar
with the performance tool and the semantics of streams.</p>
</div>
</div>
<div class="sect4">
<h5 id="number-of-producers-and-consumers"><a class="anchor" href="#number-of-producers-and-consumers"></a>Number of Producers and Consumers</h5>
<div class="paragraph">
<p>You can set the number of producers and consumers with the <code>--producers</code> and
<code>--consumers</code> options, respectively:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 5 --consumers 5</pre>
</div>
</div>
<div class="paragraph">
<p>With the previous command, you should see a higher consuming rate than
publishing rate. It is because the 5 producers publish as fast as they can
and each consumer consume the messages from the 5 publishers. In theory
the consumer rate should be 5 times the publishing rate, but as stated previously,
the performance tool may put the broker under severe constraints, so the numbers
may not add up.</p>
</div>
<div class="paragraph">
<p>You can set a low publishing rate to verify this theory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 5 --consumers 5 --rate 10000</pre>
</div>
</div>
<div class="paragraph">
<p>With the previous command, each publisher should publish 10,000 messages per second,
that is 50,000 messages per second overall. As each consumer consumes each published messages,
the consuming rate should be 5 times the publishing rate, that is 250,000 messages per
second. Using a small publishing rate should let plenty of resources to the system,
so the rates should tend towards those values.</p>
</div>
</div>
<div class="sect4">
<h5 id="streams"><a class="anchor" href="#streams"></a>Streams</h5>
<div class="paragraph">
<p>The performance tool uses a <code>stream</code> stream by default, the <code>--streams</code> option allows
specifying streams that the tool will try to create. Note producer
and consumer counts must be set accordingly, as they are not spread across the
stream automatically. The following command will run a test with 3 streams, with
a producer and a consumer on each of them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --streams stream1,stream2,stream3 \
                               --producers 3 --consumers 3</pre>
</div>
</div>
<div class="paragraph">
<p>The stream creation process has the following semantics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the tool always tries to create streams.</p>
</li>
<li>
<p>if the target streams already exist and have the exact same properties
as the ones the tool uses (see <a href="#performance-tool-retention">retention</a> below), the
run will start normally as stream creation is idempotent.</p>
</li>
<li>
<p>if the target streams already exist but do not have the exact same properties
as the ones the tool uses, the run will start normally as well, the tool will output a warning.</p>
</li>
<li>
<p>for any other errors during creation, the run will stop.</p>
</li>
<li>
<p>the streams are not deleted after the run.</p>
</li>
<li>
<p>if you want the tool to delete the streams after a run, use the <code>--delete-streams</code> flag.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Specifying streams one by one can become tedious as their number grows, so the <code>--stream-count</code>
option can be combined with the <code>--streams</code> option to specify a number or a range and a stream name
pattern, respectively. The following table shows the usage of these 2 options and the resulting
exercised streams. Do not forget to also specify the appropriate number of producers and
consumers if you want all the declared streams to be used.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Options</th>
<th class="tableblock halign-left valign-top">Computed Streams</th>
<th class="tableblock halign-left valign-top">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 5 --streams stream</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-1,stream-2,stream-3,stream-4,stream-5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stream count starts at 1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 5 --streams stream-%d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-1,stream-2,stream-3,stream-4,stream-5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possible to specify a <a href="https://docs.oracle.com/javase/7/docs/api/java/util/Formatter.html">Java printf-style format string</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 10 --streams stream-%d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-1,stream-2,stream-3,&#8230;&#8203;, stream-10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not bad, but not correctly sorted alphabetically.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 10 --streams stream-%02d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-01,stream-02,stream-03,&#8230;&#8203;, stream-10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Better for sorting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 10 --streams stream</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-01,stream-02,stream-03,&#8230;&#8203;, stream-10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default format string handles the sorting issue.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 50-500 --streams stream-%03d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-050,stream-051,stream-052,&#8230;&#8203;, stream-500</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ranges are accepted.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 50-500</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-050,stream-051,stream-052,&#8230;&#8203;, stream-500</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default format string.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="publishing-batch-size"><a class="anchor" href="#publishing-batch-size"></a>Publishing Batch Size</h5>
<div class="paragraph">
<p>The default publishing batch size is 100, that is a publishing frame is sent every 100 messages.
The following command sets the batch size to 50 with the <code>--batch-size</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --batch-size 50</pre>
</div>
</div>
<div class="paragraph">
<p>There is no ideal batch size, it is a tradeoff between throughput and latency.
High batch size values should increase throughput (usually good) and latency (usually not so
good), whereas low batch size should decrease throughput (usually not good) and latency (usually
good).</p>
</div>
</div>
<div class="sect4">
<h5 id="unconfirmed-messages"><a class="anchor" href="#unconfirmed-messages"></a>Unconfirmed Messages</h5>
<div class="paragraph">
<p>A publisher can have at most 10,000 unconfirmed messages at some point. If it reaches this value,
it has to wait until the broker confirms some messages. This avoids fast publishers overwhelming
the broker. The <code>--confirms</code> option allows changing the default value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --confirms 20000</pre>
</div>
</div>
<div class="paragraph">
<p>High values should increase throughput at the cost of consuming more memory, whereas low values
should decrease throughput and memory consumption.</p>
</div>
</div>
<div class="sect4">
<h5 id="message-size"><a class="anchor" href="#message-size"></a>Message Size</h5>
<div class="paragraph">
<p>The default size of a message is 10 bytes, which is rather small. The <code>--size</code> option lets you
specify a different size, usually higher, to have a value close to your use case. The next command
sets a size of 1 KB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --size 1024</pre>
</div>
</div>
<div class="paragraph">
<p>Note the message body size cannot be smaller that 8 bytes, as the performance tool stores
a long in each message to calculate the latency. Note also the actual size of a message will be
slightly higher, as the body is wrapped in an <a href="#working-with-complex-messages">AMQP 1.0 message</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="connection-pooling"><a class="anchor" href="#connection-pooling"></a>Connection Pooling</h5>
<div class="paragraph">
<p>The performance tool does not use connection pooling by default: each producer and consumer has its own connection.
This can be appropriate to reach maximum throughput in performance test runs, as producers and consumers do not share connections.
But it may not always reflect what applications do, as they may have slow producers and not-so-busy consumers, so sharing connections becomes interesting to save some resources.</p>
</div>
<div class="paragraph">
<p>It is possible to configure connection pooling with the <code>--producers-by-connection</code> and <code>--consumers-by-connection</code> options.
They accept a value between 1 and 255, the default being 1 (no connection pooling).</p>
</div>
<div class="paragraph">
<p>In the following example we use 10 streams with 1 producer and 1 consumer on each of them.
As the rate is low, we can re-use connections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 10 --consumers 10 --stream-count 10 \
                               --rate 1000 \
                               --producers-by-connection 50 --consumers-by-connection 50</pre>
</div>
</div>
<div class="paragraph">
<p>We end up using 2 connections for the producers and consumers with connection pooling, instead of 20.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="advanced-usage"><a class="anchor" href="#advanced-usage"></a>Advanced Usage</h4>
<div class="sect4">
<h5 id="performance-tool-retention"><a class="anchor" href="#performance-tool-retention"></a>Retention</h5>
<div class="paragraph">
<p>If you run performance tests for a long time, you might be interested in setting
a <a href="#limiting-the-size-of-a-stream">retention strategy</a> for
the streams the performance tool creates for a run. This
would typically avoid saturating the storage devices of your servers.
The default values are 20 GB for the maximum size of a stream and
500 MB for each segment files that composes a stream. You can change
these values with the <code>--max-length-bytes</code> and <code>--stream-max-segment-size-bytes</code> options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --max-length-bytes 10gb \
                               --stream-max-segment-size-bytes 250mb</pre>
</div>
</div>
<div class="paragraph">
<p>Both options accept units (<code>kb</code>, <code>mb</code>, <code>gb</code>, <code>tb</code>), as well as no unit to
specify a number of bytes.</p>
</div>
<div class="paragraph">
<p>It is also possible to use the time-based retention strategy with the <code>--max-age</code> option.
This can be less predictable than <code>--max-length-bytes</code> in the context of performance tests though.
The following command shows how to set the maximum age of segments to 5 minutes with
a maximum segment size of 250 MB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --max-age PT5M \
                               --stream-max-segment-size-bytes 250mb</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--max-age</code> option uses the
<a href="https://en.wikipedia.org/wiki/ISO_8601#Durations">ISO 8601 duration format</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="offset-consumer"><a class="anchor" href="#offset-consumer"></a>Offset (Consumer)</h5>
<div class="paragraph">
<p>Consumers start by default at the very end of a stream (offset <code>next</code>).
It is possible to specify an <a href="#specifying-an-offset">offset</a>
to start from with the <code>--offset</code> option,
if you have existing streams, and you want to consume from them at a specific offset.
The following command sets the consumer to start consuming at the beginning of
a stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --offset first</pre>
</div>
</div>
<div class="paragraph">
<p>The accepted values for <code>--offset</code> are <code>first</code>, <code>last</code>, <code>next</code> (the default),
an unsigned long for a given offset, and an ISO 8601 formatted timestamp
(eg. <code>2020-06-03T07:45:54Z</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="offset-tracking-consumer"><a class="anchor" href="#offset-tracking-consumer"></a>Offset Tracking (Consumer)</h5>
<div class="paragraph">
<p>A consumer can <a href="#consumer-offset-tracking">track the point</a> it has reached
in a stream to be able to restart where it left off in a new incarnation.
The performance tool has the <code>--store-every</code> option to tell consumers to store
the offset every <code>x</code> messages to be able to measure the impact of offset tracking
in terms of throughput and storage. This feature is disabled by default.
The following command shows how to store the offset every 100,000 messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --store-every 100000</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="consumer-names"><a class="anchor" href="#consumer-names"></a>Consumer Names</h5>
<div class="paragraph">
<p>When using <code>--store-every</code> (see above) for <a href="#consumer-offset-tracking">offset tracking</a>,
the performance tool uses a default name using the pattern <code>{stream-name}-{consumer-number}</code>.
So the default name of a single tracking consumer consuming from <code>stream</code> will be <code>stream-1</code>.</p>
</div>
<div class="paragraph">
<p>The consumer names pattern can be set with the <code>--consumer-names</code> option, which uses
the <a href="https://docs.oracle.com/javase/7/docs/api/java/util/Formatter.html">Java printf-style format string</a>.
The stream name and the consumer number are injected as arguments, in this order.</p>
</div>
<div class="paragraph">
<p>The following table illustrates some examples for the <code>--consumer-names</code> option
for a <code>s1</code> stream and a second consumer:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Computed Name</th>
<th class="tableblock halign-left valign-top">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%s-%d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>s1-2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default pattern.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-%s-consumer-%d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-s1-consumer-2</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>consumer-%2$d-on-stream-%1$s</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>consumer-2-on-stream-s1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The argument indexes (<code>1$</code> for the stream, <code>2$</code> for the consumer number) must be used
as the pattern uses the consumer number first, which is not the pre-defined order of arguments.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uuid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7cc75659-ea67-4874-96ef-151a505e1a55</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.oracle.com/javase/7/docs/api/java/util/UUID.html#randomUUID()">Random UUID</a> that
changes for every run.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note you can use <code>--consumer-names uuid</code> to change the consumer names for every run. This
can be useful when you want to use tracking consumers in different runs but you want to
force the offset they start consuming from. With consumer names that do not change between runs,
tracking consumers would ignore the specified offset and would start where they left off
(this is the purpose of offset tracking).</p>
</div>
</div>
<div class="sect4">
<h5 id="producer-names"><a class="anchor" href="#producer-names"></a>Producer Names</h5>
<div class="paragraph">
<p>You can use the <code>--producer-names</code> option to set the producer names pattern and therefore
enable <a href="#outbound-message-deduplication">message deduplication</a> (using the default
publishing sequence starting at 0 and incremented for each message).
The same naming options apply as above in <a href="#consumer-names">consumer names</a> with the only
difference that the default pattern is empty (i.e. no deduplication).</p>
</div>
<div class="paragraph">
<p>Here is an example of the usage of the <code>--producer-names</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producer-names %s-%d</pre>
</div>
</div>
<div class="paragraph">
<p>The run will start one producer and will use the <code>stream-1</code> producer reference (default stream is <code>stream</code> and the number of the producer is 1.)</p>
</div>
</div>
<div class="sect4">
<h5 id="load-balancer-in-front-of-the-cluster"><a class="anchor" href="#load-balancer-in-front-of-the-cluster"></a>Load Balancer in Front of the Cluster</h5>
<div class="paragraph">
<p>A load balancer can misguide the performance tool when it tries to connect to nodes that host stream leaders and replicas.
The <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/">"Connecting to Streams"</a> blog post covers why client applications must connect to the appropriate nodes in a cluster.</p>
</div>
<div class="paragraph">
<p>Use the <code>--load-balancer</code> flag to make sure the performance tool always goes through the load balancer that sits in front of your cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --uris rabbitmq-stream://my-load-balancer:5552 \
                               --load-balancer</pre>
</div>
</div>
<div class="paragraph">
<p>The same blog post covers why a <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/#with-a-load-balancer">load balancer can make things more complicated</a> for client applications like the performance tool and how <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/#client-workaround-with-a-load-balancer">they can mitigate these issues</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="monitoring"><a class="anchor" href="#monitoring"></a>Monitoring</h5>
<div class="paragraph">
<p>The tool can expose some runtime information on HTTP.
The default port is 8080.
The following options are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--monitoring</code>: add a <code>threaddump</code> endpoint to display a thread dump of the process.
This can be useful to inspect threads if the tool seems blocked.</p>
</li>
<li>
<p><code>--prometheus</code>: add a <code>metrics</code> endpoint to expose metrics using the Prometheus format.
The endpoint can then be declared in a Prometheus instance to scrape the metrics.</p>
</li>
<li>
<p><code>--monitoring-port</code>: set the port to use for the web server.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="using-environment-variables-as-options"><a class="anchor" href="#using-environment-variables-as-options"></a>Using Environment Variables as Options</h5>
<div class="paragraph">
<p>Environment variables can sometimes be easier to work with than command line options.
This is especially true when using a manifest file for configuration (with Docker Compose or Kubernetes) and the number of options used grows.</p>
</div>
<div class="paragraph">
<p>The performance tool automatically uses environment variables that match the snake case version of its long options.
E.g. it automatically picks up the value of the <code>BATCH_SIZE</code> environment variable for the <code>--batch-size</code> option, but only if the environment variable is defined.</p>
</div>
<div class="paragraph">
<p>You can list the environment variables that the tool picks up with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --environment-variables</pre>
</div>
</div>
<div class="paragraph">
<p>The short version of the option is <code>-env</code>.</p>
</div>
<div class="paragraph">
<p>To avoid collisions with environment variables that already exist, it is possible to specify a prefix for the environment variables that the tool looks up.
This prefix is defined with the <code>RABBITMQ_STREAM_PERF_TEST_ENV_PREFIX</code> environment variable, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RABBITMQ_STREAM_PERF_TEST_ENV_PREFIX="STREAM_PERF_TEST_"</pre>
</div>
</div>
<div class="paragraph">
<p>With <code>RABBITMQ_STREAM_PERF_TEST_ENV_PREFIX="STREAM_PERF_TEST_"</code> defined, the tool looks for the <code>STREAM_PERF_TEST_BATCH_SIZE</code> environment variable, not <code>BATCH_SIZE</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="logging"><a class="anchor" href="#logging"></a>Logging</h5>
<div class="paragraph">
<p>The performance tool binary uses Logback with an internal configuration file.
The default log level is <code>warn</code> with a console appender.</p>
</div>
<div class="paragraph">
<p>It is possible to define loggers directly from the command line, this is useful for quick debugging.
Use the <code>rabbitmq.streamperftest.loggers</code> system property with <code>name=level</code> pairs, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -Drabbitmq.streamperftest.loggers=com.rabbitmq.stream=debug -jar stream-perf-test.jar</pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to define several loggers by separating them with commas, e.g. <code>-Drabbitmq.streamperftest.loggers=com.rabbitmq.stream=debug,com.rabbitmq.stream.perf=info</code>.</p>
</div>
<div class="paragraph">
<p>It is also possible to use an environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>export RABBITMQ_STREAM_PERF_TEST_LOGGERS=com.rabbitmq.stream=debug</pre>
</div>
</div>
<div class="paragraph">
<p>The system property takes precedence over the environment variable.</p>
</div>
<div class="paragraph">
<p>Use the environment variable with the Docker image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker run -it --rm --network host \
    --env RABBITMQ_STREAM_PERF_TEST_LOGGERS=com.rabbitmq.stream=debug \
    pivotalrabbitmq/stream-perf-test</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="building-the-performance-tool"><a class="anchor" href="#building-the-performance-tool"></a>Building the Performance Tool</h3>
<div class="paragraph">
<p>To build the uber JAR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./mvnw clean package -Dmaven.test.skip -P performance-tool</pre>
</div>
</div>
<div class="paragraph">
<p>Then run the tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar target/stream-perf-test.jar</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.6.0-SNAPSHOT<br>
Last updated 2022-07-25 06:23:46 UTC
</div>
</div>
</body>
</html>